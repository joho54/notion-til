# [CS] CSAPP - 2

> ê°œë…ê³¼ ì´ìŠˆ íŠ¸ë˜í‚¹ì„ ì¡°í•©í•´ì„œ â€œë³µê¸° ê°€ëŠ¥í•œâ€ ìë£Œë¥¼ ë§Œë“¤ë„ë¡ í•©ë‹ˆë‹¤.

# Program Encoding

## 1. C code file

```bash
root@a0fd357a556d:/test# cat mstore.c
long mult2(long, long);

void multstore(long x, long y, long *dest) {
	long t = mult2(x, y);
	*dest = t;
}
```

## 2. Generate assembly code

gcc command generates mstore.s 

![](./images/Screenshot_2025-04-03_at_5.41.12_PM.png)

generated asm file.

CSAPPì˜ ì˜ˆì œì™€ ë§¤ìš° ë‹¤ë¥´ë‹¤! ë§¥ë¶ì˜ ë„ì»¤ ìš°ë¶„íˆ¬ ì„œë²„ì—ì„œ ì‹¤í–‰í–ˆê¸° ë•Œë¬¸ì¸ê°€?

```python
	.arch armv8-a
	.file	"mstore.c"
	.text
	.align	2
	.global	multstore
	.type	multstore, %function
multstore:
.LFB0:
	.cfi_startproc
	stp	x29, x30, [sp, -32]!
	.cfi_def_cfa_offset 32
	.cfi_offset 29, -32
	.cfi_offset 30, -24
	mov	x29, sp
	str	x19, [sp, 16]
	.cfi_offset 19, -16
	mov	x19, x2
	bl	mult2
	str	x0, [x19]
	ldr	x19, [sp, 16]
	ldp	x29, x30, [sp], 32
	.cfi_restore 30
	.cfi_restore 29
	.cfi_restore 19
	.cfi_def_cfa_offset 0
	ret
	.cfi_endproc
.LFE0:
	.size	multstore, .-multstore
	.ident	"GCC: (Ubuntu 13.3.0-6ubuntu2~24.04) 13.3.0"
	.section	.note.GNU-stack,"",@progbits
```

ë„¤, CS:APP (Computer Systems: A Programmerâ€™s Perspective) ì±…ì—ì„œ ë‚˜ì˜¤ëŠ” ì–´ì…ˆë¸”ë¦¬ ì½”ë“œ ì˜ˆì œì™€

ì§€ê¸ˆ ë„ì»¤ ìš°ë¶„íˆ¬ì—ì„œ ìƒì„±í•œ ì–´ì…ˆë¸”ë¦¬ ì½”ë“œê°€ ë‹¤ë¥´ê²Œ ë³´ì´ëŠ” ì´ìœ ëŠ”,

ë‹¹ì‹ ì˜ ë„ì»¤ ìš°ë¶„íˆ¬ê°€ ARM ê¸°ë°˜ì´ê¸° ë•Œë¬¸ì…ë‹ˆë‹¤. ì •í™•íˆëŠ” ARM64 (AArch64, armv8-a) ì•„í‚¤í…ì²˜ë¡œ ì»´íŒŒì¼ë˜ê³  ìˆì–´ìš”.

âœ… ì°¨ì´ì˜ ì›ì¸ ì •ë¦¬

ì¦‰, CSAPPëŠ” x86-64ìš© ì–´ì…ˆë¸”ë¦¬ë¥¼ ë‹¤ë£¨ëŠ” ë°˜ë©´,

ë‹¹ì‹ ì˜ ì»´íŒŒì¼ í™˜ê²½ì€ ARM64 ê¸°ë°˜ì´ê¸° ë•Œë¬¸ì— ê²°ê³¼ë¬¼ì´ ì „í˜€ ë‹¤ë¥¸ í˜•íƒœì¸ ê±°ì˜ˆìš”.

âœ… í™•ì¸ í¬ì¸íŠ¸: ì–´ì…ˆë¸”ë¦¬ ì²« ì¤„

```plain text
.arch armv8-a
```

â†’ ì´ê±´ ëª…ë°±íˆ ARM ì•„í‚¤í…ì²˜ìš© ì½”ë“œì„ì„ ë³´ì—¬ì£¼ì£ .

x0, x19, x29 ê°™ì€ ë ˆì§€ìŠ¤í„° ëª…ë„ ARM ì „ìš©ì…ë‹ˆë‹¤.

(x86 ê³„ì—´ì´ë¼ë©´ rax, rdi, rbp ê°™ì€ ì´ë¦„ì´ ë‚˜ì™€ì•¼ í•˜ì£ .)

ğŸ§ª í•´ê²° ë°©ë²• â‘ : x86-64 í™˜ê²½ì—ì„œ ì»´íŒŒì¼í•˜ê¸° (ì •ì„)

CSAPP ì±…ê³¼ ë™ì¼í•˜ê²Œ ë³´ê¸° ìœ„í•´ì„ , x86-64 í™˜ê²½ì—ì„œ ì»´íŒŒì¼í•´ì•¼ í•©ë‹ˆë‹¤. ë°©ë²•ì€:

ë°©ë²• 1: x86 ê¸°ë°˜ ë¦¬ëˆ…ìŠ¤ ë¨¸ì‹  or í´ë¼ìš°ë“œ ì‚¬ìš©

â€¢	AWS EC2 / Google Cloud / WSL on Intel PC ë“±

â€¢	ë˜ëŠ” Intel CPU ë§¥ë¶ì—ì„œ ë„ì»¤ ì‚¬ìš©

ë°©ë²• 2: --platform ì˜µì…˜ìœ¼ë¡œ ë„ì»¤ x86 ì—ë®¬ë ˆì´ì…˜

M1/M2 ë§¥ì—ì„œ ë‹¤ìŒì²˜ëŸ¼ ë„ì»¤ ì»¨í…Œì´ë„ˆë¥¼ x86 ì—ë®¬ë ˆì´ì…˜ìœ¼ë¡œ ì‹¤í–‰í•  ìˆ˜ ìˆì–´ìš”:

```plain text
docker run --platform=linux/amd64 -it ubuntu
```

ê·¸ë¦¬ê³  ì•ˆì—ì„œ gcc ì„¤ì¹˜í•˜ê³  ì‚¬ìš©í•˜ë©´, x86-64ìš© ì–´ì…ˆë¸”ë¦¬ ì½”ë“œê°€ ë‚˜ì˜µë‹ˆë‹¤.

âœ³ï¸ í•´ê²° ë°©ë²• â‘¡: ê·¸ëƒ¥ ARM ì–´ì…ˆë¸”ë¦¬ ê³µë¶€í•˜ê¸°

ë¬¼ë¡  ARM ì–´ì…ˆë¸”ë¦¬ ìì²´ë„ ì¢‹ì€ ê³µë¶€ê°€ ë˜ë©°, íŠ¹íˆ ëª¨ë°”ì¼/ì„ë² ë””ë“œ ìª½ì— ê´€ì‹¬ ìˆë‹¤ë©´ ìœ ìµí•©ë‹ˆë‹¤.

ë‹¤ë§Œ CSAPPë‚˜ ì‹œìŠ¤í…œí”„ë¡œê·¸ë˜ë° ê³¼ëª©ì€ ëŒ€ë¶€ë¶„ x86-64 ê¸°ì¤€ì´ë¼ ê·¸ìª½ì— ë§ì¶°ë³´ëŠ” ê²Œ ìœ ë¦¬í•˜ê¸´ í•˜ì£ .

ğŸ” ì°¸ê³ ë¡œ: x86 ì–´ì…ˆë¸”ë¦¬ ì˜ˆì‹œ (CSAPP ê¸°ì¤€)

```plain text
multstore:
    pushq   %rbp
    movq    %rsp, %rbp
    movq    %rdx, -8(%rbp)
    call    mult2
    movq    -8(%rbp), %rax
    movl    %eax, (%rax)
    popq    %rbp
    ret
```

ê²°ë¡ 

> ë‹¹ì‹ ì˜ ì–´ì…ˆë¸”ë¦¬ ì½”ë“œê°€ CSAPPì™€ ë‹¤ë¥¸ ì´ìœ ëŠ”

> ë„ì»¤ ìš°ë¶„íˆ¬ê°€ ARM64 (Apple Silicon ê¸°ë°˜)ì—ì„œ ì‹¤í–‰ë˜ê³  ìˆê¸° ë•Œë¬¸

í•„ìš”í•˜ì‹œë©´:

â€¢	x86-64 ì»¨í…Œì´ë„ˆ ì„¸íŒ…ë²•

â€¢	objdump, gdbë¡œ ì–´ì…ˆë¸”ë¦¬ ë¶„ì„í•˜ëŠ” ë²•

â€¢	ARM â†” x86 ì–´ì…ˆë¸”ë¦¬ ëŒ€ì‘í‘œ

ë„ ì œê³µí•´ ë“œë¦´ê²Œìš” :)

ì–´ë–¤ ìª½ìœ¼ë¡œ ë” ê³µë¶€í•˜ê³  ì‹¶ì€ì§€ë„ ì•Œë ¤ì£¼ì„¸ìš”!

### ì´ìŠˆ: ìš°ë¶„íˆ¬ ì»¨í…Œì´ë„ˆ í”Œë«í¼ ì„¤ì •ì„ amdë¡œ ë°”ê¿”ì„œ í…ŒìŠ¤íŠ¸í•œ ê²°ê³¼

ì´ì œ ì˜ˆì œì™€ ë˜‘ê°™ë‹¤.

```python
root@a0fd357a556d:/test# cat mstore.s
	.file	"mstore.c"
	.text
	.globl	multstore
	.type	multstore, @function
multstore:
.LFB0:
	.cfi_startproc
	endbr64
	pushq	%rbx
	.cfi_def_cfa_offset 16
	.cfi_offset 3, -16
	movq	%rdx, %rbx
	call	mult2@PLT
	movq	%rax, (%rbx)
	popq	%rbx
	.cfi_def_cfa_offset 8
	ret
	.cfi_endproc
.LFE0:
	.size	multstore, .-multstore
	.ident	"GCC: (Ubuntu 13.3.0-6ubuntu2~24.04) 13.3.0"
	.section	.note.GNU-stack,"",@progbits
	.section	.note.gnu.property,"a"
	.align 8
	.long	1f - 0f
	.long	4f - 1f
	.long	5
0:
	.string	"GNU"
1:
	.align 8
	.long	0xc0000002
	.long	3f - 2f
2:
	.long	0x3
3:
	.align 8
4:
```

## 3. ì»´íŒŒì¼ê³¼ ì–´ì…ˆë¸”

```python
linux> gcc -Og -c mstore.c
```

ì˜¤ë¸Œì íŠ¸ ì½”ë“œ íŒŒì¼ì´ ì™„ì„±ë¨

![](./images/Screenshot_2025-04-03_at_5.55.41_PM.png)

compile: c íŒŒì¼ì„ s íŒŒì¼(ì–´ì…ˆë¸”ë¦¬ íŒŒì¼)ë¡œ

asmble: s íŒŒì¼(ì–´ì…ˆë¸”ë¦¬ íŒŒì¼)ì„ o íŒŒì¼(ì˜¤ë¸Œì íŠ¸ ì½”ë“œ íŒŒì¼(binary))ë¡œ

## 4. Inspecting machine code files

disassembler: ì–´ì…ˆë¸”ë¦¬ ì½”ë“œì™€ ë¹„ìŠ·í•œ í˜•ì‹ì˜ ê¸°ê³„ ì½”ë“œë¥¼ ìƒì‚°í•œë‹¤.

ë¦¬ëˆ…ìŠ¤ì—ì„œ OBJDUMP ê°€ ì´ ì—­í• ì„ í•¨.

```bash
root@a0fd357a556d:/test# objdump -d mstore.o

mstore.o:     file format elf64-x86-64


Disassembly of section .text:

0000000000000000 <multstore>:
   0:	f3 0f 1e fa          	endbr64
   4:	53                   	push   %rbx
   5:	48 89 d3             	mov    %rdx,%rbx
   8:	e8 00 00 00 00       	call   d <multstore+0xd>
   d:	48 89 03             	mov    %rax,(%rbx)
  10:	5b                   	pop    %rbx
  11:	c3                   	ret
root@a0fd357a556d:/test#
```

## 5. linker

ë§ì»¤ë¥¼ ì“°ê¸° ìœ„í•´ì„œëŠ” ì˜¤ë¸Œì íŠ¸ íŒŒì¼ì— ë©”ì¸ ë©”ì„œë“œê°€ ìˆì–´ì•¼ í•œë‹¤.

```c
root@a0fd357a556d:/test# cat main.c
#include <stdio.h>

void multstore(long, long, long *);

int main(){
	long d;
	multstore(2, 3, &d);
	printf("2 * 3 --> %ld/n", d);
	return 0;
}

long mult2(long a, long b) {
	long s = a * b;
	return s;
}

```

íŒŒì¼ ìš©ëŸ‰ì´ ì¦ê°€í•œ ê²ƒì„ ë³¼ ìˆ˜ ìˆìŒ. ì™œ? since it contains not just the machine code for the procedures we provided but also code used to start and terminate the program as well as to interact with the OPERATING SYSTEM.

```bash
root@a0fd357a556d:/test# ls -l
total 32
-rw-r--r-- 1 root root   205 Apr  3 09:34 main.c
-rw-r--r-- 1 root root   107 Apr  3 08:52 mstore.c
-rw-r--r-- 1 root root  1360 Apr  3 08:55 mstore.o # <-- ì•ì„œ ìƒì‚°í•œ ì˜¤ë¸Œì íŠ¸ íŒŒì¼ì— ë¹„í•´
-rw-r--r-- 1 root root   580 Apr  3 08:53 mstore.s
-rwxr-xr-x 1 root root 16112 Apr  3 09:34 prog # <-- í”„ë¦°íŠ¸ ë•Œë¬¸ì— ë” ì»¤ì§„ ìš©ëŸ‰ í™•ì¸ ê°€ëŠ¥.
```

```bash
00000000000011d8 <multstore>:
    11d8:	f3 0f 1e fa          	endbr64 
    11dc:	53                   	push   %rbx
    11dd:	48 89 d3             	mov    %rdx,%rbx
    11e0:	e8 e7 ff ff ff       	call   11cc <mult2>
    11e5:	48 89 03             	mov    %rax,(%rbx)
    11e8:	5b                   	pop    %rbx
    11e9:	c3                   	ret
```

ìœ„ì˜ multstoreëŠ” ì´ì „ì˜ mstoreì˜ ì˜¤ë¸Œì íŠ¸ ì½”ë“œì™€ ë‘ ê°€ì§€ ì°¨ì´ì ì´ ìˆìŒ

1. the addresses listed along the left are different: the linker has shifted the locatino of this code to a different range of address that the callq instruction should use in claling the function mult2
  1. task for the linker is to match function calls with the locations of the executable code for those functions
1. we see two additional lines of code. (??ì™œ ë‚´ ì½”ë“œì—ì„œëŠ” ì´ ì¶”ê°€ ë¼ì¸ì´ ì•ˆ ë³´ì´ëŠ”ì§€ ëª¨ë¥´ê² ë‹¤.) These instructions will have no effect on the program, since they occur after the return instruction(line 7). They have been inserted to grow the code for the function to 16 bytes, enabling a better placement of the next block of code in terms of memory system performance.
### ì˜ë¬¸: ì™œ ë‚´ ì½”ë“œì—ì„œëŠ” ë©”ëª¨ë¦¬ ë¸”ëŸ­ ìµœì í™”ë¥¼ ìœ„í•´ ì½”ë“œë¥¼ ëŠ˜ë¦° ë¶€ë¶„ì´ ì¡´ì¬í•˜ì§€ ì•ŠëŠ”ì§€?

ì´ëŸ° ì°¨ì´ê°€ ìƒê¸°ëŠ” ì´ìœ ëŠ” ì£¼ë¡œ ì»´íŒŒì¼ëŸ¬/ë§ì»¤ ë²„ì „, ìµœì í™” ì˜µì…˜, ë˜ëŠ” ì •ë ¬(alignment) ë°©ì‹ì˜ ì°¨ì´ ë•Œë¬¸ì…ë‹ˆë‹¤. ì¦‰, í•¨ìˆ˜ì˜ ëì— íŒ¨ë”©(padding) ëª…ë ¹ì–´ê°€ ì‚½ì…ë˜ëŠ”ì§€ ì—¬ë¶€ëŠ” ì»´íŒŒì¼ëŸ¬ì™€ ë§ì»¤ê°€ í•¨ìˆ˜ë¥¼ ì–´ë–¤ ë°©ì‹ìœ¼ë¡œ ì •ë ¬í•˜ê³  ìµœì í™”ë¥¼ ìˆ˜í–‰í•˜ëŠ”ì§€ì— ë”°ë¼ ë‹¬ë¼ì§‘ë‹ˆë‹¤. ì£¼ìš” ì›ì¸ì€ ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤:

1.	ì»´íŒŒì¼ëŸ¬ ë° ë§ì»¤ ë²„ì „ ì°¨ì´

ì˜¤ë˜ëœ ë²„ì „ì˜ ë„êµ¬ ì²´ì¸(toolchain)ì—ì„œëŠ” í•¨ìˆ˜ ë‹¨ìœ„ë¥¼ 16ë°”ì´íŠ¸ ë‹¨ìœ„ë¡œ ì •ë ¬í•˜ê¸° ìœ„í•´ ret ì´í›„ì— ì¶”ê°€ ëª…ë ¹ì–´(ì˜ˆ: nop ë˜ëŠ” ë¹„ì–´ ìˆëŠ” placeholder ëª…ë ¹ì–´)ë¥¼ ë„£ì–´ ë‘ëŠ” ê²½ìš°ê°€ ìˆìŠµë‹ˆë‹¤. ë°˜ë©´ ìµœì‹  ë²„ì „ì˜ GCCë‚˜ Clangì—ì„œëŠ” ì´ëŸ° íŒ¨ë”©ì„ êµ³ì´ ë„£ì§€ ì•Šì„ ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤.

2.	ìµœì í™” ì˜µì…˜

â€¢	ìµœì í™” ìˆ˜ì¤€ì´ ë†’ì„ ë•Œ(-O2, -O3): ë¶ˆí•„ìš”í•œ ì½”ë“œë‚˜ íŒ¨ë”©ì´ ìµœëŒ€í•œ ì œê±°ë©ë‹ˆë‹¤.

â€¢	ìµœì í™”ê°€ êº¼ì ¸ ìˆì„ ë•Œ(-O0): ì»´íŒŒì¼ëŸ¬ê°€ ëª…ë ¹ì–´ë¥¼ ê°„ë‹¨í•œ í˜•íƒœë¡œ ë°°ì¹˜í•˜ì§€ë§Œ, ê¼­ íŒ¨ë”©ì„ ë„£ì–´ì•¼ í•œë‹¤ê³  íŒë‹¨ë˜ì§€ ì•Šìœ¼ë©´ ìƒëµí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

3.	í•¨ìˆ˜ ì •ë ¬ vs. ì„¹ì…˜ ì •ë ¬

í•¨ìˆ˜ë§ˆë‹¤ 16ë°”ì´íŠ¸ ì •ë ¬ì„ ì ìš©í•˜ëŠ” ë°©ì‹ë„ ìˆì§€ë§Œ, ì„¹ì…˜ ë‹¨ìœ„ë¡œ ì •ë ¬í•´ ì „ì²´ ë°”ì´ë„ˆë¦¬ë¥¼ ë°°ì¹˜í•  ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤. ì´ ê³¼ì •ì—ì„œ ì´ì „ í•¨ìˆ˜ ëì— íŒ¨ë”©ì„ ë„£ëŠ” ëŒ€ì‹  ë‹¤ìŒ í•¨ìˆ˜ ì‹œì‘ ìœ„ì¹˜ë¥¼ ì •ë ¬í•˜ê±°ë‚˜, íŠ¹ì • ì„¹ì…˜ ì „ì²´ê°€ ì •ë ¬ë˜ë„ë¡ ê´€ë¦¬í•˜ê¸°ë„ í•©ë‹ˆë‹¤.

4.	ë„êµ¬ ì²´ì¸ ë˜ëŠ” ìš´ì˜ì²´ì œë³„ ê´€ë¡€ ì°¨ì´

íŠ¹ì • ì‹œìŠ¤í…œì—ì„œëŠ” í•¨ìˆ˜ê°€ 16ë°”ì´íŠ¸ ê²½ê³„ì— ë§ì¶° ì‹œì‘í•˜ê¸°ë§Œ í•˜ë©´ ì¶©ë¶„í•˜ë‹¤ê³  ë³´ê³ , í•¨ìˆ˜ ë ë¶€ë¶„ì—ëŠ” ì¶”ê°€ íŒ¨ë”© ëª…ë ¹ì–´ë¥¼ ë„£ì§€ ì•ŠìŠµë‹ˆë‹¤. ì–´ë–¤ ì‹œìŠ¤í…œì—ì„œëŠ” (íŠ¹íˆ 64ë¹„íŠ¸ í™˜ê²½ì—ì„œ) í•¨ìˆ˜ ì‹œì‘ì„ ì •ë ¬í•´ ìºì‹œ íš¨ìœ¨ì„ ë†’ì´ëŠ” ì „ëµì„ ì·¨í•˜ë¯€ë¡œ, í•¨ìˆ˜ ëì— ë³„ë„ íŒ¨ë”©ì´ ë¶™ì§€ ì•Šì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ê²°êµ­, í•¨ìˆ˜ ëì— íŒ¨ë”© ëª…ë ¹ì–´ê°€ ìˆëŠ”ì§€ ì—¬ë¶€ëŠ” ì»´íŒŒì¼ëŸ¬ ë° ë§ì»¤ ì¡°í•©, ìµœì í™” ì˜µì…˜, ì •ë ¬ ì •ì±… ë“±ì´ ì¢…í•©ì ìœ¼ë¡œ ì‘ìš©í•´ ê²°ì •ë©ë‹ˆë‹¤. ì½”ë“œì— ì•„ë¬´ ë¬¸ì œê°€ ì—†ê³ , ì„±ëŠ¥ì—ë„ í¬ê²Œ ì˜í–¥ì„ ì£¼ì§€ ì•Šìœ¼ë¯€ë¡œ, ë³´ì´ëŠ” ì°¨ì´ëŠ” ë‹¨ì§€ ë¹Œë“œ í™˜ê²½ ì°¨ì´ì¼ ë¿ì…ë‹ˆë‹¤.

## Notes on  Formatting

- ì›¹ ë¶€ë¡1: IA32. ê¸°ê³„ì–´ ì½”ë“œ ì„¤ëª…
- ì›¹ ë¶€ë¡2: c ì½”ë“¤ì„ ì–´ì…ˆë¸”ë¦¬ì–´ ì½”ë“œì— ë³‘í•©í•˜ëŠ” ë°©ë²•
  - ì–´ì…ˆë¸”ë¦¬ì–´ë¡œ ìµœì í™”ëœ ì½”ë“œë¥¼ Cì— ì“°ëŠ” ë²•: ê·¸ëƒ¥ ì–´ì…ˆë¸”ë¦¬ì–´ë¡œ ì“°ê³  ë§í‚¹ ë‹¨ê³„ì—ì„œ ë³‘í•©ëœ ì–´ì…ˆë¸”ë¦¬ ì½”ë“œë¥¼ ìƒì‚°í•˜ê±°ë‚˜, c íŒŒì¼ì— ì„ë² ë”© í•˜ëŠ” ë°©ë²•ì´ ìˆë‹¤.
![](./images/IMG_0472.jpeg)

# Data Formats

## Word

ì¸í…” 16ë¹„íŠ¸ ì•„í‚¤í…ì²˜ì—ì„œ ì²˜ìŒ 16ë¹„íŠ¸ ë°ì´í„° íƒ€ì…ì„ ì¼ì»¬ì€ ë°ì„œ ì‹œì‘ë¼ì„œ 32ë¹„íŠ¸ ë°ì´í„° íƒ€ì…ì„ ë”ë¸” ì›Œë“œ, 64ë¹„íŠ¸ ë°ì´í„° íƒ€ì…ì„ ì¿¼ë“œ ì›Œë“œë¡œ ë¶€ë¥´ê¸° ì‹œì‘í•¨.

### ì˜ë¬¸:  8-byte quad wordëŠ” ê·¸ëƒ¥ ì¿¼ë“œ ì›Œë“œ ìì²´ì˜ ë°”ì´íŠ¸ ìˆ˜ê°€ 8ì´ë¼ì„œ ê·¸ë ‡ê²Œ ë¶€ë¥´ëŠ” ê±´ê°€?

ë„¤, ë§ìŠµë‹ˆë‹¤.
â€œ8-byte quad wordâ€ëŠ” 8ë°”ì´íŠ¸(64ë¹„íŠ¸)ë¡œ êµ¬ì„±ë˜ì–´ ìˆë‹¤ëŠ” ëœ»ì—ì„œ â€œquad wordâ€ë¼ê³  ë¶€ë¦…ë‹ˆë‹¤.
ì—­ì‚¬ì ìœ¼ë¡œ, â€œwordâ€ë¼ëŠ” ìš©ì–´ëŠ” ì»´í“¨í„°ì˜ ê¸°ë³¸ ë°ì´í„° ë‹¨ìœ„ë¥¼ ì˜ë¯¸í•˜ë©°, ë³´í†µ x86 ì•„í‚¤í…ì²˜ì—ì„œëŠ” wordê°€ 2ë°”ì´íŠ¸ë¥¼ ì˜ë¯¸í•©ë‹ˆë‹¤. ì´ì— ë”°ë¼ 2ë°”ì´íŠ¸ì¸ word, 4ë°”ì´íŠ¸ì¸ double word, 8ë°”ì´íŠ¸ì¸ quad wordë¡œ ì •ì˜ë©ë‹ˆë‹¤.

ì¦‰, 8ë°”ì´íŠ¸ì˜ ë°ì´í„°ê°€ quad wordë¡œ ë¶ˆë¦¬ëŠ” ê²ƒì€ ë‹¨ìˆœíˆ ê·¸ í¬ê¸°ê°€ 8ë°”ì´íŠ¸ì´ê¸° ë•Œë¬¸ì…ë‹ˆë‹¤.

## í‘œ: Sizes of C data types in x86-64

With a 64-bit machine, pointers are 8 bytes long.

![](./images/image.png)

floating point numbers come in two principal formats: single precision values

ì´ í‘œë¥¼ ê¸°ì¤€ìœ¼ë¡œ ì–´ì…ˆë¸”ë¦¬ ì½”ë“œì˜ ë°ì´í„° íƒ€ì…ì„ ì´í•´í•  ìˆ˜ ìˆìŒ

movb: move byte

movw: move word

movl: move double word

movq: move quad word

ì´ë•Œ â€˜lâ€™ì€ double wordì™€ double precision ëª¨ë‘ì—ì„œ ì‚¬ìš© ê°€ëŠ¥.

### ì˜ë¬¸

ë°ì´í„° íƒ€ì…ì˜ ì‚¬ì´ì¦ˆëŠ” ë‹¤ë¥´ì§€ë§Œâ€¦ì–´ë–»ê²Œ ê°™ì´ ì“¸ ìˆ˜ ìˆëŠ” ê±°ì§€? ë°”ì´ë„ˆë¦¬ ë‹¨ìœ„ì—ì„œ êµ¬ë³„í•˜ê¸° ê·€ì°®ì„ ê±° ê°™ì€ë°. ìš©ëŸ‰ì´ ë‹¤ë¥´ì–ì•„.

### ë‹µë³€

ì´ ì§ˆë¬¸ì˜ í•µì‹¬ì€ â€œlâ€ ì ‘ë¯¸ì‚¬ê°€ 32ë¹„íŠ¸ ë°ì´í„°ë¥¼ ì´ë™í•œë‹¤ëŠ” ì ì— ìˆìŠµë‹ˆë‹¤. CSAPPì—ì„œëŠ” IA32 í™˜ê²½ì—ì„œ double precision ê°’(ì‹¤ì œë¡œ 64ë¹„íŠ¸)ì´ ë‘ ê°œì˜ 32ë¹„íŠ¸ ì¡°ê°ìœ¼ë¡œ ë‚˜ë‰˜ì–´ ì €ì¥ë˜ë¯€ë¡œ, ê°ê°ì˜ 32ë¹„íŠ¸ë¥¼ ì´ë™í•  ë•Œ movl ëª…ë ¹ì–´ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤. ì¦‰, â€œlâ€ì€ double word(32ë¹„íŠ¸)ë¥¼ ì˜ë¯¸í•˜ì§€ë§Œ, double precision ê°’ì€ ë‘ ê°œì˜ double wordë¡œ ì·¨ê¸‰í•  ìˆ˜ ìˆê¸° ë•Œë¬¸ì— ê°™ì€ ì ‘ë¯¸ì‚¬ë¥¼ ì‚¬ìš©í•´ë„ ë¬¸ì œê°€ ì—†ëŠ” ê²ƒì…ë‹ˆë‹¤.

ìš”ì•½í•˜ë©´:

â€¢	movl: 32ë¹„íŠ¸(4ë°”ì´íŠ¸) ë°ì´í„°ë¥¼ ì´ë™

â€¢	double precision ê°’: 64ë¹„íŠ¸ì´ì§€ë§Œ, IA32ì—ì„œëŠ” 32ë¹„íŠ¸ ë‹¨ìœ„(ë‘ ë²ˆì˜ movl)ë¡œ ì²˜ë¦¬

ë”°ë¼ì„œ, ë°ì´í„° íƒ€ì…ì˜ ì „ì²´ í¬ê¸°ê°€ ë‹¤ë¥´ë”ë¼ë„ IA32ì—ì„œëŠ” double precision ê°’ì„ ë‘ ê°œì˜ 32ë¹„íŠ¸ ë‹¨ìœ„ë¡œ ë‹¤ë£¨ê¸° ë•Œë¬¸ì— ê°™ì€ â€œlâ€ ì ‘ë¯¸ì‚¬ë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

> The assembly code uses the suffix â€˜lâ€™ to denote a 4-byte integer as well as an 8-byte double-precision floating point number.

### ì˜ë¬¸: double precisionì„ ì²˜ë¦¬í•  ë•ŒëŠ” double word ë‘˜ì„ ì²˜ë¦¬í•œë‹¤ëŠ” ê°œë…ì¸ê°€?

### ë‹µë³€

ë„¤, ë§ìŠµë‹ˆë‹¤. IA32 í™˜ê²½ì—ì„œëŠ” 64ë¹„íŠ¸ì¸ double precision ê°’ì„ ë‘ ê°œì˜ 32ë¹„íŠ¸ double wordë¡œ ë‚˜ëˆ„ì–´ ì²˜ë¦¬í•˜ëŠ” ê°œë…ì…ë‹ˆë‹¤. ê·¸ë˜ì„œ movl ëª…ë ¹ì–´ê°€ 32ë¹„íŠ¸ì”©, ì¦‰ double word ë‹¨ìœ„ë¡œ ë°ì´í„°ë¥¼ ì´ë™ì‹œí‚¤ëŠ”ë° ì‚¬ìš©ë©ë‹ˆë‹¤. ì´ ë°©ì‹ìœ¼ë¡œ double precision ê°’ì„ ì²˜ë¦¬í•˜ë©´, 64ë¹„íŠ¸ ë°ì´í„°ë¥¼ ë‘ ë²ˆì˜ movlë¡œ ë‹¤ë£¨ê²Œ ë˜ëŠ” ê²ƒì…ë‹ˆë‹¤.

### Floating point numbersì— ëŒ€í•œ ì£¼ì˜

ì†Œìˆ˜ í‘œí˜„ì—ëŠ” ë‘ ê°€ì§€ ìë£Œ í˜•ì‹ ìˆìŒ

1. single precision = cì˜ float
1. double precision = cì˜ double
ê·¸ëŸ°ë°! ì›ë˜ x86 ë§ˆì´í¬ë¡œ í”„ë¡œì„¸ì„œ íŒ¨ë°€ë¦¬ëŠ” ì—­ì‚¬ì ìœ¼ë¡œ 80bit ì†Œìˆ˜ í˜•ì‹ì„ ì¼ìŒ. ì´ê±´ ì§€ê¸ˆë„ cì—ì„œ long doubleì´ë¼ëŠ” íƒ€ì…ìœ¼ë¡œ ì“¸ ìˆ˜ ìˆìŒ. í•˜ì§€ë§Œ ë¹„ì¶”. ì™œ? ìš”ì¦˜ ì˜ ì•ˆ ì”€.

# Accessing Information

## Practice 3.1

### ì•„ë˜ ì£¼ì–´ì§„ operand formsì™€ address value í…Œì´ë¸”ì„ í™•ì¸í•˜ì—¬ ê° operand ê°’ ê³„ì‚°í•´ë³´ê¸°

![](./images/Screenshot_2025-04-04_at_7.29.30_PM.png)

![](./images/Screenshot_2025-04-04_at_7.29.38_PM.png)

### ê³„ì‚° ê³¼ì •

![](./images/IMG_0465.png)

ï¿¼

## Practice 3.2

### ì£¼ì–´ì§„ ì¸ìˆ˜ë¥¼ ë°”íƒ•ìœ¼ë¡œ mov ì—°ì‚° í´ë˜ìŠ¤ì˜ suffix ì™„ì„±í•´ë³´ê¸°

### í’€ì´

![](./images/IMG_0467.png)

## 64 O Practice 3.3

### ì˜ë¬¸: movì˜ ì ‘ë¯¸ì‚¬ëŠ” ì¶œë°œ ë©”ëª¨ë¦¬ ê¸°ì¤€ì¸ê°€ ë„ì°© ë©”ëª¨ë¦¬ ê¸°ì¤€ì¸ê°€

### ë‹µë³€

x86 ê³„ì—´(íŠ¹íˆ AT&T ë¬¸ë²•)ì—ì„œ movb, movw, movl, movq ê°™ì€ ì ‘ë¯¸ì‚¬ëŠ” â€œì–´ëŠ ìª½ ê¸°ì¤€ìœ¼ë¡œâ€ ì„ íƒë˜ëŠ” ê²ƒì´ ì•„ë‹ˆë¼, **â€œì´ë™í•˜ë ¤ëŠ” ë°ì´í„° í¬ê¸°(ì—°ì‚° í¬ê¸°)â€**ì— ì˜í•´ ê²°ì •ëœë‹¤ê³  ë³´ì‹œë©´ ë©ë‹ˆë‹¤. ì¦‰,

â€¢	movbëŠ” 8ë¹„íŠ¸(1ë°”ì´íŠ¸) ë‹¨ìœ„ ì „ì†¡

â€¢	movwëŠ” 16ë¹„íŠ¸(2ë°”ì´íŠ¸) ë‹¨ìœ„ ì „ì†¡

â€¢	movlëŠ” 32ë¹„íŠ¸(4ë°”ì´íŠ¸) ë‹¨ìœ„ ì „ì†¡

â€¢	movqëŠ” 64ë¹„íŠ¸(8ë°”ì´íŠ¸) ë‹¨ìœ„ ì „ì†¡

ì„ ì˜ë¯¸í•©ë‹ˆë‹¤. ì›ì²œ(Source)ê³¼ ëª©ì ì§€(Destination)ì˜ í¬ê¸°ê°€ í•­ìƒ ì¼ì¹˜í•´ì•¼ í•˜ë¯€ë¡œ, â€œì ‘ë¯¸ì‚¬ê°€ ì¶œë°œ ë©”ëª¨ë¦¬ ê¸°ì¤€ì¸ê°€ ë„ì°© ë©”ëª¨ë¦¬ ê¸°ì¤€ì¸ê°€?â€ë¼ê³  ë¬»ëŠ” ê²ƒì€ ì‚¬ì‹¤ í° ì˜ë¯¸ê°€ ì—†ìŠµë‹ˆë‹¤. ì™œëƒí•˜ë©´ x86ì—ì„œëŠ” ë³´í†µ 8ë¹„íŠ¸ ë ˆì§€ìŠ¤í„°ë¼ë©´ 8ë¹„íŠ¸ ë©”ëª¨ë¦¬ì™€ë§Œ, 16ë¹„íŠ¸ ë ˆì§€ìŠ¤í„°ë¼ë©´ 16ë¹„íŠ¸ ë©”ëª¨ë¦¬ì™€ë§Œ ë§¤ì¹­í•˜ëŠ” ì‹ìœ¼ë¡œ ì‚¬ìš©í•˜ê¸° ë•Œë¬¸ì…ë‹ˆë‹¤.

ì˜ˆì»¨ëŒ€ ë‹¤ìŒê³¼ ê°™ì€ AT&T ë¬¸ë²•ì„ ë³´ë©´:

```plain text
movb  (%eax), %bl
movw  (%eax), %bx
movl  (%eax), %ebx
```

â€¢	(%eax)ì—ì„œ 8ë¹„íŠ¸ë¥¼ ì½ì–´ bl(8ë¹„íŠ¸ ë ˆì§€ìŠ¤í„°)ë¡œ ì˜®ê¸¸ ë•ŒëŠ” movb

â€¢	(%eax)ì—ì„œ 16ë¹„íŠ¸ë¥¼ ì½ì–´ bx(16ë¹„íŠ¸ ë ˆì§€ìŠ¤í„°)ë¡œ ì˜®ê¸¸ ë•ŒëŠ” movw

â€¢	(%eax)ì—ì„œ 32ë¹„íŠ¸ë¥¼ ì½ì–´ ebx(32ë¹„íŠ¸ ë ˆì§€ìŠ¤í„°)ë¡œ ì˜®ê¸¸ ë•ŒëŠ” movl

ì²˜ëŸ¼, ì–´ë–¤ ë ˆì§€ìŠ¤í„° ë˜ëŠ” ë©”ëª¨ë¦¬ë¥¼ ëŒ€ìƒìœ¼ë¡œ í•˜ëŠëƒê°€ ì´ë¯¸ ê·¸ ì—°ì‚° í¬ê¸°ë¥¼ ê²°ì •í•˜ê³ , ê·¸ì— ë§ì¶° ì ‘ë¯¸ì‚¬ê°€ ì„ íƒë˜ëŠ” êµ¬ì¡°ì…ë‹ˆë‹¤. ë”°ë¼ì„œ â€œì ‘ë¯¸ì‚¬ê°€ ì–´ëŠ ìª½(ì¶œë°œ/ë„ì°© ë©”ëª¨ë¦¬) ê¸°ì¤€ì´ëƒâ€ë¼ê³  ë¬»ê¸°ë³´ë‹¤ëŠ”, **â€œë ˆì§€ìŠ¤í„° ë˜ëŠ” ë©”ëª¨ë¦¬ê°€ ëª‡ ë°”ì´íŠ¸(ëª‡ ë¹„íŠ¸)ì§œë¦¬ì¸ê°€â€**ì— ë”°ë¼ ì ‘ë¯¸ì‚¬ê°€ ë¶™ëŠ”ë‹¤ê³  ë³´ì‹œë©´ ë©ë‹ˆë‹¤.

### ë¬¸ì œì™€ í’€ì´



![](./images/IMG_0473.png)

## ê°œêµ¬ì½”1. ë°ì´í„° ì´ë™ ì˜ˆì‹œ

### ê°œë…: long ìë£Œí˜• ê°’ì„ êµí™˜í•˜ëŠ” í•¨ìˆ˜ë¥¼ í†µí•œ ë°ì´í„° ì´ë™ ê³¼ì • ì‚´í´ë³´ê¸°

- exchange í•¨ìˆ˜ëŠ” ì„¸ ëª…ë ¹ì–´ë¡œ êµ¬ì„±ë¨.
  - ë‘ ê°œì˜ ë°ì´í„° ì´ë™ê³¼ ë¦¬í„´
- í•¨ìˆ˜ëŠ” ê°’ì„ %raxì— ë„£ì–´ì„œ ë¦¬í„´ì‹œí‚´. or in one of the low-order portions of this register
- Procedure
  - ë§¤ê°œë³€ìˆ˜ xp, yê°€ ë ˆì§€ìŠ¤í„° %rdi, %rsiì— ê°ê° ì €ì¥ë¨
  - ì¸ìŠ¤íŠ¸ëŸ­ì…˜ 2ê°€ ë©”ëª¨ë¦¬ì—ì„œ %rdiê°€ ê°€ë¦¬í‚¤ëŠ” ë©”ëª¨ë¦¬ ìœ„ì¹˜ë¥¼ ì½ì–´ì™€ì„œ ë ˆì§€ìŠ¤í„° %rax ìœ„ì¹˜ì— ê°’ì„ ì €ì¥. (x = *xp)
  - %raxëŠ” ë‚˜ì¤‘ì— ê°’ì„ ë¦¬í„´í•˜ê¸° ìœ„í•´ ì“°ì¼ ê²ƒ.
  - ì¸ìŠ¤íŠ¸ëŸ­ì…˜3(movq %rsi, (%rdi))ëŠ” %rdiê°€ ê°€ë¦¬í‚¤ëŠ” ë©”ëª¨ë¦¬ ìœ„ì¹˜ì— %rsi ê°’(y)ì„ ì €ì¥(*xp = y)
### êµ¬í˜„

```c
// C code
long exchange(long *xp, long y) // xpì— ìˆëŠ” ê°’ì„ xì— ì €ì¥í•˜ê³ , ìƒˆë¡œìš´ yê°’ì„ ì €ì¥í•œ í›„ ì›ë˜ xpì— ìˆë˜ ì˜¤ë˜ëœ ê°’, ì§€ê¸ˆì€ xê°’ì„ ë¦¬í„´
{ 
	long x = *xp;
	*xp = y;
	return x;
}
// Assembly code
// long exchange(long *xp, long y)
// xp in %rdi, y in %rsi
exchange:
	movq (%rdi), %rax   // xë¥¼ xpë¡œ ê°€ì ¸ì˜´. return ê°’ìœ¼ë¡œ ì„¤ì •
	movq %rsi, (%rdi) // yë¥¼ xpì— ì €ì¥
	ret
```

### ì½”ë©˜íŠ¸

ì•„ë˜ëŠ” exchange í•¨ìˆ˜ì™€ ê·¸ì— ëŒ€ì‘í•˜ëŠ” ì–´ì…ˆë¸”ë¦¬ ì½”ë“œë¥¼ ì´í•´í•˜ê¸° ìœ„í•œ ê°„ë‹¨í•œ ë³µìŠµ ë¬¸ì œ 3ê°€ì§€ì…ë‹ˆë‹¤.

1. exchange í•¨ìˆ˜ì—ì„œ ë§¤ê°œë³€ìˆ˜ xpì™€ yëŠ” ê°ê° ì–´ë–¤ ë ˆì§€ìŠ¤í„°ì— ì „ë‹¬ë˜ë‚˜ìš”?
  1. %rdi, %rsi
1. í•¨ìˆ˜ê°€ ë°˜í™˜í•˜ëŠ” ê°’ì€ ì–´ëŠ ë ˆì§€ìŠ¤í„°ì— ì €ì¥ë˜ë©°, ì™œ ì´ ë ˆì§€ìŠ¤í„°ë¥¼ ì“°ë‚˜ìš”?
  1. %rax. ì´ ë ˆì§€ìŠ¤í„°ë¥¼ ì“°ëŠ” ì´ìœ ëŠ” ëª¨ë¥´ê² ìŒ
  1. %rax ë ˆì§€ìŠ¤í„°ë¥¼ ë¦¬í„´ ê°’ìœ¼ë¡œ ì‚¬ìš©í•˜ëŠ” ì´ìœ **ëŠ”, x86-64 System V ABI(ë¦¬ëˆ…ìŠ¤ ë“±ì—ì„œ ì‚¬ìš©í•˜ëŠ” í‘œì¤€ í˜¸ì¶œ ê·œì•½)ì—ì„œ í•¨ìˆ˜ì˜ ë°˜í™˜ê°’(ì •ìˆ˜, í¬ì¸í„°, long ë“±)ì´ ê¸°ë³¸ì ìœ¼ë¡œ %rax ë ˆì§€ìŠ¤í„°ë¥¼ í†µí•´ ì „ë‹¬ë˜ë„ë¡ ì •í•´ì ¸ ìˆê¸° ë•Œë¬¸ì…ë‹ˆë‹¤.
1. ì–´ì…ˆë¸”ë¦¬ ì½”ë“œì—ì„œ movq (%rdi), %raxì™€ movq %rsi, (%rdi)ëŠ” ê°ê° ì–´ë–¤ ë™ì‘ì„ ìˆ˜í–‰í•˜ë‚˜ìš”?
  1. movq (%rdi), %rax 
    1. %rdiê°€ ê°€ë¦¬í‚¤ëŠ” ì£¼ì†Œì˜ ê°’, ì¦‰ xpê°€ ê°€ë¦¬í‚¤ëŠ” ë©”ëª¨ë¦¬ì˜ ê°’ì„ %rax ë ˆì§€ìŠ¤í„°ì— ì €ì¥(x = *xp)
  1. movq %rsi, (%rdi)
    1. ë©”ëª¨ë¦¬ ì£¼ì†Œ yì˜ ê°’ì„ xpê°€ ê°€ë¦¬í‚¤ëŠ” ë©”ëª¨ë¦¬ì— ì €ì¥. (*xp = y)
## ê°œêµ¬ì½”2. í¬ì¸í„° ì˜ˆì œ

### ê°œë…

- Pointer dereferencing: long x = *xpë¼ê³  í•  ë•Œ, â€˜*â€™ë¥¼ ë¶™ì´ë©´ pointer dereferencingì„ ìˆ˜í–‰í•˜ì—¬ xpê°€ ê°€ë¦¬í‚¤ëŠ” ìœ„ì¹˜ì˜ ê°’ì„ ì°¸ì¡°. ì˜¤ë¥¸ìª½ì— ìˆìœ¼ë©´ ì“°ê¸° ì—°ì‚°ì„ ìˆ˜í–‰í•˜ê²Œ ë¨.
- pointer creation: &ì—°ì‚°ì. í•˜ëŠ” ì¼ì´ ë­ì§€?
  - &(address-of) ì—°ì‚°ìëŠ” ë³€ìˆ˜ì˜ ë©”ëª¨ë¦¬ ì£¼ì†Œë¥¼ ì–»ì„ ë•Œ ì‚¬ìš©í•©ë‹ˆë‹¤. ì˜ˆë¥¼ ë“¤ì–´ long a = 4; ê°€ ìˆì„ ë•Œ &aëŠ” aê°€ ì €ì¥ëœ ë©”ëª¨ë¦¬ì˜ ì£¼ì†Œ(í¬ì¸í„°)ê°€ ë©ë‹ˆë‹¤.
  - ì¦‰, exchange(&a, 3) ë¼ê³  í˜¸ì¶œí•˜ë©´,
  - &aê°€ aì˜ ì£¼ì†Œ(í¬ì¸í„°)ë¥¼ ì œê³µí•˜ê³ ,
  - í•¨ìˆ˜ ë‚´ë¶€ì—ì„œëŠ” ì´ ì£¼ì†Œë¥¼ í†µí•´ aì˜ ê°’ì— ì§ì ‘ ì ‘ê·¼í•˜ê±°ë‚˜ ë³€ê²½í•  ìˆ˜ ìˆê²Œ ë©ë‹ˆë‹¤.
### êµ¬í˜„

```c
long x = *xp // we should read the value stored in the location designated by x and store it as a local variable named x.
*xp = y // ì •ë°˜ëŒ€ì˜ ì—­í• . ì´ê²ƒë„ í¬ì¸í„° dereferencingì˜ ì¼ì¢…ì´ì§€ë§Œ, dereferencingì´ ì™¼ìª½ì— ìˆìœ¼ë©´ ì“°ê¸° ì—°ì‚°ì„ ìˆ˜í–‰í•¨.
```

```c
long a = 4;
long b = exchange(&a, 3);
printf("a = %ld, b = %ld\verb@\@n", a, b); 
--> a = 3, b = 4
```



### ì½”ë©˜íŠ¸

ì§„ì§œ ì–´ë µë‹¤

## Practice 3.4

### ë¬¸ì œ

Assume variables sp and dp are declared with types
src_t *sp;
dest_t *dp;
where src_t and dest_t are data types declared with typedef. We wish to use the appropriate pair of data movement instructions to implement the operation


*dp = (dest_t) *sp;

Assume that the values of sp and dp are stored in registers %rdi and %rsi, respectively. For each entry in the table, show the two instructions that implement the specified data movement. The first instruction in the sequence should read from memory, do the appropriate conversion, and set the appropriate portion of register %rax. The second instruction should then write the appropriate portion of %rax to memory. In both cases, the portions may be %rax, %eax, %ax, or %al, and they may differ from one another. 

Recall that when performing a cast that involves both a size change and a change of â€œsignednessâ€ in C, the operation should change the size first (Section
2.2.6).

### ë‹µì•ˆ

### í’€ì´

1. movb: charëŠ” byteì´ë¯€ë¡œ (%rdi)ì— ì €ì¥ëœ char ê°’ì€ movbë¡œ ê°€ì ¸ì™€ì„œ returnì˜ low order portionì¸ %alì— ì €ì¥. ê·¸ í›„ ëª©ì ì§€ì˜ ìë£Œí˜•ì¸ intì— ë§ì¶° movl ëª…ë ¹ì–´ë¡œ %alì˜ ê°’ì„ (%rsi)ë¡œ ë³µì‚¬í•œë‹¤.
  1. í‹€ë¦° í’€ì´. ë¶€í˜¸/ë¬´ë¶€í˜¸ í™•ì¥ì„ í†µí•´ ìë£Œì˜ í¬ê¸°ë¥¼ ë§ì¶°ì•¼ í•œë‹¤. ì œëŒ€ë¡œëœ ë‹µì€ ì•„ë˜ì™€ ê°™ìŒ
    1. movsbl (%rdi), %eax
    1. movl %eax, (%rsi)
1. unsigned: ì¼ë°˜ì ìœ¼ë¡œ ë¶€í˜¸ ì—†ëŠ” ì •ìˆ˜í˜•ì„ ì˜ë¯¸. ì •í™•íˆëŠ” unsigned int. ë”°ë¼ì„œ, movzblë¡œ ë¬´ë¶€í˜¸ í™•ì¥í•˜ì—¬ ì§„í–‰. â†’ ì •ë‹µ
1. movzbq: charëŠ” byte, longì€ quad wordì´ë¯€ë¡œ movzbqë¥¼ í†µí•´ ë¬´ë¶€í˜¸ í™•ì¥ìœ¼ë¡œ (%rdi) ê°’ì„ %raxì— ë³µì‚¬. ê·¸ë¦¬ê³  ë‚˜ì„œ %rax ê°’ì„ ê·¸ëŒ€ë¡œ (%rsi)ë¡œ ë³µì‚¬í•´ì£¼ë©´ ë¨ â†’ ì •ë‹µ!
1. int â†’ charí•  ë•ŒëŠ”?: C ì–¸ì–´ì—ì„œ **â€œë” í° ì •ìˆ˜í˜•(int) â†’ ë” ì‘ì€ ì •ìˆ˜í˜•(char)â€**ìœ¼ë¡œ ìºìŠ¤íŒ…í•  ë•ŒëŠ”, ë‹¨ìˆœíˆ **í•˜ìœ„ ë°”ì´íŠ¸(8ë¹„íŠ¸)**ë§Œ ì·¨ê¸‰í•˜ë©´ ë©ë‹ˆë‹¤.
  1. movb %eax, (%rsi)ëŠ” í‹€ë¦° ì—°ì‚°! ê·¸ëƒ¥ return ì˜ ë°”ì´íŠ¸ ì‚¬ì´ì¦ˆì— í•´ë‹¹í•˜ëŠ” low order portionì¸ %al ê°’ë§Œì„ (%rsi)ë¡œ ë³µì‚¬í•˜ë©´ ë¨
1. ìœ„ì™€ ë™ì¼í•œ ê·œì¹™ ì ìš©
1. short: data typeì€ Word, assembly code suffixëŠ” w, ì‚¬ì´ì¦ˆëŠ” 16. 8ë¹„íŠ¸ì—ì„œ 16ë¹„íŠ¸ë¡œ í™•ì¥í•´ì•¼ í•¨.
  1. ë…¼ë¦¬ì ìœ¼ë¡œëŠ” ë‹¤ìŒê³¼ ê°™ì€ ê³¼ì •ì¼ ê±° ê°™ìŒ: movsbw %al, (%rsi)
  1. ì˜¤ë¥˜! ëª©ì ì§€ê°€ ë ˆì§€ìŠ¤í„°ì¼ ë•Œë§Œ í™•ì¥ì´ ê°€ëŠ¥í•˜ë‹¤! ë”°ë¼ì„œ ë‹¤ìŒ ê³¼ì •ìœ¼ë¡œ ì •ì •í•´ì•¼ í•¨
    1. movsbw (%rdi), %ax
    1. movw %ax, (%rsi)
  1. ì•„ë˜ë„ ë™ì¼í•œ ê¸°ëŠ¥ì„ í•œë‹¤ê³  í•¨. ì–´ì°¨í”¼ low portionë§Œ ìµœì†Œí•œìœ¼ë¡œ ë§ì¶”ë©´ ë˜ê¸° ë•Œë¬¸ì— ì—¬ëŸ¬ ì—°ì‚°ì— ëŒ€í•œ ì—¬ëŸ¬ ì¸ìŠ¤íŠ¸ëŸ­ì…˜ ì‚¬ìš©ì´ ê°€ëŠ¥í•œê°€? â†’ ë§ìŒ
    1. movsbl (%rdi), %eax
    1. movw %ax, (%rsi)
### í”¼ë“œë°±: í’€ì´ 1ì— ëŒ€í•œ í”¼ë“œë°±

ìš°ì„  í‘œì— ì œì‹œëœ â€œë‘ ê°œì˜ ëª…ë ¹ì–´â€ë¡œ â€œchar â†’ intâ€ ë³€í™˜ì„ êµ¬í˜„í•  ë•Œ, ì£¼ì˜í•´ì•¼ í•  ì¤‘ìš”í•œ ì ì´ â€˜ë¶€í˜¸(sign)â€™ ì²˜ë¦¬ì™€ ë ˆì§€ìŠ¤í„° ì‚¬ìš©ì…ë‹ˆë‹¤.

1. â€œmovl %al, (%rsi)â€ê°€ ì‹¤ì œë¡œëŠ” ìœ íš¨í•˜ì§€ ì•ŠìŒ

ì¼ë°˜ì ì¸ AT&T ë¬¸ë²•ì—ì„œ

```plain text
movb  (%rdi), %al
movl  %al,   (%rsi)
```

ì™€ ê°™ì€ ì½”ë“œëŠ” ë‘ ê°€ì§€ ë¬¸ì œê°€ ìˆìŠµë‹ˆë‹¤.

1.	**ë¶€í˜¸ í™•ì¥(ë˜ëŠ” ë¶€í˜¸ ì—†ëŠ” í™•ì¥)**ì´ ì´ë£¨ì–´ì§€ì§€ ì•ŠëŠ”ë‹¤.

â€¢	movb (%rdi), %alì€ 8ë¹„íŠ¸ë§Œ ì½ì–´ì„œ %raxì˜ í•˜ìœ„ 8ë¹„íŠ¸(%al)ì— ì €ì¥í•˜ì§€ë§Œ, ì–´ë–¤ ë¶€í˜¸ í™•ì¥ë„ ìˆ˜í–‰í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.

2.	ì˜¤ë¥˜ í˜¹ì€ ì˜ë„ì¹˜ ì•Šì€ ì €ì¥

â€¢	movl %al, (%rsi)ë¼ëŠ” ëª…ë ¹ ìì²´ê°€ (GNU ì–´ì…ˆë¸”ëŸ¬ ê¸°ì¤€) ì˜ëª»ëœ í˜•íƒœì…ë‹ˆë‹¤.

â€¢	â€œmovlâ€ì€ 32ë¹„íŠ¸(4ë°”ì´íŠ¸)ë¥¼ ì €ì¥í•´ì•¼ í•˜ëŠ”ë°, ì›ë³¸ìœ¼ë¡œ â€œ%alâ€ (8ë¹„íŠ¸ ë ˆì§€ìŠ¤í„°)ë§Œ ì§€ì •í–ˆë‹¤ëŠ” ì ì—ì„œ ë¬¸ì œê°€ ë©ë‹ˆë‹¤.

â€¢	ì„¤ë ¹ ì–´ì…ˆë¸”ëŸ¬ê°€ movl %al, (%rsi)ë¥¼ ë°›ì•„ì¤€ë‹¤ê³  í•´ë„ ì‹¤ì œë¡œëŠ” ì˜¬ë°”ë¥¸ 32ë¹„íŠ¸ ì €ì¥ì„ í•˜ì§€ ëª»í•©ë‹ˆë‹¤.

2. ì˜¬ë°”ë¥¸ ì ‘ê·¼: ë¶€í˜¸ í™•ì¥(ë˜ëŠ” ë¬´ë¶€í˜¸ í™•ì¥) + 32ë¹„íŠ¸ ì €ì¥

Cì—ì„œ char -> int ë³€í™˜ì€ â€œ(signed) charâ€ì¸ì§€ â€œ(unsigned) charâ€ì¸ì§€ì— ë”°ë¼ ë‹¬ë¼ì§‘ë‹ˆë‹¤.

1.	(signed) charë¥¼ intë¡œ ìºìŠ¤íŒ…í•  ê²½ìš° â‡’ ë¶€í˜¸ í™•ì¥(Sign Extension) í•„ìš”

â€¢	x86-64ì—ì„œ 8ë¹„íŠ¸ë¥¼ 32ë¹„íŠ¸ë¡œ ë¶€í˜¸ í™•ì¥í•˜ëŠ” ëª…ë ¹ì–´ëŠ” movsblì…ë‹ˆë‹¤.

â€¢	ì˜ˆ)

```plain text
movsbl  (%rdi), %eax   // ë©”ëª¨ë¦¬ì˜ 8ë¹„íŠ¸ ê°’ì„ ë¶€í˜¸ í™•ì¥í•˜ì—¬ %eax(32ë¹„íŠ¸)ì— ì €ì¥
movl    %eax,   (%rsi) // %eaxì— ìˆëŠ” 32ë¹„íŠ¸ ê°’ì„ ë©”ëª¨ë¦¬ì— ì €ì¥
```

2.	(unsigned) charë¥¼ intë¡œ ìºìŠ¤íŒ…í•  ê²½ìš° â‡’ ë¬´ë¶€í˜¸ í™•ì¥(Zero Extension) í•„ìš”

â€¢	x86-64ì—ì„œ 8ë¹„íŠ¸ë¥¼ 32ë¹„íŠ¸ë¡œ ë¬´ë¶€í˜¸ í™•ì¥í•˜ëŠ” ëª…ë ¹ì–´ëŠ” movzblì…ë‹ˆë‹¤.

â€¢	ì˜ˆ)

```plain text
movzbl  (%rdi), %eax   // ë©”ëª¨ë¦¬ì˜ 8ë¹„íŠ¸ë¥¼ ë¬´ë¶€í˜¸ í™•ì¥í•˜ì—¬ %eax(32ë¹„íŠ¸)ì— ì €ì¥
movl    %eax,   (%rsi) // %eaxì— ìˆëŠ” 32ë¹„íŠ¸ ê°’ì„ ë©”ëª¨ë¦¬ì— ì €ì¥
```

ì—¬ê¸°ì„œ %eaxëŠ” ë ˆì§€ìŠ¤í„° %raxì˜ í•˜ìœ„ 32ë¹„íŠ¸ êµ¬ì—­ì´ë¯€ë¡œ, ê²°ê³¼ì ìœ¼ë¡œ **32ë¹„íŠ¸ ìë£Œí˜•(int)**ì— í•´ë‹¹í•˜ëŠ” ê°’ì´ %eaxì— ë“¤ì–´ê°€ê²Œ ë˜ê³ , ì´ë¥¼ ê·¸ëŒ€ë¡œ movlì„ í†µí•´ ë©”ëª¨ë¦¬ì— ì¨ì£¼ë©´ ë©ë‹ˆë‹¤.

3. ì •ë¦¬

â€¢	â€œchar â†’ intâ€ë¡œ ë³µì‚¬í•  ë•Œ ë‹¨ìˆœ movb â†’ movl ì¡°í•©ì´ ì•„ë‹ˆë¼, ë°˜ë“œì‹œ ë¶€í˜¸(ë˜ëŠ” ë¬´ë¶€í˜¸) í™•ì¥ ëª…ë ¹ì–´ë¥¼ ì¨ì•¼ í•©ë‹ˆë‹¤.

â€¢	ë”°ë¼ì„œ, í‘œì— ë“¤ì–´ê°ˆ ë‘ ì¤„ì€ ë‹¤ìŒê³¼ ê°™ì´ ì‘ì„±í•˜ëŠ” ê²ƒì´ ì¼ë°˜ì ì…ë‹ˆë‹¤.

```c
// (signed) char -> intì˜ ê²½ìš°
1) Instruction1: movsbl (%rdi), %eax   // 8ë¹„íŠ¸ë¥¼ 32ë¹„íŠ¸ë¡œ 'ë¶€í˜¸ í™•ì¥'
   Instruction2: movl   %eax,   (%rsi) // 32ë¹„íŠ¸ ê°’ì„ ë©”ëª¨ë¦¬ì— ì €ì¥

// (unsigned) char -> intì˜ ê²½ìš°
1) Instruction1: movzbl (%rdi), %eax   // 8ë¹„íŠ¸ë¥¼ 32ë¹„íŠ¸ë¡œ 'ë¬´ë¶€í˜¸ í™•ì¥'
   Instruction2: movl   %eax,   (%rsi) // 32ë¹„íŠ¸ ê°’ì„ ë©”ëª¨ë¦¬ì— ì €ì¥
```

ì´ì™€ ê°™ì€ íŒ¨í„´ì´ x86-64 System V ABI í•˜ì—ì„œ C ì–¸ì–´ì˜ ìºìŠ¤íŒ… ê·œì¹™(ë¶€í˜¸ í™•ì¥, ë¬´ë¶€í˜¸ í™•ì¥)ì— ë§ëŠ” ì •ì„ì ì¸ êµ¬í˜„ì…ë‹ˆë‹¤.

> ê²°ë¡ ì ìœ¼ë¡œ â€œmovb (%rdi), %al / movl %al, (%rsi)â€ì™€ ê°™ì€ ë‹¨ìˆœ ëª…ë ¹ì–´ ì¡°í•©ì€

> 1.	í™•ì¥ ì²˜ë¦¬ë¥¼ ëˆ„ë½í•˜ê³ 

> 2.	AT&T ë¬¸ë²•ì—ì„œ ì˜ ë§ì§€ ì•ŠëŠ” êµ¬ë¬¸

> ì´ë¯€ë¡œ, ì˜¬ë°”ë¥¸ ì½”ë“œëŠ”

### ì˜ë¬¸: charì— ë¶€í˜¸ê°€ ìˆë‹¤ëŠ” ë§ì€ ë¬´ìŠ¨ ì˜ë¯¸ì¸ê°€

C ì–¸ì–´ì—ì„œ char íƒ€ì…ì€ â€œì‘ì€ ì •ìˆ˜í˜•â€ìœ¼ë¡œ ì·¨ê¸‰ë©ë‹ˆë‹¤. ê·¸ëŸ°ë° C í‘œì¤€ìƒ charê°€ ë°˜ë“œì‹œ ë¶€í˜¸ë¥¼ ê°–ëŠ”(signed)ì§€, í˜¹ì€ ë¶€í˜¸ ì—†ëŠ”(unsigned)ì§€ëŠ” êµ¬í˜„(ì»´íŒŒì¼ëŸ¬)ë§ˆë‹¤ ë‹¬ë¼ì§ˆ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì¦‰,

â€¢	signed char: 8ë¹„íŠ¸ ì •ìˆ˜ë¡œì„œ -128 ~ +127 ë²”ìœ„ë¥¼ í‘œí˜„

â€¢	unsigned char: 8ë¹„íŠ¸ ì •ìˆ˜ë¡œì„œ 0 ~ 255 ë²”ìœ„ë¥¼ í‘œí˜„

ì„ ì˜ë¯¸í•©ë‹ˆë‹¤.

ì»´íŒŒì¼ëŸ¬ ì˜µì…˜ì— ë”°ë¼ charê°€ ê¸°ë³¸ì ìœ¼ë¡œ signedê°€ ë˜ê¸°ë„, unsignedê°€ ë˜ê¸°ë„ í•©ë‹ˆë‹¤. ë”°ë¼ì„œ ì–´ë–¤ ì»´íŒŒì¼ëŸ¬ì—ì„œëŠ” charê°€ signed charì²˜ëŸ¼ -128 ~ +127 ë²”ìœ„ë¥¼, ë‹¤ë¥¸ ì»´íŒŒì¼ëŸ¬ì—ì„œëŠ” unsigned charì²˜ëŸ¼ 0 ~ 255 ë²”ìœ„ë¥¼ ê°€ì§€ë„ë¡ êµ¬í˜„ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

> â€œcharì— ë¶€í˜¸ê°€ ìˆë‹¤â€ëŠ” ë§ì€,

### ì˜ë¬¸: charëŠ” ë¬¸ì í•˜ë‚˜ë¥¼ í‘œí˜„í•˜ëŠ”ë°, ì´ ë¬¸ìë„ 2ì˜ ë³´ìˆ˜ë²•ìœ¼ë¡œ í‘œí˜„ë˜ê¸° ë•Œë¬¸ì—, ë¶€í˜¸ í™•ì¥ì´ í•„ìš”í•  ìˆ˜ë„ ìˆë‹¤, ì´ë§ì¸ê°€?

ë„¤, ë§ìŠµë‹ˆë‹¤. C ì–¸ì–´ì—ì„œ char ìë£Œí˜•ì€ â€œë¬¸ì í•œ ê°œâ€ë¥¼ í‘œí˜„í•˜ê¸° ìœ„í•´ ì‚¬ìš©í•˜ì§€ë§Œ, ì‹¤ì œë¡œëŠ” ê·¸ ë‚´ë¶€ í‘œí˜„ì´ 8ë¹„íŠ¸ ì •ìˆ˜ í˜•íƒœ(ì´ì§„ìˆ˜)ì…ë‹ˆë‹¤. ê·¸ë¦¬ê³  ì»´íŒŒì¼ëŸ¬ë‚˜ ì‹œìŠ¤í…œ ì„¤ì •ì— ë”°ë¼ charê°€ signed í˜¹ì€ unsigned ì •ìˆ˜ë¡œ ì·¨ê¸‰ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

â€¢	(signed) charì¸ ê²½ìš°

â€¢	ë‚´ë¶€ í‘œí˜„ì´ 2ì˜ ë³´ìˆ˜ë²•(twoâ€™s complement)ì„ ì‚¬ìš©í•˜ì—¬ -128 ~ +127 ì‚¬ì´ì˜ ê°’ì„ í‘œí˜„í•©ë‹ˆë‹¤.

â€¢	8ë¹„íŠ¸ë¥¼ 32ë¹„íŠ¸ ë“± ë” í° ì •ìˆ˜ë¡œ ë³€í™˜í•  ë•Œ, **ë¶€í˜¸ í™•ì¥(sign extension)**ì´ í•„ìš”í•©ë‹ˆë‹¤.

â€¢	(unsigned) charì¸ ê²½ìš°

â€¢	0 ~ 255 ì‚¬ì´ì˜ ê°’ì„ í‘œí˜„í•˜ëŠ” ë¬´ë¶€í˜¸ 8ë¹„íŠ¸ ì •ìˆ˜ì…ë‹ˆë‹¤.

â€¢	ë” í° ì •ìˆ˜ë¡œ ë³€í™˜í•  ë•ŒëŠ” **ë¬´ë¶€í˜¸ í™•ì¥(zero extension)**ì„ í•©ë‹ˆë‹¤.

ë”°ë¼ì„œ charë¥¼ ìƒìœ„ ì •ìˆ˜í˜•ìœ¼ë¡œ ìºìŠ¤íŒ…í•  ë•Œ, â€œ2ì˜ ë³´ìˆ˜ë²•ì„ ê¸°ë°˜ìœ¼ë¡œ ìŒìˆ˜ê°€ ì €ì¥ë˜ì–´ ìˆì„ ìˆ˜ë„ ìˆë‹¤â€ëŠ” ì  ë•Œë¬¸ì— ë¶€í˜¸ í™•ì¥ì´ í•„ìš”í•  ìˆ˜ ìˆë‹¤ëŠ” ëœ»ì…ë‹ˆë‹¤.

### í”¼ë“œë°±: 6ë²ˆ í’€ì´ì— ëŒ€í•œ ì •ì •

ì¼ë°˜ì ì¸ x86-64 í™˜ê²½ì—ì„œ â€œ8ë¹„íŠ¸ char â†’ 16ë¹„íŠ¸ shortâ€ ë³€í™˜ì€ **ë¶€í˜¸ í™•ì¥(sign extension)**ì„ í†µí•´ ì´ë£¨ì–´ì§‘ë‹ˆë‹¤. ë‹¤ë§Œ, ì£¼ì˜í•´ì•¼ í•  ì ì€ movsbw ëª…ë ¹ì–´ì˜ ì‚¬ìš© ë°©ì‹ì…ë‹ˆë‹¤.

1. ì™œ movb (%rdi), %al; movsbw %al, (%rsi)ëŠ” ë¬¸ì œê°€ ë ê¹Œ?

```plain text
movb   (%rdi), %al
movsbw %al,    (%rsi)   // â† ì´ë ‡ê²Œ ë°”ë¡œ ë©”ëª¨ë¦¬ì— ì“°ëŠ” í˜•íƒœ
```

â€¢	movsbw(AT&T í‘œê¸°) ë˜ëŠ” MOVSX r16, r/m8(Intel í‘œê¸°)ëŠ” 8ë¹„íŠ¸ ê°’ì„ ë°›ì•„ì„œ 16ë¹„íŠ¸ ë ˆì§€ìŠ¤í„°ë¡œ ë¶€í˜¸ í™•ì¥í•´ ì£¼ëŠ” ëª…ë ¹ì–´ì…ë‹ˆë‹¤.

â€¢	ì¦‰, ëª©ì ì§€(DEST)ëŠ” ë°˜ë“œì‹œ ë ˆì§€ìŠ¤í„°ì—¬ì•¼ í•˜ë©°, ë©”ëª¨ë¦¬ì— ì§ì ‘ ì“°ëŠ” í˜•íƒœ(movsbw %al, (%rsi))ëŠ” ìœ íš¨í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.

2. ì˜¬ë°”ë¥¸ ë°©ë²• 1: â€œë©”ëª¨ë¦¬ â†’ ë ˆì§€ìŠ¤í„° í™•ì¥ â†’ ë©”ëª¨ë¦¬â€

ë‘ ê°€ì§€ ëŒ€í‘œì ì¸ ë°©ë²•ì´ ìˆìŠµë‹ˆë‹¤.

(A) 2ë‹¨ê³„ ë°©ì‹ â€” ë°”ë¡œ ë©”ëª¨ë¦¬ì—ì„œ 16ë¹„íŠ¸ ë ˆì§€ìŠ¤í„°ë¡œ í™•ì¥í•œ ë’¤ ì €ì¥

```plain text
movsbw (%rdi), %ax    // ë©”ëª¨ë¦¬ì˜ char(8ë¹„íŠ¸)ë¥¼ %ax(16ë¹„íŠ¸)ë¡œ ë¶€í˜¸ í™•ì¥
movw   %ax,     (%rsi) // %ax(16ë¹„íŠ¸)ë¥¼ ë©”ëª¨ë¦¬ì— ì €ì¥ (short)
```

â€¢	ì²« ë²ˆì§¸ ëª…ë ¹ì–´ê°€ ë©”ëª¨ë¦¬ì˜ 8ë¹„íŠ¸ë¥¼ ì½ì–´ì˜¤ë©´ì„œ ê³§ë°”ë¡œ 16ë¹„íŠ¸ë¡œ ë¶€í˜¸ í™•ì¥í•´ %axì— ì €ì¥í•©ë‹ˆë‹¤.

â€¢	ë‘ ë²ˆì§¸ ëª…ë ¹ì–´ëŠ” %axë¥¼ ë©”ëª¨ë¦¬ì— short í¬ê¸°ë¡œ ì”ë‹ˆë‹¤.

(B) 2ë‹¨ê³„ ë°©ì‹ â€” 8ë¹„íŠ¸ë¥¼ 32ë¹„íŠ¸ë¡œ í™•ì¥ í›„, í•˜ìœ„ 16ë¹„íŠ¸ë§Œ ì €ì¥

```plain text
movsbl (%rdi), %eax   // ë©”ëª¨ë¦¬ì˜ char(8ë¹„íŠ¸)ë¥¼ 32ë¹„íŠ¸ë¡œ ë¶€í˜¸ í™•ì¥ (%eax)
movw   %ax,     (%rsi) // %ax (í•˜ìœ„ 16ë¹„íŠ¸)ë¥¼ ë©”ëª¨ë¦¬ì— ì €ì¥
```

â€¢	ì´ ë°©ë²•ë„ ë‚´ë¶€ì ìœ¼ë¡œëŠ” 8ë¹„íŠ¸ â†’ 32ë¹„íŠ¸ í™•ì¥ì„ í•œ ë’¤, ìµœì¢…ì ìœ¼ë¡œ %ax(í•˜ìœ„ 16ë¹„íŠ¸ ë¶€ë¶„)ë§Œ ë©”ëª¨ë¦¬ì— ì €ì¥í•©ë‹ˆë‹¤.

â€¢	ê²°ê³¼ì ìœ¼ë¡œ 16ë¹„íŠ¸(short) ì €ì¥ê³¼ ë™ì¼í•œ íš¨ê³¼ë¥¼ ëƒ…ë‹ˆë‹¤.

3. ì •ë¦¬

â€¢	â€œcharì—ì„œ shortë¡œâ€ ìºìŠ¤íŒ…í•  ë•ŒëŠ” ë¶€í˜¸ í™•ì¥(signed charì¼ ê²½ìš°)ì´ í•„ìš”í•©ë‹ˆë‹¤.

â€¢	x86-64ì—ì„œ ì´ë¥¼ êµ¬í˜„í•˜ë ¤ë©´ ë©”ëª¨ë¦¬ â†’ ë ˆì§€ìŠ¤í„° (í™•ì¥ í¬í•¨) â†’ ë©”ëª¨ë¦¬ ìˆœìœ¼ë¡œ ì²˜ë¦¬í•´ì•¼ í•˜ë©°,

â€¢	ëª©ì ì§€ê°€ ë©”ëª¨ë¦¬ì¸ ìƒíƒœë¡œ â€œmovsbw %al, (%rsi)â€ì²˜ëŸ¼ ì§ì ‘ í™•ì¥Â·ì €ì¥ì€ ë¶ˆê°€ëŠ¥í•©ë‹ˆë‹¤(ëª©ì ì§€ê°€ ë ˆì§€ìŠ¤í„°ì—¬ì•¼ í•¨).

ë”°ë¼ì„œ ê°€ì¥ ê°„ë‹¨í•œ í˜•íƒœëŠ” ì•„ë˜ ë‘ ì¤„ ì¤‘ í•˜ë‚˜ë¥¼ ì“°ëŠ” ê²ƒì…ë‹ˆë‹¤:

```plain text
movsbw (%rdi), %ax
movw   %ax,     (%rsi)
```

ë˜ëŠ”

```plain text
movsbl (%rdi), %eax
movw   %ax,     (%rsi)
```

ì´ ë°©ì‹ì´ 8ë¹„íŠ¸ â†’ 16ë¹„íŠ¸ í™•ì¥ì„ ì˜¬ë°”ë¥´ê²Œ ìˆ˜í–‰í•œ ë’¤ ë©”ëª¨ë¦¬ì— ì €ì¥í•˜ëŠ” â€œì •ë‹µâ€ì´ ë©ë‹ˆë‹¤.

### ì§ˆë¬¸: ì–´ì°¨í”¼ low portionë§Œ ìµœì†Œí•œìœ¼ë¡œ ë§ì¶”ë©´ ë˜ê¸° ë•Œë¬¸ì— ì—¬ëŸ¬ ì—°ì‚°ì— ëŒ€í•œ ì—¬ëŸ¬ ì¸ìŠ¤íŠ¸ëŸ­ì…˜ ì‚¬ìš©ì´ ê°€ëŠ¥í•œê°€?

ë„¤, ë§ìŠµë‹ˆë‹¤.

1.	ëª©ì ì§€ê°€ ë ˆì§€ìŠ¤í„°ì—¬ì•¼ í™•ì¥ ëª…ë ¹ì„ ì“¸ ìˆ˜ ìˆë‹¤ëŠ” ê²ƒì´ í•µì‹¬ì…ë‹ˆë‹¤. ê·¸ë˜ì„œ

â€¢	movsbw (%rdi), %ax

â€¢	movw %ax, (%rsi)

ì´ëŸ° ì‹ìœ¼ë¡œ 8ë¹„íŠ¸ â†’ 16ë¹„íŠ¸ ë¶€í˜¸ í™•ì¥ í›„ %axë¥¼ ë©”ëª¨ë¦¬ì— ì €ì¥í•´ì•¼ í•©ë‹ˆë‹¤.

2.	movsbl (%rdi), %eax ë¡œ 8ë¹„íŠ¸ ê°’ì„ ë¨¼ì € 32ë¹„íŠ¸ë¡œ í™•ì¥í•œ ë’¤, %axì˜ 16ë¹„íŠ¸ ë¶€ë¶„ë§Œ ë©”ëª¨ë¦¬ì— ì €ì¥(movw %ax, (%rsi))í•˜ëŠ” ë°©ì‹ë„ ê°™ì€ ê²°ê³¼ë¥¼ ì–»ìŠµë‹ˆë‹¤.

ì¦‰, í•˜ìœ„ 8ë¹„íŠ¸(=char)ë¥¼ í•˜ìœ„ 16ë¹„íŠ¸(=short)ë¡œ ì˜®ê¸¸ ë•ŒëŠ”,

â€¢	ë©”ëª¨ë¦¬ â†’ í™•ì¥(ì–´ë–¤ í¬ê¸°ë¡œë“ ) â†’ ëª©ì ì§€ í¬ê¸°ë§Œí¼ ë©”ëª¨ë¦¬ì— ì €ì¥

ì˜ ê³¼ì •ì„ ê±°ì¹˜ë©´ ë˜ë©°, ì¤‘ê°„ì— ì–´ë–»ê²Œ í™•ì¥í•˜ë“ (16ë¹„íŠ¸ë“  32ë¹„íŠ¸ë“ ) ê²°ê³¼ì˜ í•˜ìœ„ 16ë¹„íŠ¸ë§Œ ì“´ë‹¤ëŠ” ì ì´ ë³€í•¨ì—†ê¸° ë•Œë¬¸ì— ë‹¤ì–‘í•œ ì¡°í•©ì´ ê°€ëŠ¥í•˜ë‹¤ëŠ” ëœ»ì…ë‹ˆë‹¤.

## Practice 3.5

### ë¬¸ì œ

ì•„ë˜ ì–´ì…ˆë¸”ë¦¬ ì½”ë“œì— ìƒì‘í•˜ëŠ” cì½”ë“œë¥¼ ì‘ì„±í•´ë³´ê¸°

void decode1(long *xp, long *yp, long *zp)

xp in %rdi, yp in %rsi, zp in %rdx

```c
decode1:
	movq (%rdi), %r8
	movq (%rsi), %rcx
	movq (%rdx), %rax
	movq %r8, (%rsi)
	movq %rcx, (%rdx)
	movq %rax, (%rdi)
	ret
```

### ì •ë‹µ

```c
void decode1(long *xp, long *yp, long *zp) {
	x = *xp
	y = *yp
	z = *zp
	*yp = x
	*zp = y
	*xp = z
	return z
}
```

### í’€ì´

![](./images/image.png)

### í”¼ë“œë°±

ë¨¼ì € ì£¼ì–´ì§„ ì–´ì…ˆë¸”ë¦¬ë¥¼ ë‹¨ê³„ë³„ë¡œ í•´ì„í•´ ë³´ê² ìŠµë‹ˆë‹¤.

(ë ˆì§€ìŠ¤í„° ëŒ€ì‘: xp -> %rdi, yp -> %rsi, zp -> %rdx)

```plain text
decode1:
    movq (%rdi), %r8   // *xpë¥¼ ì½ì–´ r8ì— ì €ì¥
    movq (%rsi), %rcx  // *ypë¥¼ ì½ì–´ rcxì— ì €ì¥
    movq (%rdx), %rax  // *zpë¥¼ ì½ì–´ raxì— ì €ì¥
    movq %r8, (%rsi)   // r8(ì›ë˜ xpì˜ ê°’)ì„ *ypì— ì €ì¥
    movq %rcx, (%rdx)  // rcx(ì›ë˜ ypì˜ ê°’)ì„ *zpì— ì €ì¥
    movq %rax, (%rdi)  // rax(ì›ë˜ zpì˜ ê°’)ì„ *xpì— ì €ì¥
    ret
```

ê²°ê³¼ì ìœ¼ë¡œ,

â€¢	xpì— ìˆë˜ ê°’ â†’ ypê°€ ê°€ë¦¬í‚¤ëŠ” ë©”ëª¨ë¦¬

â€¢	ypì— ìˆë˜ ê°’ â†’ zpê°€ ê°€ë¦¬í‚¤ëŠ” ë©”ëª¨ë¦¬

â€¢	zpì— ìˆë˜ ê°’ â†’ xpê°€ ê°€ë¦¬í‚¤ëŠ” ë©”ëª¨ë¦¬

ë¡œ ì˜®ê¸°ëŠ” â€œ3ê°œ ë³€ìˆ˜ì˜ cyclic shiftâ€ ì‘ì—…ì„ ìˆ˜í–‰í•©ë‹ˆë‹¤.

C ì½”ë“œë¡œ ì˜®ê¸°ë©´?

í•¨ìˆ˜ ì›í˜•ì´ void decode1(long *xp, long *yp, long *zp) ì´ë¯€ë¡œ ë°˜í™˜ê°’ì€ ì—†ìŠµë‹ˆë‹¤(void).

ì¤‘ê°„ ì„ì‹œ ë³€ìˆ˜ ì„¸ ê°œ(x, y, z)ë¥¼ ì‚¬ìš©í•´ì„œ ë‹¤ìŒê³¼ ê°™ì´ ì‘ì„±í•˜ë©´ ë©ë‹ˆë‹¤.

```c
void decode1(long *xp, long *yp, long *zp) {
    long x = *xp;   // 1) xpê°€ ê°€ë¦¬í‚¤ëŠ” ê°’ì„ xì— ì €ì¥
    long y = *yp;   // 2) ypê°€ ê°€ë¦¬í‚¤ëŠ” ê°’ì„ yì— ì €ì¥
    long z = *zp;   // 3) zpê°€ ê°€ë¦¬í‚¤ëŠ” ê°’ì„ zì— ì €ì¥

    *yp = x;        // 4) ypê°€ ê°€ë¦¬í‚¤ëŠ” ë©”ëª¨ë¦¬ì— x ì €ì¥
    *zp = y;        // 5) zpê°€ ê°€ë¦¬í‚¤ëŠ” ë©”ëª¨ë¦¬ì— y ì €ì¥
    *xp = z;        // 6) xpê°€ ê°€ë¦¬í‚¤ëŠ” ë©”ëª¨ë¦¬ì— z ì €ì¥
}
```

í•¨ìˆ˜ ì‹œê·¸ë‹ˆì²˜ê°€ voidì´ë¯€ë¡œ, return z; ê°™ì€ ë³„ë„ì˜ ë°˜í™˜ êµ¬ë¬¸ì€ ì“°ì§€ ì•ŠìŠµë‹ˆë‹¤.

ì–´ì…ˆë¸”ë¦¬ ì½”ë“œ ë§ˆì§€ë§‰ì— %raxë¥¼ ë‹¤ë¥¸ ê³³ì— ì“°ê¸´ í•˜ì§€ë§Œ, x86-64 ABIì—ì„œ â€œí•¨ìˆ˜ ë°˜í™˜ê°’â€ìœ¼ë¡œ %raxë¥¼ ì“°ëŠ” ê²ƒê³¼ëŠ” ë³„ê°œë¡œ, ì—¬ê¸°ì„œëŠ” ë‹¨ìˆœíˆ *xpì— ì €ì¥í•˜ê¸° ìœ„í•œ ìš©ë„ë¡œë§Œ ì‚¬ìš©ëœ ê²ƒì…ë‹ˆë‹¤.

> ì¦‰, â€œvoid decode1ì´ë¯€ë¡œ â€˜return zâ€™ëŠ” í•„ìš” ì—†ë‹¤.â€ê°€ í•µì‹¬ í¬ì¸íŠ¸ì…ë‹ˆë‹¤.

### ì§ˆë¬¸: í•¨ìˆ˜ì—ì„œ ì²˜ìŒ ì„ ì–¸ëœ ì§€ì—­ë³€ìˆ˜ê°€ ë¬´ì¡°ê±´ %raxì¸ ê±´ê°€?

ì•„ë‹™ë‹ˆë‹¤. â€œí•¨ìˆ˜ì—ì„œ ì²˜ìŒ ì„ ì–¸ëœ ì§€ì—­ ë³€ìˆ˜ê°€ ë¬´ì¡°ê±´ %raxì— ëŒ€ì‘ëœë‹¤â€ëŠ” ê·œì¹™ì€ ì—†ìŠµë‹ˆë‹¤.

â€¢	x86-64 í˜¸ì¶œ ê·œì•½(System V ABI)ì—ì„œ ë°˜í™˜ê°’(return value)ì„ ì €ì¥í•˜ëŠ” ë ˆì§€ìŠ¤í„°ê°€ %raxì´ì§€ë§Œ,

â€¢	ë¡œì»¬ ë³€ìˆ˜ëŠ” ë°˜ë“œì‹œ íŠ¹ì • ë ˆì§€ìŠ¤í„°ì— ë§¤í•‘ëœë‹¤ëŠ” ë³´ì¥ì´ ì—†ìŠµë‹ˆë‹¤.

ì»´íŒŒì¼ëŸ¬ëŠ” ë ˆì§€ìŠ¤í„° í• ë‹¹ ìµœì í™”ë¥¼ í†µí•´ ê° ë¡œì»¬ ë³€ìˆ˜ë¥¼ ì–´ëŠ ë ˆì§€ìŠ¤í„°ì— ë‘˜ì§€(í˜¹ì€ ìŠ¤íƒì— ì €ì¥í• ì§€)ë¥¼ ê²°ì •í•˜ë©°, â€œì²˜ìŒ ì„ ì–¸ëœ ì§€ì—­ë³€ìˆ˜â€ê°€ %raxì— ë°°ì •ëœë‹¤ëŠ” ì •í•´ì§„ ê·œì¹™ì€ ì—†ìŠµë‹ˆë‹¤.

â€¢	ì—¬ëŸ¬ ê°œì˜ ì§€ì—­ ë³€ìˆ˜ê°€ ëª¨ë‘ ë ˆì§€ìŠ¤í„°ì— ë“¤ì–´ê°ˆ ìˆ˜ë„ ìˆê³ ,

â€¢	ì¼ë¶€ëŠ” ìŠ¤íƒ í”„ë ˆì„ì— ì €ì¥ë  ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤.

â€¢	ì‹¬ì§€ì–´ ì‚¬ìš© ì¤‘ê°„ì— íŠ¹ì • ë³€ìˆ˜ë§Œ ë ˆì§€ìŠ¤í„°ì— ì˜¬ë ¸ë‹¤ê°€ ë‹¤ì‹œ ìŠ¤íƒìœ¼ë¡œ ë‚´ë¦¬ê¸°ë„ í•©ë‹ˆë‹¤.

ê²°êµ­, â€œì§€ì—­ë³€ìˆ˜ê°€ ì–´ëŠ ë ˆì§€ìŠ¤í„°ì— ë“¤ì–´ê°ˆì§€â€ëŠ” ì»´íŒŒì¼ëŸ¬ì™€ ìµœì í™” ë‹¨ê³„, ìƒí™©(ì‚¬ìš© íŒ¨í„´, ìµœì í™” ì˜µì…˜ ë“±)ì— ë”°ë¼ ë‹¬ë¼ì§€ë©°, â€œì²˜ìŒ ì„ ì–¸ëœ ë³€ìˆ˜ â†’ %raxâ€ ê°™ì€ ë‹¨ìˆœ ê·œì¹™ì€ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.

## Pushing and Popping Stack Data

### í•˜ë‚˜ë§Œ ê¸°ì–µí•˜ê¸°! ë ˆì§€ìŠ¤í„°ì—ì„œ ì£¼ì†Œë¥¼ ê°€ë¦¬í‚¤ëŠ” ê°’ë“¤ì€ ë°”ì´íŠ¸ë¥¼ ìµœì†Œ ë‹¨ìœ„ë¡œ ê°€ì§„ë‹¤!

### ì˜ë¬¸: ì™œ ì¿¼ë“œ ì›Œë“œì—ì„œ ìŠ¤íƒì— push/pop ì—°ì‚°í•  ë•Œ ì¦‰ì‹œê°’ 8ì„ ë”í•˜ê³  ë¹¼ë©´ ë˜ëŠ”ê°€?

x86-64 í™˜ê²½ì—ì„œ â€œì¿¼ë“œ ì›Œë“œ(quad word)â€ëŠ” 64ë¹„íŠ¸(8ë°”ì´íŠ¸) í¬ê¸°ë¥¼ ì˜ë¯¸í•©ë‹ˆë‹¤. ìŠ¤íƒ í¬ì¸í„°(%rsp)ëŠ” 8ë°”ì´íŠ¸ ë‹¨ìœ„ë¡œ ê´€ë¦¬ë˜ëŠ”ë°, pushë‚˜ pop ëª…ë ¹ì–´ë¥¼ ì‚¬ìš©í•  ë•Œë§ˆë‹¤ ìŠ¤íƒ í¬ì¸í„°ê°€ 8ë°”ì´íŠ¸ì”© ì´ë™í•˜ëŠ” ì´ìœ ê°€ ë°”ë¡œ ì´ê²ƒì…ë‹ˆë‹¤.

â€¢	push ì—°ì‚°:

1.	%rspë¥¼ 8ë§Œí¼ ê°ì†Œ(sub)

2.	ê°ì†Œëœ ì£¼ì†Œì— 8ë°”ì´íŠ¸(ì¿¼ë“œ ì›Œë“œ) ë°ì´í„°ë¥¼ ì €ì¥

â€¢	pop ì—°ì‚°:

1.	8ë°”ì´íŠ¸(ì¿¼ë“œ ì›Œë“œ) ë°ì´í„°ë¥¼ %rspê°€ ê°€ë¦¬í‚¤ëŠ” ê³³ì—ì„œ ì½ì–´ì˜´

2.	%rspë¥¼ 8ë§Œí¼ ì¦ê°€(add)

ë”°ë¼ì„œ, ìŠ¤íƒì—ì„œ 64ë¹„íŠ¸(ì¿¼ë“œ ì›Œë“œ) ë‹¨ìœ„ë¥¼ ë‹¤ë£° ë•ŒëŠ” ì¦‰ì‹œê°’ 8ì„ ë”í•˜ê±°ë‚˜ ë¹¼ì„œ %rspë¥¼ ì¡°ì •í•˜ê²Œ ë©ë‹ˆë‹¤. C ì–¸ì–´ì˜ long(ë¦¬ëˆ…ìŠ¤ x86-64 ê¸°ì¤€)ë„ ê¸°ë³¸ì ìœ¼ë¡œ 8ë°”ì´íŠ¸(64ë¹„íŠ¸)ì´ê¸° ë•Œë¬¸ì—, ìŠ¤íƒì— long ë³€ìˆ˜ë¥¼ í• ë‹¹í•˜ê±°ë‚˜ ìŠ¤íƒì—ì„œ êº¼ë‚¼ ë•Œë„ ë§ˆì°¬ê°€ì§€ë¡œ 8ë°”ì´íŠ¸ë§Œí¼ ìŠ¤íƒ í¬ì¸í„°ê°€ ì´ë™í•˜ê²Œ ë©ë‹ˆë‹¤.

### ì˜ë¬¸: ê·¸ëŸ¼ ë ˆì§€ìŠ¤í„°ì—ì„œ ì£¼ì†Œë¥¼ ê°€ë¦¬í‚¤ëŠ” ê°’ë“¤ì€ ë°”ì´íŠ¸ë¥¼ ìµœì†Œ ë‹¨ìœ„ë¡œ ê°€ì§€ëŠ” ê±°ì•¼?

ë„¤, ê·¸ë ‡ìŠµë‹ˆë‹¤.

â€¢	x86-64 ì•„í‚¤í…ì²˜ì—ì„œ ë ˆì§€ìŠ¤í„°(ì˜ˆ: %rsp, %rbp, %rdi ë“±)ì— ë“¤ì–´ ìˆëŠ” ì£¼ì†Œ(í¬ì¸í„°) ê°’ì€ ë©”ëª¨ë¦¬ì—ì„œ â€œë°”ì´íŠ¸(byte)â€ ë‹¨ìœ„ë¡œ ì¸ë±ì‹±ë©ë‹ˆë‹¤.

â€¢	ì¦‰, ì£¼ì†Œë¥¼ 1 ì¦ê°€ì‹œí‚¤ë©´ ì‹¤ì œë¡œëŠ” ë‹¤ìŒ ë°”ì´íŠ¸ì˜ ë©”ëª¨ë¦¬ ì£¼ì†Œë¡œ ì´ë™í•˜ëŠ” ê²ƒì´ê³ ,

â€¢	8ì„ ë”í•˜ë©´ 8ë°”ì´íŠ¸(1ì¿¼ë“œ ì›Œë“œ) ë’¤ì˜ ë©”ëª¨ë¦¬ ì£¼ì†Œê°€ ë©ë‹ˆë‹¤.

ìŠ¤íƒ ê´€ë ¨ ì˜ˆì‹œë¡œ, push/popì´ 8ì”© %rspë¥¼ ì¡°ì •í•˜ëŠ” ì´ìœ ë„ 64ë¹„íŠ¸(8ë°”ì´íŠ¸) ë‹¨ìœ„ë¥¼ ì‚¬ìš©í•˜ê¸° ë•Œë¬¸ì…ë‹ˆë‹¤. (x86-64ì—ì„œëŠ” ìŠ¤íƒìœ¼ë¡œ ì¿¼ë“œ ì›Œë“œë¥¼ í‘¸ì‹œ/íŒ í•  ë•Œë§ˆë‹¤ 8ë°”ì´íŠ¸ ë‹¨ìœ„ë¡œ ì´ë™)

# Arithmetic and Logical Operations

## LEAì— ëŒ€í•´(Load Effective Address)

### ì˜ë¬¸:  leaq s, dëŠ” sìì²´ë¥¼ ì£¼ì†Œê°’ìœ¼ë¡œ íš¨ìœ¨ì ìœ¼ë¡œ ê³„ì‚°í•´ì„œ dì— ì €ì¥í•œë‹¤ê³  ë§í•˜ë©´ ë˜ë‚˜?

ë„¤, ê±°ì˜ ë§ìŠµë‹ˆë‹¤! ì •í™•íˆ í‘œí˜„í•˜ë©´ ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤:

âœ… leaq s, dì˜ ì˜ë¯¸:

â€¢	leaq = Load Effective Address (of s) into d

â€¢	sëŠ” ë©”ëª¨ë¦¬ ì£¼ì†Œ ê³„ì‚°ì‹(ì˜ˆ: ì˜¤í”„ì…‹ + ë² ì´ìŠ¤ + ì¸ë±ìŠ¤ * ìŠ¤ì¼€ì¼)ì´ê³ ,

ì´ ì£¼ì†Œ ìì²´ë¥¼ ê³„ì‚°í•´ì„œ ê°’ìœ¼ë¡œ dì— ì €ì¥í•©ë‹ˆë‹¤.

â€¢	ì‹¤ì œë¡œ ë©”ëª¨ë¦¬ ì ‘ê·¼ì€ í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤!

â†’ ì¦‰, leaqëŠ” ë°ì´í„°ë¥¼ â€œê°€ì ¸ì˜¤ëŠ”(load)â€ ëª…ë ¹ì´ ì•„ë‹ˆë¼, ê³„ì‚°ë§Œ í•˜ëŠ” ì‚°ìˆ  ëª…ë ¹ì–´ì— ê°€ê¹ìŠµë‹ˆë‹¤.

ì˜ˆì‹œ 1: ë‹¨ìˆœ ì£¼ì†Œ ê³„ì‚°

```plain text
leaq (%rdi), %rax
```

â€¢	%rdiê°€ ê°€ë¦¬í‚¤ëŠ” ì£¼ì†Œê°’ì„ %raxì— ê·¸ëŒ€ë¡œ ë³µì‚¬

â€¢	ì¦‰: %rax = %rdi

ì˜ˆì‹œ 2: ì˜¤í”„ì…‹ ìˆëŠ” ì£¼ì†Œ ê³„ì‚°

```plain text
leaq 8(%rsp), %rax
```

â€¢	%rax = %rsp + 8 (ì£¼ì†Œ ê³„ì‚°ë§Œ í•˜ê³ , í•´ë‹¹ ë©”ëª¨ë¦¬ë¥¼ ì½ì§€ ì•ŠìŒ)

ì˜ˆì‹œ 3: ë°°ì—´ ì¸ë±ì‹±ì²˜ëŸ¼ ì‚¬ìš©

```plain text
leaq (%rdi,%rsi,4), %rax
```

â€¢	%rax = %rdi + (%rsi * 4)

â€¢	ë°°ì—´ì˜ íŠ¹ì • ìš”ì†Œ ì£¼ì†Œë¥¼ ê³„ì‚°í•  ë•Œ ë§¤ìš° íš¨ìœ¨ì !

âœ… ì •ë¦¬

> leaq s, dëŠ”

> ë”°ë¼ì„œ

> ë‹¨,

í•„ìš”í•˜ë‹¤ë©´:

â€¢	movq s, d â†’ ì‹¤ì œë¡œ ë©”ëª¨ë¦¬ì—ì„œ ë°ì´í„°ë¥¼ ì½ì–´ì˜´

â€¢	leaq s, d â†’ ì£¼ì†Œê°’ë§Œ ê³„ì‚°í•´ì„œ ì €ì¥

ë‘˜ì„ êµ¬ë¶„í•´ ê¸°ì–µí•˜ë©´ ì¢‹ì•„ìš”!

## Practice 3.6

### ë¬¸ì œ

%rbx holds value p

%rdx holds value q

Fill in the table with formulas indicating the value that will be stored in register %rax for each of the given assembly-code instructions.

### í’€ì´

### í”¼ë“œë°±

ëª¨ë‘ ì •ë‹µ

## Practice 3.7

### ë¬¸ì œ

```c
short scale3(short x, short y, short z) {
	short t = ____;
	return t;
}
```

ì¼ë•Œ, ì•„ë˜ì™€ ê°™ì€ ì–´ì…ˆë¸”ë¦¬ ì½”ë“œê°€ ì»´íŒŒì¼ ëë‹¤ë©´ ë¹ˆì¹¸ì— ë“¤ì–´ê°ˆ c ì½”ë“œëŠ”?

```c
scale3:
	leaq (%rsi, %rsi, 9), %rbx
	leaq (%rbx, %rdx), %rbx
	leaq (%rbx, %rdi, %rsi), %rbx
	ret
```

### í’€ì´ ë° ì •ë‹µ 

![](./images/image.png)

```c
((y + y * 9) + z) + x * y
```

### ì •ë‹µ í™•ì¸

![](./images/image.png)

ì •ë‹µì€ 10 * y + z + y * xë¼ê³  í•œë‹¤. 

### ì˜ë¬¸: ì™œ 10*yê°€ (%rsi, %rsi, 9)ë¡œ í‘œí˜„ë˜ëŠ” ê±°ì§€? ê·¸ëƒ¥ (, %rsi, 10)ìœ¼ë¡œ í•˜ë©´ ë˜ì§€ ì•Šë‚˜?

ìš”ì•½: í•˜ë“œì›¨ì–´ëŠ” ìŠ¤ì¼€ì¼ ê°’ìœ¼ë¡œ 10ì„ ì§€ì›í•˜ì§€ ì•ŠìŒ!

In x86-64, the LEA (load effective address) instruction only permits scale factors of 1, 2, 4, or 8 for the index register. In other words, you canâ€™t directly do something like (%rsi, %rsi, 10) because 10 is not an allowed scale. The compiler or disassembler youâ€™re looking at is simply expressing â€œ10 Ã— rsiâ€ as (%rsi, %rsi, 9), but under the hood this typically translates to a combination of valid scale factors and/or additional additions.

A more typical approach you might see is splitting 10Ã—rsi into a sequence like â€œrsi + 8Ã—rsi + (another add)â€ or similar. The key point is that the hardware does not support 10 as a single scale factor, so the compiler/disassembler uses tricks (or multiple steps) to compute 10Ã—rsi while emitting something that looks like (%rsi, %rsi, 9).

## Practice 3.8

### í’€ì´

![](./images/IMG_B023D6B13C1A-1.jpeg)

### ë‹µì•ˆì§€

![](./images/IMG_0E53113943F9-1.jpeg)

0x100 - 0x3ì„ í¸í•˜ê²Œ ê³„ì‚°í•˜ë ¤ë©´ ì–´ë–»ê²Œ í•´ì•¼ í•˜ì§€?

ì•„ë˜ì™€ ê°™ì´ í•˜ë©´ ë¨

0x100 - 0x3
= 0x0FF + 0x1 - 0x3
= 0x0FF - 0x2
= 0xFD

ì¼ë‹¨ 1ì„ ë¹¼ì£¼ê³ , FFì— ëŒ€í•´ ì •ë¦¬í•˜ë©´ ë¨.

## Practice 3.9

### ë¬¸ì œ

ì•„ë˜ c ì½”ë“œì— ëŒ€í•œ ì–´ì…ˆë¸”ë¦¬ì–´ ì½”ë“œ ì™„ì„±í•˜ê¸° 

```c
long shift_left4_right(long x, long n)
{
	x <<= 4;
	x >>= n;
	return x;
}
```

```assembly
shift_left4_rightn:
	movq %rdi, %rax
	salq $4, %rax
	movl %esi, %ecx
	sarq %cl, %rax
```

### í’€ì´

![](./images/image.png)

ì²˜ìŒì— movì—°ì‚°ì„ ì¨ì„œ %clì— ê°’ì„ ë¡œë“œí•´ì•¼ í•˜ëŠ”ì¤„ ì•Œì•˜ëŠ”ë°, ì–´ì…ˆë¸”ë¦¬ ì½”ë“œ ë§¥ë½ìƒ ê·¸ëŸ´ í•„ìš”ëŠ” ì—†ì—ˆë‹¤. ì²« ë²ˆì§¸ ì‰¬í”„íŠ¸ ì—°ì‚°ì˜ ê²½ìš° ì¦‰ì‹œê°’ ì‰¬í”„íŠ¸í•˜ë©´ ë˜ë¯€ë¡œ ê·¸ëƒ¥ salq $4, %raxë¥¼ ìˆ˜í–‰í•˜ë©´ ë˜ê³ , ë‘ ë²ˆì§¸ ì‰¬í”„íŠ¸ ì—°ì‚°ì˜ ê²½ìš° ì‰¬í”„íŠ¸ ì „ì— movl %esi, %ecx ì—°ì‚°ì„ í†µí•´ ì´ë¯¸ 32ë¹„íŠ¸ ë ˆì§€ìŠ¤í„°ì— ì‰¬í”„íŠ¸ ê°’ì„ ë¡œë“œí•˜ì—¬ í•˜ìœ„ ë¶€ë¶„ì¸ %cl ë ˆì§€ìŠ¤í„°ì— ì›í•˜ëŠ” ê°’ì´ ìˆëŠ” ìƒí™©ì´ë‹¤. ë”°ë¼ì„œ sarq %cl, %raxë¡œ ì¶©ë¶„í•˜ë‹¤.

### ì˜ë¬¸: %cl ë ˆì§€ìŠ¤í„°ëŠ” 8ë¹„íŠ¸ ë ˆì§€ìŠ¤í„°ì„ì—ë„ sarq ì—°ì‚°ìë¥¼ ì“°ë©´ ë˜ëŠ” ê±´ê°€?

x86-64 ì–´ì…ˆë¸”ë¦¬ì—ì„œ sarqëŠ” 64ë¹„íŠ¸(â€˜quad wordâ€™) í¬ê¸°ì˜ ì˜¤í¼ë Œë“œì— ëŒ€í•´ ì‚°ìˆ ì  ì˜¤ë¥¸ìª½ ì‹œí”„íŠ¸ë¥¼ ìˆ˜í–‰í•˜ëŠ” ëª…ë ¹ì–´ì…ë‹ˆë‹¤. ì—¬ê¸°ì„œ â€œqâ€ ì ‘ë¯¸ì‚¬ëŠ” Shift ëŒ€ìƒì´ 64ë¹„íŠ¸ ë ˆì§€ìŠ¤í„°(RAX, RBX, RCX, RDX ë“±)ë¥¼ ì˜ë¯¸í•©ë‹ˆë‹¤. ë°˜ë©´, ì‹¤ì œ ì‹œí”„íŠ¸ ì–‘(shift count)ì„ ì§€ì •í•˜ëŠ” ë ˆì§€ìŠ¤í„°ê°€ %cl(8ë¹„íŠ¸)ì¸ ê²ƒì€ ì •ìƒì ì¸ ë™ì‘ì…ë‹ˆë‹¤.

ì¦‰,

â€¢	sarq %cl, %rdx ì™€ ê°™ì´ ì“°ë©´, 64ë¹„íŠ¸ ë ˆì§€ìŠ¤í„° %rdxë¥¼ %cl(8ë¹„íŠ¸)ì— ë‹´ê¸´ ê°’ë§Œí¼ ì‚°ìˆ ì  ì˜¤ë¥¸ìª½ ì‹œí”„íŠ¸í•˜ê² ë‹¤ëŠ” ì˜ë¯¸ì…ë‹ˆë‹¤.

â€¢	ì´ë•Œ 8ë¹„íŠ¸ì¸ %cl ë ˆì§€ìŠ¤í„°ì—ì„œ í•„ìš”í•œ ë§Œí¼(í•˜ìœ„ 5ë¹„íŠ¸~6ë¹„íŠ¸ ì •ë„)ë§Œ ì‹¤ì œ ì‹œí”„íŠ¸ í¬ê¸°ë¡œ ì‚¬ìš©í•©ë‹ˆë‹¤. (64ë¹„íŠ¸ ì´ìƒ ì‹œí”„íŠ¸ ìš”ì²­ ì‹œì—ë„ í•˜ìœ„ ëª‡ ë¹„íŠ¸ë§Œ ì ìš©ë©ë‹ˆë‹¤.)

ë”°ë¼ì„œ %clì€ 8ë¹„íŠ¸ ë ˆì§€ìŠ¤í„°ì„ì—ë„, sarq ëª…ë ¹ì–´ì—ì„œ ì‹œí”„íŠ¸ ì¹´ìš´íŠ¸ë¥¼ ì „ë‹¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ëŠ” ì–´ì…ˆë¸”ë¦¬ì—ì„œ ì˜¤ë«ë™ì•ˆ ì¨ì˜¨ í‘œì¤€ ê·œì•½ìœ¼ë¡œ, ë³„ë‹¤ë¥¸ ë¬¸ì œ ì—†ì´ ì •ìƒì ìœ¼ë¡œ ë™ì‘í•©ë‹ˆë‹¤.

## Practice 3.10

### ë¬¸ì œ

ì–´ì…ˆë¸”ë¦¬ ì½”ë“œë¥¼ ë³´ê³  c í”„ë¡œê·¸ë¨ ì½”ë“œ ìœ ì¶”í•˜ê¸°

ì¡°ê±´

short arith3(short x, short y, short z)

x in %rdi, y in %rsi, z in %rdx

```assembly
arith3:
	orq %rsi, %rdx
	sarq $9, %rdx
	notq %rdx
	movq %rdx, %bax
	subq %rsi, %rbx
	ret
```

```c
short arith3(short x, short y, short z)
{
	short p1 = y | z
	short p2 = p1 >> 9
	short p3 = ~p2
	short p4 = y - p3
	return p4
}
```

### í’€ì´

![](./images/image.png)

ì–´ì…ˆë¸”ë¦¬ ì½”ë“œì˜ ìµœì í™”ë¥¼ ìƒê°í•˜ì§€ ëª»í•œ í’€ì´

![](./images/image.png)

### ì˜ë¬¸: ëŒ€ì²´ ì™œ  movq %rdx, %bax /  subq %rsi, %rbx ì´ê²Œ  short p4 = y - p3ì¸ì§€ ëª¨ë¥´ê² ë‹¤. 

ë¬¸ì œ ì˜¤ë¥˜! 

ë¬¸ì œê°€ ë˜ëŠ” ë¶€ë¶„ì€ **subq %rsi, %rbx**ì…ë‹ˆë‹¤.

â€¢	ì¼ë°˜ì ì¸ x86-64 í•¨ìˆ˜ ë°˜í™˜ ê·œì•½ì—ì„œëŠ” **ë°˜í™˜ê°’ì´ ë°˜ë“œì‹œ %rax**ì— ìˆì–´ì•¼ í•©ë‹ˆë‹¤.

â€¢	%rbxëŠ” â€œcallee-saved registerâ€ë¡œ, í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•˜ëŠ” ìª½(Caller)ì´ ì•„ë‹ˆë¼ í•¨ìˆ˜(ìˆ˜ì‹ ì, Callee) ìª½ì—ì„œ í•¨ë¶€ë¡œ ë§ê°€ëœ¨ë¦¬ì§€ ì•Šê³  ë³µì›í•´ì£¼ì–´ì•¼ í•˜ëŠ” ë ˆì§€ìŠ¤í„°ì— í•´ë‹¹í•©ë‹ˆë‹¤.

â€¢	ì´ ì½”ë“œì—ì„œëŠ” %rbxê°€ ìµœì¢… ê²°ê³¼ì™€ ì–´ë–»ê²Œ ì—°ê²°ë˜ëŠ”ì§€, í˜¹ì€ ë‹¤ë¥¸ ìš©ë„ë¡œ ì“°ì´ëŠ”ì§€ ì „í˜€ ì•Œ ìˆ˜ê°€ ì—†ìŠµë‹ˆë‹¤.

ì¦‰, **â€œsubq %rsi, %rbxê°€ ì™œ y - p3ë¥¼ ì˜ë¯¸í•˜ëŠëƒ?â€**ê³  ë¬»ëŠ”ë‹¤ë©´,

â€¢	â€œì •ìƒì ì¸ ìµœì í™”ëœ ì½”ë“œâ€ë¼ë©´ subq %rsi, %rax í˜•íƒœë¡œ ë‚˜ì˜¤ëŠ” ê²ƒì´ ìì—°ìŠ¤ëŸ½ìŠµë‹ˆë‹¤(ìµœì¢… ê²°ê³¼ë¥¼ %raxì— ë‘¬ì•¼ í•˜ë‹ˆê¹Œ).

â€¢	ê·¸ëŸ°ë° ì˜ˆì‹œ ì½”ë“œì—ì„  %rbxë¥¼ ìˆ˜ì •í•˜ê³  ìˆê¸° ë•Œë¬¸ì—, ì´ ë¶€ë¶„ì´ ë‹¨ìˆœíˆ ì˜ëª» ì í˜”ê±°ë‚˜(ì˜¤íƒ€), ë˜ëŠ” í•¨ìˆ˜ ì¼ë¶€ë§Œ ì˜ë ¤ì˜¨ ì½”ë“œì¼ ê°€ëŠ¥ì„±ì´ ë†’ìŠµë‹ˆë‹¤.

### ì˜ë¬¸: ìœ„ ì½”ë“œì—ì„œ %rdxì— ë…¼ë¦¬í•©ì„ ì§‘ì–´ë„£ì–´ ë²„ë¦¬ë©´ ë§¤ê°œë³€ìˆ˜ zê°’ì´ ë®ì–´ì”Œì›Œì ¸ë²„ë¦¬ì§€ ì•Šë‚˜?

ë¨¼ì € x86-64 SysV Calling Convention(ë¦¬ëˆ…ìŠ¤, macOS ë“±)ì—ì„œ í•¨ìˆ˜ì˜ ì¸ì(ë§¤ê°œë³€ìˆ˜)ëŠ” â€œí˜¸ì¶œ ì‹œì â€ì—ë§Œ ë³´ì¥ëœ ìœ„ì¹˜ì— ë†“ì…ë‹ˆë‹¤. í•¨ìˆ˜ ë³¸ë¬¸ ë‚´ë¶€ë¡œ ë“¤ì–´ì˜¤ë©´, ì»´íŒŒì¼ëŸ¬(ë˜ëŠ” ì–´ì…ˆë¸”ëŸ¬)ëŠ” ì´ë¯¸ ë§¤ê°œë³€ìˆ˜ê°€ ë‹´ê²¨ ìˆë˜ ë ˆì§€ìŠ¤í„°ë¥¼ ììœ ë¡­ê²Œ ì¬í™œìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì¦‰, â€œì›ë˜ zê°€ %rdxì— ìˆìœ¼ë‹ˆ %rdxë¥¼ ê±´ë“œë¦¬ë©´ ì•ˆ ëœë‹¤â€ëŠ” ê°œë…ì´ ì•„ë‹ˆë¼, ì»´íŒŒì¼ëŸ¬ê°€ z ê°’ì´ ë” ì´ìƒ í•„ìš”í•˜ì§€ ì•Šë‹¤ë©´ í•´ë‹¹ ë ˆì§€ìŠ¤í„°ë¥¼ ë‹¤ì‹œ ì¨ë„ ì•„ë¬´ ë¬¸ì œê°€ ì—†ìŠµë‹ˆë‹¤.

í•µì‹¬ ê°œë…

1.	í˜¸ì¶œ ê·œì•½

â€¢	x86-64 SysV ê·œì•½ì— ë”°ë¥´ë©´, ì¼ë°˜ì ìœ¼ë¡œ C í•¨ìˆ˜ì˜ ì²« 6ê°œ ì •ìˆ˜í˜• ë§¤ê°œë³€ìˆ˜ëŠ” ìˆœì„œëŒ€ë¡œ

\%rdi, \%rsi, \%rdx, \%rcx, \%r8, \%r9

ë ˆì§€ìŠ¤í„°ì— ë‹´ê²¨ ë“¤ì–´ì˜µë‹ˆë‹¤.

â€¢	í•¨ìˆ˜ ì§„ì… ì‹œì ì—ëŠ”

```plain text
x -> %rdi
y -> %rsi
z -> %rdx
```

ì™€ ê°™ì´ ëŒ€ì…ë˜ì–´ ìˆì„ ê²ƒì…ë‹ˆë‹¤.

2.	í•¨ìˆ˜ ë‚´ë¶€ì—ì„œì˜ ë ˆì§€ìŠ¤í„° ì‚¬ìš©

â€¢	ë§¤ê°œë³€ìˆ˜ëŠ” â€œí˜¸ì¶œ ì§í›„â€ê¹Œì§€ë§Œ %rdxì— ë“¤ì–´ìˆë‹¤ê³  ë³¼ ìˆ˜ ìˆê³ , ê·¸ ì´í›„ì—ëŠ” ì»´íŒŒì¼ëŸ¬ê°€ ê³„ì‚°ì— ë”°ë¼ í•„ìš”í•œ ë°ì´í„°ë§Œ ì„ì˜ì˜ ë ˆì§€ìŠ¤í„°ë‚˜ ë©”ëª¨ë¦¬ë¡œ ì˜®ê¸°ê³  %rdxë¥¼ ìƒˆë¡œ ì¨ë„ ë©ë‹ˆë‹¤.

â€¢	ì¦‰ í•¨ìˆ˜ ë‚´ë¶€ì—ì„  â€œë§¤ê°œë³€ìˆ˜ = íŠ¹ì • ë ˆì§€ìŠ¤í„°â€ ê´€ê³„ê°€ ê³ ì •ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.

3.	OR ì—°ì‚° í›„ ë®ì–´ì”Œìš°ëŠ” ì´ìœ 

â€¢	ì»´íŒŒì¼ëŸ¬ê°€ y | zë¥¼ êµ¬í•  ë•Œ, â€œì´ë¯¸ zê°€ %rdxì— ìˆìœ¼ë‹ˆ, ê±°ê¸°ì— y(%rsi)ë¥¼ OR í•´ë²„ë¦¬ë©´ ì—°ì‚° ê²°ê³¼ë¥¼ ë°”ë¡œ ì €ì¥í•  ìˆ˜ ìˆê² êµ°.â€ í•˜ê³  íŒë‹¨í•˜ëŠ” ê²ƒì…ë‹ˆë‹¤.

â€¢	ì´í›„ ì½”ë“œì—ì„œ â€œzì˜ ì›ë˜ ê°’â€ì´ í•„ìš” ì—†ë‹¤ë©´, êµ³ì´ zë¥¼ ë‹¤ë¥¸ ê³³ì— ë³´ì¡´í•  ì´ìœ ê°€ ì—†ìœ¼ë‹ˆ ê·¸ëŒ€ë¡œ %rdxì— ë®ì–´ì¨ì„œ íš¨ìœ¨ì ìœ¼ë¡œ ê³„ì‚°í•©ë‹ˆë‹¤.

ì˜ˆì‹œ ì½”ë“œ í•´ì„

```plain text
arith3:
    orq %rsi, %rdx      ; %rdx â† %rdx | %rsi   (z | y)
    sarq $9, %rdx       ; %rdx â† %rdx >> 9     (ì‚°ìˆ  ì‹œí”„íŠ¸)
    notq %rdx           ; %rdx â† ~%rdx
    movq %rdx, %bax     ; %rax â† %rdx          (í•¨ìˆ˜ ë°˜í™˜ê°’ ë ˆì§€ìŠ¤í„°)
    subq %rsi, %rbx     ; ??? (ì˜ë¯¸ ë¶ˆë¶„ëª…, ì˜ˆì‹œ ì½”ë“œ ìƒ ì–´ìƒ‰)
    ret
```

â€¢	í•¨ìˆ˜ì— ì§„ì…í–ˆì„ ë•Œ:

â€¢	x â†’ %rdi

â€¢	y â†’ %rsi

â€¢	z â†’ %rdx

â€¢	orq %rsi, %rdx ëª…ë ¹ì–´ë¡œ %rdxì— (z | y)ë¥¼ ê³„ì‚°í•´ ë®ì–´ì”ë‹ˆë‹¤.

â€¢	ì´í›„ ì—°ì‚°ë“¤ì€ %rdx ë ˆì§€ìŠ¤í„°ì— ëˆ„ì ëœ ê°’ì„ ëŒ€ìƒìœ¼ë¡œ ì§„í–‰í•©ë‹ˆë‹¤.

â€¢	â€œì›ë˜ %rdx ì•ˆì— ìˆë˜ zâ€ëŠ” ì¬ì‚¬ìš©í•  ì¼ì´ ì—†ìœ¼ë¯€ë¡œ, ì‚¬ë¼ì ¸ë„ ë¬¸ì œë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.

> â€œë§¤ê°œë³€ìˆ˜ zê°€ ë®ì–´ì”Œì›Œì§„ë‹¤â€ê³  í‘œí˜„í•  ìˆ˜ë„ ìˆì§€ë§Œ,

ê²°ë¡ 

â€¢	ì–´ì…ˆë¸”ë¦¬ í•¨ìˆ˜ ë‚´ë¶€ì—ì„œ ë§¤ê°œë³€ìˆ˜ë¡œ ì“°ë˜ ë ˆì§€ìŠ¤í„°ë¥¼ ë®ì–´ì“°ëŠ” ê²ƒì€ ì •ìƒì ì¸ ë™ì‘ì…ë‹ˆë‹¤.

â€¢	C ì–¸ì–´ ê´€ì ì—ì„œ â€œzê°€ ë“¤ì–´ ìˆë˜ ë ˆì§€ìŠ¤í„°ë¥¼ ìˆ˜ì •í•˜ë©´ ì–´ë–¡í•˜ì§€?â€ ë¼ê³  ì—¼ë ¤í•  í•„ìš”ê°€ ì—†ìŠµë‹ˆë‹¤. ì»´íŒŒì¼ëŸ¬ëŠ” zê°€ ë” ì´ìƒ í•„ìš” ì—†ì„ ë•Œ ë®ì–´ì“°ê¸°ë¥¼ í•˜ê¸° ë•Œë¬¸ì—, ê²°ê³¼ì ìœ¼ë¡œ í•¨ìˆ˜ê°€ ì˜ë„í•œ ëŒ€ë¡œ ë™ì‘í•©ë‹ˆë‹¤.

â€¢	ì¦‰, â€œë§¤ê°œë³€ìˆ˜ë¡œ ì‚¬ìš©í–ˆë˜ ë ˆì§€ìŠ¤í„°ë¥¼ ë§ˆìŒê» ì“°ë©´ ëœë‹¤ëŠ” ê²ƒâ€ì´ x86-64 í•¨ìˆ˜ í˜¸ì¶œ ê·œì•½ê³¼ ì»´íŒŒì¼ëŸ¬ ìµœì í™”ì˜ ê¸°ë³¸ ì›ë¦¬ì…ë‹ˆë‹¤.

## Practice 3.11

### ë¬¸ì œ

ì•„ë˜ ì½”ë“œì˜ ì˜ë¯¸

```c
xorq %rcx, %rcx
```

A. ì½”ë“œì˜ ì˜ë¯¸ë¥¼ ì„¤ëª…í•˜ê³  ì–´ë–¤ ìœ ìš©í•œ ì—°ì‚°ì„ ì´ê²ƒì´ êµ¬í˜„í•˜ëŠ”ì§€ ì„¤ëª…

%rcx ë ˆì§€ìŠ¤í„°ì˜ ëª¨ë“  ë¹„íŠ¸ë¥¼ 0ìœ¼ë¡œ ì„¤ì •í•œë‹¤. x = 0ì„ êµ¬í˜„í•œ ê²ƒ.

B. ë” ì§ê´€ì ì¸ ì–´ì…ˆë¸”ë¦¬ ì½”ë“œë¥¼ ì„¤ëª…

movq $0, %rcx

(leaq $0, %rcx ëŠ” ì•ˆ ëœë‹¤. ì²« ë²ˆì§¸ ì¸ìˆ˜ë¡œ ì£¼ì†Œ ë¦¬í„°ëŸ´ë§Œ í—ˆìš©ë˜ê¸° ë•Œë¬¸. ì¦‰ì‹œê°’ í•˜ë‚˜ëŠ” ê±°ê¸°ì— í•´ë‹¹ ì•ˆ ë¨.)

C. ë™ì¼í•œ ì—°ì‚°ì„ ìˆ˜í–‰í•˜ëŠ” ì„¸ ê°€ì§€ ë‹¤ë¥¸ êµ¬í˜„ ì¤‘ ì„ì˜ì˜ ë‘ ê°œë¥¼ ì„ íƒí•˜ì—¬ í•´ë‹¹ ëª…ë ¹ì–´ë“¤ì„ ì¸ì½”ë”©í•˜ëŠ”ë° í•„ìš”í•œ ë°”ì´íŠ¸ ìˆ˜ë¥¼ ë¹„êµ(??)   



## ê°œêµ¬ì½” 3. íŠ¹ë³„ ì‚°ìˆ  ì—°ì‚° - í° ìˆ˜ ê³±í•˜ê¸° 

### ê°œë…

![](./images/image.png)

### êµ¬í˜„: c ì½”ë“œì—ì„œì˜ ì‚¬ìš© ì˜ˆì‹œ(mulq)

```c
#include <inttypes.h>

typedef unsigned __int128 uint128_t;

void store_uprod(uint128_t *dest, uint64_t x, uint64_t y) {
	*dest = x * (uint128_t) y;
}
```

```c
// void store_uprod(uint128_t *dest, uint64_t x, uint64_t y)
// dest in %rdi, x in %rsi, y in %rdx
store_uprod:
	movq %rsi, %rax // copy x to multiplicand
	mulq %rdx // Multiply by y
	movq %rax, (%rdi) // Store lower 8 bytes at dest
	movq %rdx, 8(%rdi) // Store upper 8 bytes at dest+8
	ret
```



### ì½”ë©˜íŠ¸ 1. ì¼ë°˜ì ì¸ ê³±ì…ˆ ì‚°ìˆ  ì—°ì‚°ê³¼ ë‹¬ë¦¬ ì¸ìˆ˜ê°€ í•˜ë‚˜ë°–ì— ì—†ë‹¤. ì¦‰ 128ë¹„íŠ¸ í•˜ë‚˜ì˜ ìˆ˜ì— ëŒ€í•œ ìµœëŒ€ 2^64 ê°’ì˜ Së¡œ ë‚˜ëˆ„ê¸° ë° ê³±ì…ˆì„ í•œ ì—°ì‚°ì„ ì €ì¥í•˜ëŠ” ëª©ì ì¸ ë“¯í•˜ë‹¤. ì´ê²Œ ë§ë‚˜?

ë§ì”€í•˜ì‹  ëŒ€ë¡œ ì´ ëª…ë ¹ë“¤ì€ ì¼ë°˜ì ì¸ 2í•­ ì‚°ìˆ  ì—°ì‚°ê³¼ ë‹¬ë¦¬ ì˜¤í¼ëœë“œ ì§€ì • ë°©ì‹ê³¼ ê²°ê³¼ ë ˆì§€ìŠ¤í„°ê°€ ê³ ì •ë˜ì–´ ìˆë‹¤ëŠ” ì ì´ í•µì‹¬ì…ë‹ˆë‹¤. íŠ¹íˆ RDX:RAX ë ˆì§€ìŠ¤í„° ìŒì„ 128ë¹„íŠ¸ë¡œ ë³´ê³  ì—¬ê¸°ì— ê³±ì…ˆì´ë‚˜ ë‚˜ëˆ—ì…ˆì„ ìˆ˜í–‰í•˜ëŠ” ë°©ì‹ì„ ì´í•´í•˜ë©´, ì™œ í•´ë‹¹ ëª…ë ¹ë“¤ì´ â€˜ë‹¨í•­(single-operand) ì‚°ìˆ  ì—°ì‚°â€™ì¸ì§€ ìì—°ìŠ¤ëŸ½ê²Œ ë‚©ë“í•  ìˆ˜ ìˆì£ .

â€¢	mulq/imulq: RAX(ë¬µì‹œì ) Ã— (ëª…ì‹œëœ í”¼ì—°ì‚°ì) â†’ ê²°ê³¼ 128ë¹„íŠ¸(ìƒìœ„ RDX, í•˜ìœ„ RAX)

â€¢	divq/idivq: RDX:RAX(ë¬µì‹œì ) Ã· (ëª…ì‹œëœ í”¼ì—°ì‚°ì) â†’ ëª« RAX, ë‚˜ë¨¸ì§€ RDX

ê²°ê³¼ ì €ì¥ ë ˆì§€ìŠ¤í„°ê°€ ê³ ì •ë˜ì–´ ìˆë‹¤ëŠ” ì ì—ì„œ â€œíŠ¹ë³„ ì‚°ìˆ  ì—°ì‚°â€ìœ¼ë¡œë„ ë¶ˆë¦¬ëŠ” ë§Œí¼, ì»´íŒŒì¼ëŸ¬ê°€ 64ë¹„íŠ¸ ì •ìˆ˜ì˜ 128ë¹„íŠ¸ ê³±ì…ˆì´ë‚˜ ë‚˜ëˆ—ì…ˆì´ í•„ìš”í•  ë•Œ ë§¤ìš° ìš”ê¸´í•˜ê²Œ ì“°ì´ê²Œ ë©ë‹ˆë‹¤. ë§ì”€í•˜ì‹  ìš”ì ì„ ì˜ ì§šì–´ì£¼ì…”ì„œ, ì´ ì£¼ì œë¥¼ ì²˜ìŒ ì ‘í•˜ëŠ” ë¶„ë“¤ë„ í•œ ë²ˆì— ì´í•´í•˜ê¸° ì¢‹ì„ ê²ƒ ê°™ë„¤ìš”!

### ì½”ë©˜íŠ¸ 2.í•˜ë‚˜ì˜ ê³±ì…ˆ ê²°ê³¼ë¥¼ ì €ì¥í•˜ê¸° ìœ„í•´ì„œ ì•„ë˜ ë¶€ë¶„ì„ %rdiê°€ ê°€ë¦¬í‚¤ëŠ” 64ë¹„íŠ¸ ë©”ëª¨ë¦¬ ì£¼ì†Œì—, ê·¸ë¦¬ê³  ê·¸ ìœ„ ë¶€ë¶„ì„ %rdiì—ì„œ quad word size ë–¨ì–´ì§„ ì£¼ì†Œì— ì €ì¥í•œë‹¤, ì´ê±° ì•„ëƒ?

ë„¤, ì •í™•íˆ ê·¸ë ‡ìŠµë‹ˆë‹¤.

ê³±ì…ˆ ê²°ê³¼ 128ë¹„íŠ¸ ì¤‘ í•˜ìœ„ 64ë¹„íŠ¸ëŠ” (%rdi)ì—, ìƒìœ„ 64ë¹„íŠ¸ëŠ” 8(%rdi)(ì¦‰ dest+8)ì— ì“°ì´ë¯€ë¡œ,

ê²°ê³¼ì ìœ¼ë¡œ %rdiê°€ ê°€ë¦¬í‚¤ëŠ” ë©”ëª¨ë¦¬ êµ¬ì—­(ì—°ì†ëœ 16ë°”ì´íŠ¸)ì„

â€œí•˜ìœ„ 64ë¹„íŠ¸ + ìƒìœ„ 64ë¹„íŠ¸â€ ìˆœìœ¼ë¡œ ì±„ìš°ê²Œ ë©ë‹ˆë‹¤.

## ê°œêµ¬ì½” 4. íŠ¹ë³„ ì‚°ìˆ  ì—°ì‚° 2

### ê°œë…: ë‚˜ëˆ„ê¸°

- idivlì€ í”¼ì œìˆ˜(dividend, ë‚˜ëˆ ì§€ëŠ” ìˆ˜)ë¥¼ %rdx(high-order 64 bits)ì™€ %rax(low-order 64 bits)ì— ì €ì¥
- ì œìˆ˜(divisor, ë‚˜ëˆ„ëŠ” ìˆ˜)ëŠ” instruction operandë¡œ ì£¼ì–´ì§
- idivlì€ ë‚˜ëˆ„ê¸° ì—°ì‚° í›„ ëª«ì„ %rax, ë‚˜ë¨¸ì§€ë¥¼ %rdxì— ì €ì¥.
- ëŒ€ë¶€ë¶„ì˜ ê²½ìš° dividendëŠ” 64ë¹„íŠ¸ ê°’ìœ¼ë¡œ ì£¼ì–´ì§. ê·¸ëŸ¬ë©´ high-order 64 bitsë¥¼ ì €ì¥í•˜ê¸° ìœ„í•œ %rdx ë ˆì§€ìŠ¤í„°ëŠ” ì“¸ ì¼ì´ ì—†ìŒ ì´ë•Œ %rdx ë ˆì§€ìŠ¤í„°ë¥¼ ì±„ìš°ëŠ” ë‘ ê°€ì§€ ë°©ì‹ì´ ìˆìŒ
  - unsigned arithmetic: ì „ë¶€ 0ìœ¼ë¡œ ì±„ì›€
  - signed arithmetic: sign bit of %raxë¡œ ì±„ì›€
- ì´ë•Œ, signed arithmeticì˜ ë™ì‘ì„ cqtoë¡œ ìˆ˜í–‰í•  ìˆ˜ ìˆìŒ. ì´ ì¹œêµ¬ëŠ” ì•„ë¬´ ì¸ìˆ˜ë„ ë°›ì§€ ì•ŠìŒ. ê·¸ì € %raxì˜ ì‚¬ì¸ ë¹„íŠ¸ë¥¼ ì½ì–´ì„œ %rdxì— ê°–ë‹¤ ì±„ì›Œë²„ë¦¼(ì½”ë©˜íŠ¸ 1.).
### êµ¬í˜„: idivq ì‚¬ìš© ì˜ˆì‹œ

```c
void remdiv(long x, long y, long *qp, long *rp) {
	long q = x/y;
	long r = x%y;
	*qp = q;
	*rp = r;
}
```

```assembly
// void remdiv(long x, long y, long *qp, long *rp)
// x in %rdi, y in %rai, qp in %rdx, rp in %rcx
remdiv:
	movq %rdx, %r8 // copy qp
	movq %rdi, %rax   // move x to lower 8 byte of dividend(ì„¤ëª… 1.)
	cqto // sign-extend to upper 8 bytes of divdend
	idivq %rsi // divide by y
	movq %rax, (%r8) // store quotient at qp
	movq %rdx, (%rcx) // store remainder at rp
	ret
```

ì„¤ëª… 1. movq %rdi, %raxë¥¼ ìˆ˜í–‰í•˜ëŠ” ì´ìœ 

ì´ ê²½ìš°, ì¸ìˆ˜ rpëŠ” ë‹¤ë¥¸ ë ˆì§€ìŠ¤í„°(ì´ ê²½ìš° %r8)ë¡œ ë³µì‚¬ë¼ì•¼ í•¨. ì™œ? ê¸°ì¡´ì— ì´ ì¹œêµ¬ê°€ ì €ì¥ëœ %rdxëŠ” dividendì˜ high-order 64bitsë¥¼ ì €ì¥í•˜ê¸° ìœ„í•œ ë ˆì§€ìŠ¤í„°ê¸° ë•Œë¬¸! 

ë‚˜ë¨¸ì§€ëŠ” ì–´ë µì§€ ì•ŠìŒ.

### ì½”ë©˜íŠ¸: ê·¸ë ‡ë‹¤ë©´ 128ë¹„íŠ¸ ìˆ˜ë¥¼ ì—°ì‚°í•˜ì§€ ì•ŠëŠ” ê²½ìš°, 64ë¹„íŠ¸ ì´í•˜ì˜ ìˆ˜ë¥¼ ì—°ì‚°í•  ë•Œë„ cqto ì—°ì‚°ì„ ìˆ˜í–‰í•´ì„œ %rdx ë ˆì§€ìŠ¤í„°ê¹Œì§€ ë¹„íŠ¸ë¥¼ í™•ì¥ì‹œì¼œì•¼ í•˜ëŠ” ê±´ê°€? ê½¤ ë‚­ë¹„ì¸ ê±° ê°™ì€ë°.

x86-64 ì•„í‚¤í…ì²˜ì—ì„œ idivq(í˜¹ì€ divq) ëª…ë ¹ì–´ë¥¼ ì‚¬ìš©í•  ë•ŒëŠ” ìƒìœ„ 64ë¹„íŠ¸ë¥¼ ì–´ë–¤ ë°©ì‹(ë¶€í˜¸ í™•ì¥ì¸ì§€, 0 í™•ì¥ì¸ì§€)ìœ¼ë¡œë“  ì´ˆê¸°í™”í•´ ì£¼ì–´ì•¼ í•©ë‹ˆë‹¤. 64ë¹„íŠ¸ ì •ìˆ˜ ë‚˜ëˆ—ì…ˆì„ í•˜ë”ë¼ë„ CPUëŠ” í•­ìƒ â€œ128ë¹„íŠ¸â€(%rdx:%rax)ë¥¼ í”¼ì œìˆ˜ë¡œ ê°„ì£¼í•˜ê¸° ë•Œë¬¸ì…ë‹ˆë‹¤.

ì¦‰, ë‹¤ìŒ ë‘ ê²½ìš°ê°€ ì¡´ì¬í•©ë‹ˆë‹¤.

1.	Signed division(idivq)

â€¢	ìƒìœ„ 64ë¹„íŠ¸ëŠ” cqto(C onvert Q word T o O ctword) ëª…ë ¹ì–´ë¡œ ë¶€í˜¸ í™•ì¥ë©ë‹ˆë‹¤.

â€¢	cqtoëŠ” %raxì˜ ì‚¬ì¸ ë¹„íŠ¸ë¥¼ ì½ì–´, %rdxë¥¼ ëª¨ë‘ í•´ë‹¹ ë¹„íŠ¸ë¡œ ì±„ì›ë‹ˆë‹¤.

2.	Unsigned division(divq)

â€¢	ìƒìœ„ 64ë¹„íŠ¸ëŠ” 0ìœ¼ë¡œ ì±„ì›Œì•¼ í•©ë‹ˆë‹¤.

â€¢	í”íˆ xorq %rdx, %rdx ê°™ì€ ì‹ìœ¼ë¡œ ê°„ë‹¨íˆ 0ì„ ì±„ì›ë‹ˆë‹¤.

ë”°ë¼ì„œ â€œ64ë¹„íŠ¸ ì´í•˜ì˜ ê°’ì´ë¼ ì‹¤ì œë¡œ 128ë¹„íŠ¸ê°€ í•„ìš” ì—†ë‹¤â€ í•˜ë”ë¼ë„, x86-64 í•˜ë“œì›¨ì–´ ë ˆë²¨ì—ì„œ idivq/divqëŠ” í•­ìƒ ìƒìœ„ 64ë¹„íŠ¸ê¹Œì§€ ê³ ë ¤í•˜ëŠ” í˜•ì‹ìœ¼ë¡œ ì •ì˜ë˜ì–´ ìˆìŠµë‹ˆë‹¤. ê²°ê³¼ì ìœ¼ë¡œ 64ë¹„íŠ¸ ë‚˜ëˆ—ì…ˆì„ í•˜ë ¤ë©´ ë¶€í˜¸ ì—¬ë¶€ì— ë§ì¶°ì„œ ë¬´ì¡°ê±´ ìƒìœ„ 64ë¹„íŠ¸ë¥¼ ì´ˆê¸°í™”(cqto í˜¹ì€ xorq %rdx, %rdx) í•´ì•¼ í•©ë‹ˆë‹¤. í•œ ì¤„ì§œë¦¬ ë³´ì¡° ëª…ë ¹ì–´ì¼ ë¿ì´ë¼ ì„±ëŠ¥ìƒ ë¶€ë‹´ë„ í¬ì§€ ì•Šìœ¼ë©°, ì´ê²ƒì´ í•´ë‹¹ ì•„í‚¤í…ì²˜ì˜ ê·œì•½ì…ë‹ˆë‹¤.

## Practice 3.12

### ë¬¸ì œ

```assembly
void uremdiv(unsigned long x, unsigned long y, unsigned long *qp, unsigned long *rp) {
	unsigned long q = x/y;
	unsigned long r = x%y;
	*qp = q;
	*rp = r;
}
```

ì´ ê²½ìš°ì— ë§ì¶° unsigned arithmeticì„ ìˆ˜í–‰í•˜ëŠ” ì–´ì…ˆë¸”ë¦¬ ì½”ë“œë¡œ ìœ„ ì½”ë“œë¥¼ ë³€ê²½í•´ë³´ê¸°.

### í’€ì´

ê·¸ëƒ¥ 0ìœ¼ë¡œ %rdxë¥¼ ì±„ì›Œë²„ë¦¬ë©´ ë˜ì§€ ì•Šë‚˜? ì•„ë˜ì™€ ê°™ì´ ìˆ˜ì •

```assembly
// void remdiv(long x, long y, long *qp, long *rp)
// x in %rdi, y in %rai, qp in %rdx, rp in %rcx
remdiv:
	movq %rdx, %r8 // copy qp
	movq %rdi, %rax   // move x to lower 8 byte of dividend(ì„¤ëª… 1.)
	xorq %rdx, %rdx // unsign-extend to upper 8 bytes of divdend
	idivq %rsi // divide by y
	movq %rax, (%r8) // store quotient at qp
	movq %rdx, (%rcx) // store remainder at rp
	ret
```

ê·¸ëŸ°ë° ì •ë‹µì€ ë‹¤ë¥´ë‹¤. (movl $0, %edx)

### ì˜ë¬¸: ì™œ xorq %rdx, %rdxê°€ ì•„ë‹ˆë¼ movl $0, %edxì§€? 

ìƒê´€ ì—†ë‹¤. ê·¸ëƒ¥ ì»´íŒŒì¼ ì°¨ì´. ê¸°ëŠ¥ì€ ë™ì¼í•¨

### ì½”ë©˜íŠ¸: movl $0, %edx ëŠ” í•˜ìœ„ 32ë¹„íŠ¸ê°€ ë°”ë€Œë©´ ìƒìœ„ 32ë¹„íŠ¸ëŠ” ìë™ìœ¼ë¡œ 0ìœ¼ë¡œ ë°”ê¾¸ëŠ” ì•„í‚¤í…ì²˜ë¥¼ í™œìš©í•œ ì—°ì‚°ì´ê² êµ¬ë‚˜

ë§ìŠµë‹ˆë‹¤. x86-64 ì•„í‚¤í…ì²˜ì—ì„œ 32ë¹„íŠ¸ ë ˆì§€ìŠ¤í„°(ì˜ˆ: %edx)ì— ê°’ì„ ì“°ë©´ ìƒìœ„ 32ë¹„íŠ¸(ì¦‰ %rdxì˜ ìƒìœ„ ì ˆë°˜)ê°€ ìë™ìœ¼ë¡œ 0ìœ¼ë¡œ ì±„ì›Œì§‘ë‹ˆë‹¤. ì´ ì ì„ ì´ìš©í•´ movl $0, %edx ëª…ë ¹ìœ¼ë¡œ ì „ì²´ 64ë¹„íŠ¸(= %rdx)ë¥¼ 0ìœ¼ë¡œ ë§Œë“¤ ìˆ˜ ìˆëŠ” ê²ƒì´ì£ . (ë‹¨, 16ë¹„íŠ¸ë‚˜ 8ë¹„íŠ¸ ë ˆì§€ìŠ¤í„°ëŠ” ì´ëŸ° ìë™ í™•ì¥ì´ ì ìš©ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.)

## ê°œêµ¬ì½” 4. ì¡°ê±´ ì½”ë“œ

### ê°œë…: ë°ì´í„° ê¸°ë°˜ ì œì–´ë¥¼ ìœ„í•œ ì²« ë²ˆì§¸ ìš”ì†Œ

CF: carry flag. ìµœê·¼ ì—°ì‚°ì˜ ì œì¼ ë†’ì€ ë¹„íŠ¸ì—ì„œ ë°œìƒí•œ ìºë¦¬ì•„ì›ƒì„ ê°ì§€. unsigned operationì˜ ì˜¤ë²„ í”Œë¡œìš° ê°ì§€

ZF: zero flag. ìµœê·¼ì˜ ì—°ì‚°ì´ 0ì„ ë¦¬í„´í–ˆëŠ”ì§€ ê°ì§€

SF: sign flag. ìµœê·¼ ì—°ì‚°ì´ ìŒìˆ˜ ê°’ì„ ë¦¬í„´í–ˆëŠ”ì§€ ê°ì§€

OF: overflow flag. ìµœê·¼ ì—°ì‚°ì´ 2ì˜ ë³´ìˆ˜ë²• ì˜¤ë²„í”Œë¡œìš°ë¥¼ ëƒˆëŠ”ì§€ ê°ì§€. (ìŒìˆ˜ ì–‘ìˆ˜ ìƒê´€ ì—†ìŒ)

### êµ¬í˜„:

```assembly
CF: (unsigned) t < (unsigned) a // unsigned overflow
ZF: (t == 0) // zero
SF: (t < 0 ) // negative
OF: (a < 0 == b < 0) && (tj < 0 != a < 0) signed overflow
```

ì´ê²Œ ë‹¤ ë­ì‹œë‹¤ëƒ. ì°¨ê·¼ì°¨ê·¼ ì±…ì„ ì½ì–´ ë´…ì‹œë‹¤.

1. leaqë¥¼ ì œì™¸í•œ ëª¨ë“  ì—°ì‚°ì´ ìœ„ ìƒíƒœì½”ë“œë¥¼ ì„¤ì •í•œë‹¤.
1. XORê³¼ ê°™ì€ ë…¼ë¦¬ì—°ì‚°ì: OF, CFê°€ 0ìœ¼ë¡œ ì„¤ì • ëœë‹¤. (For the logical operations, such as XOR, the carry and overflow flags are set to zero.)
1. ì‰¬í”„íŠ¸ ì—°ì‚°ì: OFëŠ” 0ìœ¼ë¡œ ì„¤ì •ë˜ê³ , CFëŠ” íŠ€ì–´ë‚˜ì˜¨ ë§ˆì§€ë§‰ ë¹„íŠ¸ë¡œ ì„¤ì •ëœë‹¤(ì˜ë¬¸ 1.). (For the shift operations, the carry flag is set to the last bit shifted out, while the overflow flag is set to zero.)
1. INC, DEC: OF, ZFë¥¼ ê°±ì‹ í•œë‹¤. í•˜ì§€ë§Œ ìš°ë¦¬ê°€ ë” ì•Œì•„ë³´ì§€ ì•Šì„ ì´ìœ ë¡œ ì¸í•´(ë­ì§€?) CFëŠ” ê°±ì‹ ë˜ì§€ ì•ŠëŠ”ë‹¤. ìƒì‹ì ìœ¼ë¡œ, INCì™€ DECëŠ” ì •ìˆ˜ë¥¼ ë³€í™˜í•˜ëŠ” ì—°ì‚°ì´ê¸° ë•Œë¬¸ì— OF, ZFëŠ” ì¶©ë¶„íˆ ë°œìƒ ê°€ëŠ¥í•¨. ê·¸ëŸ°ë° CFëŠ” ì™œ ì•ˆ ë˜ì§€? ì¼ë‹¨ íŒ¨ìŠ¤.(For reasons that we will not delve into, the INC and DEC instructions set the overflow and zero flags, but they leave the carry flag unchanged. )
### ì˜ë¬¸ 1:  ì‰¬í”„íŠ¸ ì—°ì‚°ìê°€ ì‰¬í”„íŠ¸ë¡œ íŠ€ì–´ë‚˜ì˜¨ ë§ˆì§€ë§‰ ë¹„íŠ¸ë¥¼ CFë¡œ ì„¤ì •í•œë‹¤ë©´, shift left ê²½ìš°ì—ë§Œ CFê°€ ë°”ë€ŒëŠ” ê±´ê°€? shift rightì—ì„œëŠ” íŠ€ì–´ë‚˜ì˜¤ëŠ” ë¹„íŠ¸ ìœ„ì¹˜ê°€ ì²« ë¶€ë¶„ì´ì–ì•„.

ê²°ë¡ : ì•„ë¬´ ë°©í–¥ ì‰¬í”„íŠ¸ë“  íŠ€ì–´ë‚˜ì˜¨ ì¹œêµ¬ê°€ CFì— ë“¤ì–´ê°„ë‹¤.

x86 ê³„ì—´ì—ì„œ â€œë§ˆì§€ë§‰ìœ¼ë¡œ ë°€ë ¤ ë‚˜ê°„ ë¹„íŠ¸(last bit shifted out)ë¥¼ CFì— ì €ì¥í•œë‹¤â€ ë¼ëŠ” ê·œì¹™ì€ ë‹¤ìŒê³¼ ê°™ì´ í•´ì„í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

â€¢	ì™¼ìª½ ì‰¬í”„íŠ¸(SHL)

â€¢	ìµœìƒìœ„ ë¹„íŠ¸(MSB)ê°€ â€œë°€ë ¤ë‚˜ê°€ëŠ” ë¹„íŠ¸â€ê°€ ë©ë‹ˆë‹¤. ì¦‰, (ê²°ê³¼ì ìœ¼ë¡œ) ì˜¤ë²„í”Œë¡œ ë˜ì–´ì„œ ì‚¬ë¼ì§€ëŠ” ë¹„íŠ¸ê°€ CFì— ë“¤ì–´ê°‘ë‹ˆë‹¤.

â€¢	ì˜¤ë¥¸ìª½ ì‰¬í”„íŠ¸

â€¢	SHR(ë…¼ë¦¬ì  ì˜¤ë¥¸ìª½ ì‰¬í”„íŠ¸) : ìµœí•˜ìœ„ ë¹„íŠ¸(LSB)ê°€ â€œë°€ë ¤ë‚˜ê°€ëŠ” ë¹„íŠ¸â€ê°€ ë˜ì–´ CFì— ë“¤ì–´ê°‘ë‹ˆë‹¤.

â€¢	SAR(ì‚°ìˆ ì  ì˜¤ë¥¸ìª½ ì‰¬í”„íŠ¸) : ì´ë•Œë„ LSBê°€ ë–¨ì–´ì ¸ ë‚˜ê°€ê³  CFì— ë“¤ì–´ê°‘ë‹ˆë‹¤. (MSB ìª½ì€ ì›ë˜ì˜ ë¶€í˜¸ ë¹„íŠ¸ë¥¼ ì±„ì›Œ ë„£ìŒ)

ì¦‰,

â€¢	ì™¼ìª½ ì‰¬í”„íŠ¸ : ìƒìœ„ ë¹„íŠ¸ê°€ CFë¡œ

â€¢	ì˜¤ë¥¸ìª½ ì‰¬í”„íŠ¸ : í•˜ìœ„ ë¹„íŠ¸ê°€ CFë¡œ

ê°€ ë©ë‹ˆë‹¤. â€œíŠ€ì–´ë‚˜ì˜¤ëŠ” ë§ˆì§€ë§‰ ë¹„íŠ¸â€ëŠ” ì‰¬í”„íŠ¸ ë°©í–¥ì— ë”°ë¼ ë‹¤ë¥´ë¯€ë¡œ, ì™¼ìª½ ì‰¬í”„íŠ¸ë¼ê³  í•´ì„œë§Œ CFê°€ ë°”ë€ŒëŠ” ê²ƒì€ ì•„ë‹ˆê³ , ì˜¤ë¥¸ìª½ ì‰¬í”„íŠ¸ì—ì„œë„ ë§ˆì°¬ê°€ì§€ë¡œ ë–¨ì–´ì§„ LSBê°€ CFì— ê¸°ë¡ë©ë‹ˆë‹¤.

## ê°œêµ¬ì½” 5. Comparison and Test instructions

### ê°œë…: ì´ ëª…ë ¹ì–´ë“¤ì€ ëª©ì ì§€ ê°’ì„ ë°”ê¾¸ì§€ ì•Šê³  ìƒíƒœ ì½”ë“œë¥¼ ì—…ë°ì´íŠ¸í•  ìˆ˜ ìˆìŒ

CMP: SUBì™€ ê°™ìŒ. í•˜ì§€ë§Œ ëª©ì ì§€ ê°’ì„ ë°”ê¾¸ì§€ ì•ŠìŒ

TEST: ANDì™€ ê°™ìŒ. í•˜ì§€ë§Œ ëª©ì ì§€ ê°’ì„ ë°”ê¾¸ì§€ ì•ŠìŒ.

### êµ¬í˜„

b, w, l, q ì ‘ë¯¸ì‚¬ ìƒëµ. 

### ì½”ë©˜íŠ¸

ì—†ìŒ.

## ê°œêµ¬ì½” 6. The set instructions

### ê°œë…: single byteë¥¼ ìƒíƒœì½”ë“œì˜ íŠ¹ì • ì¡°í•©ì— ì˜ê±°í•´ 0ì´ë‚˜ 1ë¡œ ì±„ì›Œë²„ë¦´ ìˆ˜ ìˆìŒ.

ìƒíƒœ ì½”ë“œë¥¼ ë°”ë¡œë°”ë¡œ ì“°ëŠ” ê²ƒë³´ë‹¤ëŠ” ì„¸ ê°€ì§€ í™œìš© ë°©ë²•ì´ ìˆìŒ. ê·¸ì¤‘ ì²« ë²ˆì§¸ê°€ set instructions. 

### êµ¬í˜„:

ë…¼ë¦¬ì‹ì„ í•˜ë‚˜ í•˜ë‚˜ ì´í•´í•˜ëŠ”ê±´ ì¢€ ë¯¸ë£¨ëŠ”ê²Œ ì¢‹ì„ ê²ƒ ê°™ê³ (ì–´ë ¨íˆ ë§ê² ì§€) êµ¬ì²´ì ì¸ ì‚¬ìš© ì‚¬ë¡€ë¥¼ ë³´ì.

```assembly
// int comp(data_t a, data_t b)
// a in %rdi, b in %rsi
comp:
	cmpq %rsi, %rdi //compare a:b
	setl %al // set low-order byte of %eax to 0 or 1 (ì½”ë©˜íŠ¸ 1.)
	movzbl %al, %eax // clear rest of %eax (and rest of %rax) (ì½”ë©˜íŠ¸ 2.)
	ret
```

### ì½”ë©˜íŠ¸ 1. 

set ì—°ì‚°ì€ ëª¨ë‘ ì‹±ê¸€ ë°”ì´íŠ¸ì— ëŒ€í•œ ì—°ì‚°ì´ê¸° ë•Œë¬¸ì— ì‚¬ìš©í•˜ëŠ” ë ˆì§€ìŠ¤í„°ë„ ì‹±ê¸€ ë°”ì´íŠ¸ì—¬ì•¼ í•¨

### ì½”ë©˜íŠ¸ 2.

set %al ì—°ì‚°ì€ %rax ë ˆì§€ìŠ¤í„°ì˜ ìƒìœ„ ë¹„íŠ¸ë“¤ì„ ê·¸ëŒ€ë¡œ ë‚¨ê²¨ë‘ê¸° ë•Œë¬¸ì—, ì´ë¥¼ â€˜í´ë¦¬ì–´â€™í•´ì„œ ì™„ì „íˆ ì—…ë°ì´íŠ¸í•˜ê¸° ìœ„í•´ì„œëŠ” í•˜ìœ„ 32ë¹„íŠ¸ê¹Œì§€ ì—…ë°ì´íŠ¸í•˜ëŠ” movzbl ì—°ì‚°ì„ ìˆ˜í–‰í•´ì•¼ í•¨. (movzbl %al, %eax)

### ì½”ë©˜íŠ¸ 3. ì¢…í•©

ì»´íŒŒì¼ëŸ¬ëŠ” ì…‹ ì¸ìŠ¤íŠ¸ëŸ­ì…˜ì˜ ë™ì˜ì–´ë¥¼ ì•Œì•„ì„œ ì„ íƒí•  ìˆ˜ ìˆìŒ.(ëª…ë ¹ì–´ì—ê²Œ ì™œ ë™ì˜ì–´ê°€ ìˆì§€? ì•„ë¬´íŠ¼)

## Practice 3.13

### ë¬¸ì œ

```assembly
// a in portion of %rdx b in portion of %rsi
int comp(data_t a, data_t b) {
	return a COMP b;;
}
```

ìœ„ì™€ ê°™ì€ ì½”ë“œê°€ ìˆì„ ë•Œ, ì•„ë˜ ì–´ì…ˆë¸”ë¦¬ ì½”ë“œê°€ ì»´íŒŒì¼ëœ ê²½ìš° 

1. ì–´ë–¤ ë¹„êµë¥¼ COMPê°€ í–ˆëŠ”ì§€
1. data_tì˜ ë°ì´í„° íƒ€ì…ì€ ë¬´ì—‡ì¸ì§€
### ë¬¸ì œë¥¼ ì œëŒ€ë¡œ í‘¸ëŠ” ë°©ë²•

1. cmp ëª…ë ¹ì–´ì˜ suffix í™•ì¸
1. set ëª…ë ¹ì–´ì˜ singed/unsigned ì—°ì‚° ì—¬ë¶€ í™•ì¸.
### í’€ì´

![](./images/IMG_0497.png)

## Practice 3.14

### ë¬¸ì œ

![](./images/image.png)

ìœ„ì™€ ë™ì¼ 

![](./images/IMG_0498.png)

# Procedures

## ì¤‘ìš”í•œ ê°œë…ë“¤

- Procedureë€? ì˜ë„ëœ ë§¤ê°œë³€ìˆ˜ì™€ ì˜µì…”ë„í•œ ë¦¬í„´ ê°’ì„ êµ¬í˜„í•œ ì½”ë“œ íŒ¨í‚¤ì§€ë¥¼ ì œê³µ. (provide a way to package code that implements some functionality with a designated set of arguments and an optional return value)
- Attributes of procedures: procedure Pê°€ procedure Që¥¼ ë¶€ë¥¸ í›„ Pë¡œ ëŒì•„ì˜¨ë‹¤ê³  í•  ë•Œ,
  - passing control: í”„ë¡œê·¸ë¨ ì¹´ìš´í„°ëŠ” Qì˜ ì‹œì‘ì§€ì ìœ¼ë¡œ ì„¤ì •ë˜ì—ˆë‹¤ê°€ Qê°€ ë¦¬í„´ë  ë•Œ Pì˜ ëª…ë ¹ì–´ë¡œ ì„¤ì •ë¼ì•¼ í•¨
  - passing data: PëŠ” í•˜ë‚˜ ì´ìƒì˜ ë§¤ê°œë³€ìˆ˜ë¥¼ Që¡œ ì „ë‹¬í•  ìˆ˜ ìˆì–´ì•¼ í•¨. ê·¸ë¦¬ê³  QëŠ” ê°’ì„ Pë¡œ ëŒë ¤ì¤„ ìˆ˜ ìˆì–´ì•¼ í•¨
  - Allocating and deallocating memory: QëŠ” ì§€ì—­ë³€ìˆ˜ë¥¼ ìœ„í•œ ê³µê°„ì„ ë°°ë‹¹ë°›ê³ , ë¦¬í„´ë˜ê¸° ì „ì— ì´ê±¸ ë‹¤ì‹œ ë‚´ë±‰ì–´ì•¼ í•¨
## ê°œêµ¬ì½” 1. ëŸ°íƒ€ì„ ìŠ¤íƒ

### ê°œë…

passing control, passing data, allocating and deallocating memoryë¥¼ ìœ„í•œ ì €ì¥ì†Œ. 

- ë°ì´í„°ë“¤ì€ pushq, popqë¥¼ í†µí•´ ìŠ¤íƒì— ì €ì¥ë˜ê±°ë‚˜ íšŒìˆ˜ë  ìˆ˜ ìˆìŒ(Data can be stored on and retrieved from the stack using the pushq and popq instructions.)
- íŠ¹ì •í•œ ì´ˆê¸°ê°’ ì—†ì´ ê³µê°„ ì´ˆê¸°í™”ëŠ” ê·¸ëƒ¥ ìŠ¤íƒ í¬ì¸í„° ê°’ì„ ê°ì†Œì‹œì¼œì„œ ìˆ˜í–‰í•  ìˆ˜ ìˆìŒ(deallocationì€ ë°˜ëŒ€ë¡œ)
ì–´ë–¤ procedureê°€ ë ˆì§€ìŠ¤í„°ë¡œ í™€ë“œí•  ìˆ˜ ìˆëŠ” ì´ìƒì˜ ì €ì¥ì†Œë¥¼ í•„ìš”ë¡œ í•œë‹¤ë©´ ìŠ¤íƒì— ê³µê°„ì„ í• ë‹¹. ì´ ê³µê°„ì„ procedureì˜ stack frameì´ë¼ê³  í•¨.

ì–´ë–¤ procedureë“¤ì€ 6ê°œ ì´í•˜ì˜ ì¸ìˆ˜ê°€ ìˆê³ , ëª¨ë‘ ë ˆì§€ìŠ¤í„°ë¡œ ë°”ë¡œ ì§‘ì–´ ë„£ì„ ìˆ˜ ìˆìŒ. ê·¸ë˜ì„œ  ìŠ¤íƒ í”„ë ˆì„ ìì²´ê°€ í•„ìš” ì—†ì„ ìˆ˜ë„ ìˆìŒ.

### êµ¬í˜„

![](./images/image.png)

### ì½”ë©˜íŠ¸

ì—†ìŒ

## ê°œêµ¬ì½” 2. ì œì–´ ì „ë‹¬ 

### ê°œë…

Pê°€ Që¥¼ í˜¸ì¶œí–ˆë‹¤ê³  í•  ë•Œ í”„ë¡œì„¸ì„œëŠ” Pê°€ ì–´ë””ì„œ ê³„ì†ë˜ì–´ì•¼ í•˜ëŠ”ì§€ ì €ì¥í•´ì•¼ í•¨.(the processor must have some record of the code location where it should resume the execution of P.) ì´ë¥¼ call Qê°€ ì €ì¥

call Q: ì£¼ì†Œ A(Pì˜ í˜„ì¬ ì‹¤í–‰ ì§€ì )ë¥¼ ë¦¬í„´ ì£¼ì†Œë¡œ ìŠ¤íƒì— í‘¸ì‹œí•˜ê³  PCë¥¼ Qì˜ ì‹œì‘ì§€ì ìœ¼ë¡œ ì„¤ì •

ret: ì£¼ì†Œ Aë¥¼ ìŠ¤íƒì—ì„œ íŒ í•´ì„œ í”„ë¡œê·¸ë¨ ì¹´ìš´í„°ë¥¼ Aë¡œ ì„¤ì •



### êµ¬í˜„

ëª…ë ¹ì–´ë“¤

ê·¸ë¦¼: call, ret ì˜ˆì‹œ

![](./images/image.png)

ê·¸ë¦¼: ìœ„ ìŠ¤íƒ ê·¸ë¦¼ì˜ ì½”ë“œ ì˜ˆì‹œ

![](./images/image.png)

ê·¸ë¦¼: ë”ë”ë” êµ¬ì²´ì ì¸ procedure calls and returns ë¬˜ì‚¬

![](./images/image.png)

### ì½”ë©˜íŠ¸

ì•„ ì§„ì§œ ì–´ë µë„¤. %rspì™€ *%rspì˜ ì˜ë¯¸ê°€ í˜¼ë™ëœë‹¤(ì˜ë¬¸ 2.)

### ì˜ë¬¸ 1. procedure calls and returns í‘œì—ì„œ *%rsp ê°’ì´ resume addressë¡œ ì´ˆê¸°í™”ë˜ëŠ” ì´ìœ 

ìš”ì•½: call func í•˜ë©´ ì´ call ì—°ì‚°ìê°€ ì•Œì•„ì„œ ë³µê·€ ìœ„ì¹˜ë¥¼ ìŠ¤íƒì— í‘¸ì‹œí•˜ëŠ”ë°, í‘¸ì‹œ ì—°ì‚°ì€ ë‹¹ì—°íˆ %rspë¥¼ decrementì‹œí‚´. ê·¸ë˜ì„œ ìŠ¤íƒ í¬ì¸í„° ê°’ì„ ë””ë ˆí¼ëŸ°ì‹±í•˜ë©´ ë³µê·€ ìœ„ì¹˜ë¡œ ëŒì•„ì˜¤ê²Œ ë¨. 

x86-64ì—ì„œ í•¨ìˆ˜ í˜¸ì¶œ(call)ê³¼ ë³µê·€(ret)ê°€ ì´ë£¨ì–´ì§€ëŠ” ë°©ì‹ì„ ê°„ë‹¨íˆ ì •ë¦¬í•˜ë©´ ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤:

1.	call ëª…ë ¹ì–´ê°€ ìˆ˜í–‰ë˜ë©´

â€¢	í˜„ì¬ ì‹¤í–‰ ìœ„ì¹˜(ë‹¤ìŒì— ì‹¤í–‰ë  ëª…ë ¹ì–´ì˜ ì£¼ì†Œ, ì¦‰ resume address)ë¥¼ ìŠ¤íƒì— í‘¸ì‹œ(push).

â€¢	PC(í”„ë¡œê·¸ë¨ ì¹´ìš´í„°)ë¥¼ í˜¸ì¶œí•˜ë ¤ëŠ” í•¨ìˆ˜ì˜ ì‹œì‘ ì£¼ì†Œë¡œ ì í”„.

2.	ret ëª…ë ¹ì–´ê°€ ìˆ˜í–‰ë˜ë©´

â€¢	ìŠ¤íƒì—ì„œ 8ë°”ì´íŠ¸(64ë¹„íŠ¸)ë¥¼ íŒ(pop)í•˜ì—¬, ê·¸ ê°’ì„ PC(í”„ë¡œê·¸ë¨ ì¹´ìš´í„°)ì— ë¡œë“œ.

â€¢	ì¦‰, ìŠ¤íƒ ê¼­ëŒ€ê¸°ì— ìˆë˜ ì£¼ì†Œ(= callì´ ì €ì¥í•´ë‘ì—ˆë˜ â€œresume addressâ€)ë¡œ ë³µê·€.

ì™œ *%rspê°€ ê³§ â€œresume addressâ€ê°€ ë˜ëŠ”ê°€?

â€¢	callì´ ì‹¤í–‰ë  ë•Œ, â€œí˜¸ì¶œ ì§í›„ì— ëŒì•„ì˜¬ ê³³(PC)â€ì˜ ì£¼ì†Œë¥¼ ìŠ¤íƒì— ì €ì¥(í‘¸ì‹œ)í•©ë‹ˆë‹¤.

â€¢	ì´ë•Œ ìŠ¤íƒ í¬ì¸í„° %rspê°€ ê°€ë¦¬í‚¤ëŠ” ìµœìƒë‹¨ ìœ„ì¹˜ì— ë°”ë¡œ ê·¸ ì£¼ì†Œê°€ ë“¤ì–´ê°€ê²Œ ë©ë‹ˆë‹¤.

â€¢	ë”°ë¼ì„œ â€œ*%rspâ€ (ìŠ¤íƒì˜ ìµœìƒë‹¨ì— ìˆëŠ” ê°’)ëŠ” ê³§ â€œë³µê·€í•  ì£¼ì†Œ(resume address)â€ê°€ ë˜ëŠ” ê²ƒì…ë‹ˆë‹¤.

ì´í›„ retì´ ì‹¤í–‰ë˜ë©´,

â€¢	popì„ í†µí•´ *%rspì— ìˆë˜ ì£¼ì†Œë¥¼ êº¼ë‚´ PCì— ë„£ê³ ,

â€¢	%rspë¥¼ 8 ì¦ê°€ì‹œì¼œ ìŠ¤íƒì„ ë˜ëŒë¦½ë‹ˆë‹¤.

ì¦‰, x86-64 í˜¸ì¶œ ê·œì•½ì—ì„œ call â†’ ìŠ¤íƒì— ë³µê·€ ì£¼ì†Œ ì €ì¥ â†’ ret â†’ ìŠ¤íƒì—ì„œ ë³µê·€ ì£¼ì†Œ ì½ì–´ì˜¤ê¸°ë¼ëŠ” íë¦„ì„ ë”°ë¥´ê¸° ë•Œë¬¸ì—,

- *â€œ*%rspê°€ ê³§ ë‹¤ìŒì— ë³µê·€í•´ì•¼ í•  ì£¼ì†Œ(resume address)â€**ë¡œ ì´ˆê¸°í™”ëœ ìƒíƒœê°€ ëœë‹¤ê³  ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
### ì˜ë¬¸ 2. *%rspê°’ì„ ë³µê·€ ì£¼ì†Œë¡œ ì“°ëŠ” ê±´ ì•Œê² ëŠ”ë°, ì´ ë§ì€ í•¨ìˆ˜ í•˜ë‚˜ì˜ ì‹¤í–‰ì´ ëë‚˜ê³  ë‚˜ë©´ ìŠ¤íƒ í¬ì¸í„°ëŠ” ë¬´ì¡°ê±´ ë³µê·€ ì£¼ì†Œë¥¼ ê°€ë¦¬í‚¤ê²Œ ëœë‹¤, ê·¸ ë§ì¸ê°€? call ì—°ì‚°ìê°€ ìµœì´ˆì— ë³µê·€ ì£¼ì†Œë¥¼ í‘¸ì‹œí•œ ë•ë¶„ì— ê·¸ëƒ¥ ìŠ¤íƒ í• ë‹¹ ê³µê°„ì„ ëª¨ë‘ í„¸ì–´ë²„ë¦¬ë©´ ìë™ìœ¼ë¡œ ì´ê²Œ ë˜ëŠ” ê±´ê°€?

ìš°ì„  ê²°ë¡ ë¶€í„° ë§ì”€ë“œë¦¬ë©´ **â€œí•¨ìˆ˜ ì‹¤í–‰ì´ ëë‚˜ â€˜retâ€™ ì§ì „ì— ì´ë¥´ë©´, ìŠ¤íƒ í¬ì¸í„°(%rsp)ëŠ” ë°˜ë“œì‹œ ë³µê·€ ì£¼ì†Œë¥¼ ê°€ë¦¬í‚¤ë„ë¡ ë³µì›ë˜ì–´ ìˆì–´ì•¼ í•œë‹¤â€**ê³  ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ë”°ë¼ì„œ ret ëª…ë ¹ì–´ê°€ ì‹¤í–‰ë  ìˆœê°„ì—ëŠ” *%rspê°€ ê³§ ë³µê·€(return)í•  ì£¼ì†Œê°€ ë©ë‹ˆë‹¤.

ì™œ í•­ìƒ ìŠ¤íƒ í¬ì¸í„°ê°€ ë³µê·€ ì£¼ì†Œë¥¼ ê°€ë¦¬í‚¤ê²Œ ë˜ëŠ”ê°€?

1.	call ëª…ë ¹ì–´ê°€ ë³µê·€ ì£¼ì†Œë¥¼ ìŠ¤íƒì— í‘¸ì‹œ

â€¢	í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•  ë•Œ, call funcê°€ í˜„ì¬ â€œë‹¤ìŒì— ì‹¤í–‰í•  ëª…ë ¹ì–´ ì£¼ì†Œ(PC)â€ë¥¼ ìŠ¤íƒì— ì €ì¥í•©ë‹ˆë‹¤.

â€¢	ì´ë•Œ %rspëŠ” â€œë³µê·€ ì£¼ì†Œâ€ê°€ ë“¤ì–´ ìˆëŠ” ë©”ëª¨ë¦¬ ìœ„ì¹˜ë¥¼ ê°€ë¦¬í‚¤ê²Œ ë©ë‹ˆë‹¤.

2.	í•¨ìˆ˜ ë‚´ë¶€ì—ì„œ ìŠ¤íƒ í”„ë ˆì„ì„ ë§Œë“¤ê³  í•´ì œ

â€¢	ì¼ë°˜ì ì¸ x86-64 ê´€ë¡€(System V ABI ë“±)ì—ì„œ, í•¨ìˆ˜ ì§„ì… ì‹œ â€œí”„ë¡œë¡œê·¸(prologue)â€ ê³¼ì •ì—ì„œ

```plain text
pushq   %rbp       ; (ì˜› RBPë¥¼ ìŠ¤íƒì— ì €ì¥)
movq    %rsp, %rbp ; (RBPë¥¼ í˜„ì¬ ìŠ¤íƒ ì£¼ì†Œë¡œ ê°±ì‹ )
subq    $â€¦, %rsp   ; (ì§€ì—­ ë³€ìˆ˜ / ì„ì‹œ ê³µê°„ í• ë‹¹)
```

ì™€ ê°™ì€ ì‹ìœ¼ë¡œ ìŠ¤íƒì— ì¼ë¶€ ê³µê°„ì„ í• ë‹¹(= ìŠ¤íƒ í¬ì¸í„°ë¥¼ ì•„ë˜ë¡œ ë‚´ë¦¼)í•©ë‹ˆë‹¤.

â€¢	ë°˜ëŒ€ë¡œ ë¦¬í„´í•˜ê¸° ì§ì „ â€œì—í•„ë¡œê·¸(epilogue)â€ì—ì„œëŠ”

```plain text
movq    %rbp, %rsp ; (ìŠ¤íƒ í¬ì¸í„°ë¥¼ RBPê°€ ìˆë˜ ìœ„ì¹˜ë¡œ ë³µì›)
popq    %rbp       ; (ì˜› RBP ê°’ì„ ë³µì›, %rspëŠ” 8ë°”ì´íŠ¸ ì˜¬ë¼ê°)
```

ì²˜ëŸ¼ í•¨ìˆ˜ ì‹¤í–‰ ì¤‘ ì¶”ê°€ë¡œ ì¡ì•„ ë‘ì—ˆë˜ ìŠ¤íƒ ê³µê°„ì„ ëª¨ë‘ í•´ì œ(= ìŠ¤íƒ í¬ì¸í„°ë¥¼ ë‹¤ì‹œ ì˜¬ë¦¼)í•´ë²„ë¦½ë‹ˆë‹¤.

â€¢	ì´ ì—í•„ë¡œê·¸ë¥¼ ë§ˆì¹˜ë©´, ìŠ¤íƒ í¬ì¸í„°(%rsp)ëŠ” ë‹¤ì‹œ â€œë³µê·€ ì£¼ì†Œâ€ê°€ ë“¤ì–´ ìˆëŠ” ì§€ì ì„ ê°€ë¦¬í‚¤ê²Œ ë©ë‹ˆë‹¤.

3.	ret ëª…ë ¹ì–´

â€¢	ë§ˆì§€ë§‰ì— retì€ popê³¼ ê°™ì€ ë™ì‘ì„ ìˆ˜í–‰í•˜ì—¬, (%rsp)(= ë³µê·€ ì£¼ì†Œ)ë¥¼ êº¼ë‚´ PC(í”„ë¡œê·¸ë¨ ì¹´ìš´í„°)ë¡œ ë¡œë“œí•©ë‹ˆë‹¤.

â€¢	ì´ë ‡ê²Œ í•¨ìœ¼ë¡œì¨ í˜¸ì¶œí•œ í•¨ìˆ˜ë¡œ ë³µê·€(return)í•˜ê²Œ ë˜ì£ .

ì¦‰, í•¨ìˆ˜ëŠ” ìê¸° ìŠ¤íƒ í”„ë ˆì„ì„ ì‚¬ìš©í•˜ê¸° ì „(í”„ë¡œë¡œê·¸)ê³¼ ì‚¬ìš©í•œ ë’¤(ì—í•„ë¡œê·¸)ì— ìŠ¤íƒ í¬ì¸í„°ë¥¼ ì ì ˆíˆ ì¡°ì •í•˜ê³ , ìµœì¢…ì ìœ¼ë¡œ â€œë³µê·€ ì£¼ì†Œâ€ê°€ ì €ì¥ëœ ì§€ì ìœ¼ë¡œ %rspë¥¼ ë˜ëŒë ¤ ë†“ìŠµë‹ˆë‹¤. ë°”ë¡œ ì´ ë•ë¶„ì—, í•¨ìˆ˜ê°€ ëë‚˜ë©´(ì •í™•íˆëŠ” ret ì§ì „) *%rspê°€ ë³µê·€ ì£¼ì†Œê°€ ë˜ëŠ” ê²ƒì…ë‹ˆë‹¤.

â€œê·¸ëƒ¥ ìŠ¤íƒ í• ë‹¹ ê³µê°„ì„ ëª¨ë‘ í„¸ì–´ë²„ë¦¬ë©´ ìë™ìœ¼ë¡œ ë˜ëŠ” ê±´ê°€?â€ì— ëŒ€í•´

â€¢	â€œìë™â€ì´ë¼ê¸°ë³´ë‹¤ëŠ”, í•¨ìˆ˜ ì—í•„ë¡œê·¸(ë˜ëŠ” ëª…ì‹œì  pop / leave ë“±)ì—ì„œ â€˜ì§ì ‘â€™ ìŠ¤íƒ í¬ì¸í„°ë¥¼ ì›ë˜ ìœ„ì¹˜ë¡œ ë˜ëŒë ¤ ë†“ëŠ” ê²ƒì…ë‹ˆë‹¤.

â€¢	ì´ ê³¼ì •ì„ â€œìŠ¤íƒ í”„ë ˆì„ í•´ì œâ€ë¼ê³  ë¶€ë¥´ë©°, ê²°ê³¼ì ìœ¼ë¡œ %rspê°€ í•¨ìˆ˜ ì‹œì‘ ì‹œì ê³¼ ê°™ì€ ìœ„ì¹˜(ë³µê·€ ì£¼ì†Œê°€ ìˆëŠ” ìœ„ì¹˜)ë¡œ ë³µì›ë©ë‹ˆë‹¤.

â€¢	ê·¸ë ‡ê²Œ ë³µì›ëœ ìƒíƒœì—ì„œ retì„ ì‹¤í–‰í•˜ë©´, *%rsp(=ë³µê·€ ì£¼ì†Œ)ê°€ popë˜ì–´ PCë¡œ ë“¤ì–´ê°€ë¯€ë¡œ í˜¸ì¶œí•œ ìª½ìœ¼ë¡œ ëŒì•„ê°€ê²Œ ë˜ì£ .

ì •ë¦¬í•˜ìë©´,

1.	callì´ ë³µê·€ ì£¼ì†Œë¥¼ ìŠ¤íƒì— í‘¸ì‹œí•œë‹¤.

2.	í•¨ìˆ˜ëŠ” ìŠ¤íƒ í”„ë ˆì„ì„ ë§Œë“¤ê¸° ìœ„í•´ %rspë¥¼ ë” ë‚´ë ¤ ì“°ì§€ë§Œ, ë‚˜ì¤‘ì— ë˜ëŒë ¤ ë†“ëŠ”ë‹¤.

3.	í•¨ìˆ˜ê°€ ëë‚  ë•ŒëŠ” %rspê°€ ë³µê·€ ì£¼ì†Œê°€ ë“¤ì–´ ìˆëŠ” ê³³ì„ ë‹¤ì‹œ ê°€ë¦¬í‚¤ê²Œë” â€œì§ì ‘â€ ë˜ëŒë¦¬ëŠ” ì½”ë“œê°€ ë“¤ì–´ ìˆë‹¤.

4.	retì€ ê·¸ ìœ„ì¹˜(*%rsp)ë¥¼ êº¼ë‚´ í”„ë¡œê·¸ë¨ ì¹´ìš´í„°ì— ë¡œë“œí•¨ìœ¼ë¡œì¨ ë³µê·€í•œë‹¤.

ì´ëŸ° ì¼ë ¨ì˜ ê³¼ì •ì„ í†µì¹­í•´ **â€œí˜¸ì¶œ ê·œì•½(calling convention)â€**ì´ë¼ê³  í•˜ë©°, ëª¨ë“  C ì»´íŒŒì¼ëŸ¬ê°€ ì´ ê·œì•½ì— ë§ì¶° ì½”ë“œë¥¼ ìƒì„±í•˜ê¸° ë•Œë¬¸ì— â€œí•¨ìˆ˜ ëì—ì„œ %rspê°€ ë³µê·€ ì£¼ì†Œë¥¼ ê°€ë¦¬í‚¤ê²Œ ëœë‹¤â€ëŠ” ì‚¬ì‹¤ì´ ë³´ì¥ë©ë‹ˆë‹¤.

### ì˜ë¬¸ 3. %rspì™€ *%rspì˜ ì˜ë¯¸ê°€ í˜¼ë™ëœë‹¤

%rspëŠ” â€œìŠ¤íƒ í¬ì¸í„°â€ ë ˆì§€ìŠ¤í„° ìì²´(64ë¹„íŠ¸ ì£¼ì†Œê°’)ì´ê³ , *%rsp(í˜¹ì€ (%rsp))ëŠ” ê·¸ ë ˆì§€ìŠ¤í„°ê°€ ê°€ë¦¬í‚¤ëŠ” ë©”ëª¨ë¦¬ ìœ„ì¹˜ì— ì €ì¥ëœ ì‹¤ì œ ë°ì´í„°(8ë°”ì´íŠ¸)ì…ë‹ˆë‹¤.

â€¢	%rsp (ìŠ¤íƒ í¬ì¸í„° ë ˆì§€ìŠ¤í„°)

ìŠ¤íƒì—ì„œ â€œìµœìƒë‹¨(top)â€ì´ ì–´ë””ì¸ì§€ ê°€ë¦¬í‚¤ëŠ” 64ë¹„íŠ¸ ì£¼ì†Œê°’ì„ ë‹´ìŠµë‹ˆë‹¤. ì¦‰, ìŠ¤íƒì— pushë¥¼ í•˜ë©´ %rspê°€ 8ë§Œí¼ ê°ì†Œí•˜ê³ , popì„ í•˜ë©´ 8ë§Œí¼ ì¦ê°€í•©ë‹ˆë‹¤.

â€¢	*%rsp (ë©”ëª¨ë¦¬ ì°¸ì¡°, (%rsp)ë¡œ ì“°ê¸°ë„ í•¨)

%rspê°€ ê°€ë¦¬í‚¤ëŠ” ì£¼ì†Œì— ì €ì¥ëœ ë©”ëª¨ë¦¬ ë‚´ìš©ì„ ì˜ë¯¸í•©ë‹ˆë‹¤. ì˜ˆë¥¼ ë“¤ì–´ movq (%rsp), %raxëŠ” â€œìŠ¤íƒì˜ top(í˜„ì¬ %rspê°€ ê°€ë¦¬í‚¤ëŠ” ê³³)ì— ìˆëŠ” 8ë°”ì´íŠ¸ë¥¼ ì½ì–´ì„œ %rax ë ˆì§€ìŠ¤í„°ì— ê°€ì ¸ì˜¨ë‹¤â€ë¼ëŠ” ëœ»ì…ë‹ˆë‹¤.

ì •ë¦¬í•˜ìë©´,

â€¢	%rspëŠ” â€œìŠ¤íƒì˜ ì–´ë””ì—â€ ë°ì´í„°ë¥¼ ë„£ê±°ë‚˜ êº¼ë‚¼ì§€ë¥¼ ê°€ë¦¬í‚¤ëŠ” ì£¼ì†Œê°’.

â€¢	*%rsp í˜¹ì€ (%rsp)ëŠ” ê·¸ ì£¼ì†Œì— ìˆëŠ” ì‹¤ì œ ë°ì´í„°ë¥¼ ì˜ë¯¸í•©ë‹ˆë‹¤.

## Practice 3.32

### ë¬¸ì œ

ì•„ë˜ ì—°ì‚°ì—ì„œ íë¦„ì„ ì¶”ì í•˜ê¸°.

![](./images/IMG_0510.png)

### í’€ì´

![](./images/IMG_0511.jpg)

í‹€ë¦°ì : ë ˆì§€ìŠ¤í„° ê°’ì€ ëª…ë ¹ì–´ ì‹¤í–‰ ë’¤ì— ë°”ë€ë‹¤!

## Practice 3.33

### ë¬¸ì œ

c codeì™€ assembly ì½”ë“œê°€ ë‹¤ìŒê³¼ ê°™ì„ ë•Œ

```assembly
*u += a;
*v += b;
return sizeof(a) + sizeof(b)

// assembly
procrob:
	movslq %edi, %rdi
	addq %rdi, (%rdx)
	addb %sil, (%rcx)
	movl $6, %eax
	ret		
```

ë„¤ ë³€ìˆ˜ì˜ ê°€ëŠ¥í•œ ìˆœì„œì™€ íƒ€ì…ì„ ì •ì˜í•˜ê¸°

### í’€ì´

ë§¤ê°œë³€ìˆ˜ ë ˆì§€ìŠ¤í„°ëŠ” ë‹¤ìŒê³¼ ê°™ìŒ

![](./images/image.png)

![](./images/IMG_0514.png)

## ê°œêµ¬ì½” 3. ë§¤ê°œë³€ìˆ˜ ì „ë‹¬ì— ëŒ€í•´

### ê°œë…

### êµ¬í˜„

ì˜ˆì œ ì„¤ëª…: ë‹¤ì–‘í•œ íƒ€ì…ì˜ ì—¬ëŸ¬ ì¸ìˆ˜ë¥¼ ê°€ì§„ í•¨ìˆ˜ ì˜ˆì‹œ (example of function with multiple arguments of different types.) ì¸ìˆ˜ 1-6ì€ ë ˆì§€ìŠ¤í„°ë¡œ ë°”ë¡œ, ë‚˜ë¨¸ì§€ ì¹œêµ¬ë“¤ì€ ìŠ¤íƒìœ¼ë¡œ íŒ¨ìŠ¤ ëœë‹¤. (Arguments 1-6 are passed in registers, while arguments 7-8 are passed on the stack.)

```assembly
(a) C code
void proc(long a1, long *a1p, 
					int a2, int *a2p,
					short a3, short *a3p,
					char a4, char *a4p)
{
	*a1p += a1;
	*a2p += a2;
	*a3p += a3;
	*a4p += a4;	
}

(b) Generated aassembly code
void proc(a1, a1p, a2, a2p, a3, a3p, a4, a4p)
Arguments passed as follows:
	a1 in %rdi (64 bits)
	a1p in %rsi (64 bits)
	a2 in %edx (32 bits)
	a2p in %rcx (64 bits)
	a3 in %r8w (16 bits)
	a3p in %r9 (64 bits)
	a4 at %rsp+8 (8 bits)
	a4p at %rsp+16 (64 bits)

proc:
	movq 16(%rsp), %rax // Fetch a4p (64 bits) <---- ìŠ¤íƒì—ì„œ ê°€ì ¸ì˜¤ê¸°
	addq %rdi, (%rsi) // *a1p += a1 (64 bits) 
	addl %edx, (%rcx) // *a2p += a2 (32 bits)
	addw %r8w, (%r9) // *a3p += a3 (16 bits) <--- ì´ê¹Œì§€ëŠ” ê·¸ëƒ¥ ì¸ìˆ˜ ë ˆì§€ìŠ¤í„°ë¡œ ë„˜ê²¨ë°›ì€ ê²ƒë“¤. 
	movl 8(%rsp), %edx // Fetch a4 (8 bits)  <--- ë‹¤ì‹œ ìŠ¤íƒì—ì„œ ê°€ì ¸ì˜¤ê¸°.
	addb %dl, (%rax) // *a4p += a4 (8 bits) <--- ì›í•˜ëŠ” ì—°ì‚° ìˆ˜í–‰.
ret // return
```

ê·¸ë¦¼: procì˜ ìŠ¤íƒ í”„ë ˆì„. ì¸ìˆ˜ a4ì™€ a4pëŠ” ìŠ¤íƒìœ¼ë¡œ ë„˜ê²¨ì§„ë‹¤. 

![](./images/IMG_02A1AB3A747F-1.jpeg)

### ì½”ë©˜íŠ¸

ì˜¤ì¼€ì´, ê°€ì ¸ì˜¤ëŠ” ê±´ ì´í•´í–ˆì–´. ì´ì œ ì´ê±¸ ê°€ì ¸ì˜¤ê¸° ìœ„í•´ ì €ì¥í•˜ëŠ” ê³¼ì •ì„ ë´ì•¼ í•œë‹¤.(ìŠ¤íƒì˜ ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ ì‚¬ìš© ë°©ë²•)

## ê°œêµ¬ì½” 4. 

### ê°œë…

ì–´ë–¤ ê²½ìš°ì— ë¡œì»¬ ë°ì´í„°ëŠ” (ë ˆì§€ìŠ¤í„°ê°€ ì•„ë‹Œ) ë©”ëª¨ë¦¬ì— ì €ì¥ë¼ì•¼ í•œë‹¤.

- ê·¸ëƒ¥ ë³€ìˆ˜ê°€ ë„ˆë¬´ ë§ì•„ì„œ ë ˆì§€ìŠ¤í„°ê°€ ë¶€ì¡±í•  ë•Œ there are not enough registers to hold all of the local data
- ì£¼ì†Œ ì—°ì‚°ì &ë¥¼ ì¨ì•¼ í•˜ëŠ”ë°, ë ˆì§€ìŠ¤í„°ë¥¼ ìƒëŒ€ë¡œ ì´ê±¸ ì“¸ ìˆ˜ëŠ” ì—†ìŒ. the address operator & is applied to a local variable, and hence we must be able to generate and address for it
- ë°°ì—´ì´ë‚˜ êµ¬ì¡°ì²´ ê°™ì€ í° ì¹œêµ¬ë“¤ì„ ì§€ì—­ë³€ìˆ˜ë¡œ ì¨ì•¼ í•  ë•Œ, ì´ëŸ°ê±¸ ë ˆì§€ìŠ¤í„°ì— ë„£ì„ ìˆ˜ë„ ì—†ìŒ. some of the local variables are arrays or structures and hence must be accessed by array or structure references. We will discuss this possibility when we describe how arrays and structures are allocated.
### êµ¬í˜„

```assembly
(a) code for swap_add and calling function
long swap_add(long *xp, long *yp)
{
	long x = *xp;
	long y = *yp;
	*xp = y;
	*yp = x;
	return x + y
}

long caller()
{
	long arg1 = 534;
	long arg2 = 1057;
	long sum = swap_add(&arg1, &arg2);
	long diff = arg1 - arg2;
	return sum * diff;
}
```

```assembly
(b) Generated assembly code for calling function
long caller()
caller:
	subq $16, %rsp // allocate 16 bytes for stack frame
	movq $534, (%rsp) // store 534 in arg1 (í‘¸ì‹œ ì—°ì‚° ì•ˆ í•˜ëŠ” ëŒ€ì‹  rsp ì£¼ì†Œ ë¦¬í„°ëŸ´ì„ ì§ì ‘ ê°€ì‚°í•´ì„œ ì €ì¥ ì¤‘)
	movq $1057, 8(%rsp) // store 1057 in arg2
	leaq 8(%rsp), %rsi // compute &arg2 as second argument
	movq %rsp, %rdi // compute &arg1 as first argument
	call swap_add // call swap_add(&arg1, &arg2)
	movq (%rsp), %rdx // get arg1
	subq 8(%rsp), %rdx // compute diff = arg1 - arg2
	imulq %rdx, %rax // compute sum * diff
	addq $16, %rsp // deallocate stack frame
	ret // return
```

### ì½”ë©˜íŠ¸

ì—†ìŒ. ì•„ë˜ì— ë” ë³µì¡í•œ ì˜ˆì‹œë¥¼ ë³¼ ê²ƒ.

## ê°œêµ¬ì½” 5. ìŠ¤íƒì˜ ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ 2 (ë§¤ê°œë³€ìˆ˜ ì „ë‹¬ê³¼ ì—°ê´€ì§€ì–´ ì´í•´í•´ì•¼ í•¨)

### ê°œë…

### êµ¬í˜„

```c
(a) C code for calling function
long call_proc()
{
	long x1 = 1; int x2 = 2;
	short x3 = 3; char x4 = 4;
	proc(x1, &x1, x2, &x2, x3, &x3, x4, &x4);
	return (x1+x2)*(x3-x4)
}
```

```assembly
long call_proc()
call_proc:
	set up argument to proc
	subq $32, %rsp // allocate 32-byte stack frame
	movq $1, 24(%rsp) store 1 in &x1
	movl $2, 20(%rsp) store 2 in &x2
	movw $3, 18(%rsp) store 3 in &x3
	leaq 17(%rsp), %rax create &x4  <- í˜„ì¬ ìŠ¤íƒ í¬ì¸í„°ì—ì„œ 17ì¹¸ ì•„ë˜ì˜ ì£¼ì†Œë¥¼ raxì— ì €ì¥í•˜ê³ , 
	movq %rax, 8(%rsp) store &x4 as argument 8 ê·¸ ì£¼ì†Œë¥¼ ë‹¤ì‹œ ìŠ¤íƒ í¬ì¸í„°ì—ì„œ 8ì¹¸ ì•„ë˜ì— ì €ì¥.
	movl $4, (%rsp) store 4 as argument 7. 4ë¥¼ rspê°€ ê°€ë¦¬í‚¤ëŠ” ê°’ìœ¼ë¡œ ì¶”ê°€
	leaq 18(%rsp), %r9 pass &x3 as argument 6. 
	movl $3, %r8d pass 3 as argument 5
	leaq 20(%rsp), %rcx pass %x2 as argument 4
	movl $2, %edx pass 2 as argument 3
	leaq 24(%rsp), %rsi pass &x1 as argument 2
	movl $1, %edi pass 1 as argument 1
	call proc
	movslq 20(%rsp), %rdx Get x2 and convert to long
	addq 24(%rsp), %rdx compute x1 + x2
	movswl 18(%rsp), %eax get x3 and convert to int
	movsbl 17(%rsp), %ecx get x4 and convert to int
	subl %ecx, %eax compute x3-x4
	cltq convert to long
	imulq %rdx, %rax compute (x1+x2) * (x3-x4)
	addq $32, %rsp deallocate stack frame
	ret return
	
```

ê·¸ë¦¼: ìœ„ ì½”ë“œì˜ ì¸ìˆ˜ë“¤ì´ ì €ì¥ëœ ëŸ° íƒ€ì„ ìŠ¤íƒ. ì§€ì—­ë³€ìˆ˜ë“¤ê³¼, ì¸ìˆ˜ë¡œ ë„˜ì–´ê°€ëŠ” ê°’ë“¤ì´ return address ìœ„ì— ì €ì¥ëœ ëª¨ìŠµì„ ë³¼ ìˆ˜ ìˆìŒ.

![](./images/IMG_B90690423E50-1.jpeg)

### ì½”ë©˜íŠ¸ 1. ê·¸ë ‡ë‹¤ë©´ ëŸ° íƒ€ì„ ìŠ¤íƒì—ì„œ return address ìƒë‹¨ì— callerì˜ ì§€ì—­ë³€ìˆ˜ê°€ ì €ì¥ë˜ê³ , ê·¸ ìœ„ì— ë ˆì§€ìŠ¤í„°ë¡œ ë„˜ì–´ê°€ì§€ ëª»í•œ, calleeë¡œ ë„˜ê²¨ì¤„ ì¸ìˆ˜ë“¤ì´ ì €ì¥ë˜ëŠ” ê±´ê°€?

í•œ ì¤„ ìš”ì•½: ë§ìŒ.

ì¼ë°˜ì ì¸ x86-64 í•¨ìˆ˜ í˜¸ì¶œ ê·œì•½(System V ABI)ì„ ê¸°ì¤€ìœ¼ë¡œ ì„¤ëª…í•˜ë©´, ì§ˆë¬¸í•˜ì‹  **â€œìŠ¤íƒ í”„ë ˆì„ ë‚´ì—ì„œ ì§€ì—­ë³€ìˆ˜ì™€ ìŠ¤íƒì— ìŒ“ì¸ í•¨ìˆ˜ ì¸ìˆ˜ì˜ ìƒëŒ€ì  ìœ„ì¹˜â€**ëŠ” ëŒ€ëµ ë‹¤ìŒê³¼ ê°™ì€ ìˆœì„œë¥¼ ë”°ë¦…ë‹ˆë‹¤.

1. í° íë¦„ (ì½œëŸ¬ì™€ ì½œë¦¬ì˜ ìŠ¤íƒ í”„ë ˆì„)

í•¨ìˆ˜ A(ì½œëŸ¬)ê°€ í•¨ìˆ˜ B(ì½œë¦¬)ë¥¼ í˜¸ì¶œí•œë‹¤ê³  í•  ë•Œ,

1.	Aê°€ í˜¸ì¶œ ì¤€ë¹„ë¥¼ í•˜ë©´ì„œ í•„ìš”í•œ ì¸ìˆ˜(íŠ¹íˆ ë ˆì§€ìŠ¤í„°ë¡œ ë‹¤ ë‹´ì§€ ëª»í•˜ëŠ” ë‚˜ë¨¸ì§€)ë¥¼ ìŠ¤íƒì— ì €ì¥

2.	Aê°€ call Bë¥¼ ì‹¤í–‰í•˜ë©´,

â€¢	â€œë³µê·€ ì£¼ì†Œ(return address)â€ê°€ ìŠ¤íƒì— push

â€¢	PC(í”„ë¡œê·¸ë¨ ì¹´ìš´í„°)ëŠ” B í•¨ìˆ˜ë¡œ ì í”„

3.	BëŠ” ìì‹ ì´ í•„ìš”ë¡œ í•˜ëŠ” ìŠ¤íƒ ê³µê°„(ì§€ì—­ ë³€ìˆ˜ ë“±)ì„ %rspë¥¼ ì¡°ì •í•˜ì—¬ í• ë‹¹

4.	Bê°€ ì¼ì„ ë§ˆì¹˜ê³  retì„ ì‹¤í–‰

5.	ìŠ¤íƒì—ì„œ ë³µê·€ ì£¼ì†Œë¥¼ pop í›„, í”„ë¡œê·¸ë¨ íë¦„ì´ ë‹¤ì‹œ Aë¡œ ë³µê·€

6.	Aê°€ ë” ì´ìƒ í•„ìš” ì—†ëŠ” ìŠ¤íƒ ê³µê°„ì„ íšŒìˆ˜(addq $..., %rsp ë“±)

ì´ëŸ° ì‹ìœ¼ë¡œ ê° í˜¸ì¶œë§ˆë‹¤ ìŠ¤íƒ í”„ë ˆì„ì´ **â€œìŒ“ì˜€ë‹¤(pushed)â€**ê°€ í•¨ìˆ˜ê°€ ëë‚˜ë©´ **â€œí•´ì œ(pop)â€**ë˜ëŠ” êµ¬ì¡°ì…ë‹ˆë‹¤.

2. êµ¬ì²´ì ìœ¼ë¡œ â€œreturn address ìœ„ì— ì§€ì—­ ë³€ìˆ˜ì™€ í•¨ìˆ˜ ì¸ìˆ˜ê°€ ë†“ì´ë‚˜?â€ë¥¼ ì‚´í´ë³´ê¸°

ì§ˆë¬¸ì—ì„œ ì£¼ì–´ì§„ ì½”ë“œ(call_proc)ë¥¼ ì‚´í´ë³´ë©´,

```plain text
call_proc:
    subq $32, %rsp                ; (1)  32ë°”ì´íŠ¸ ìŠ¤íƒ í• ë‹¹
    movq $1, 24(%rsp)             ; (2)  long x1 = 1
    movl $2, 20(%rsp)             ; (3)  int  x2 = 2
    movw $3, 18(%rsp)             ; (4)  short x3 = 3
    ...
    call proc                     ; (N)  ë‹¤ë¥¸ í•¨ìˆ˜ proc í˜¸ì¶œ
    ...
    addq $32, %rsp                ; ìŠ¤íƒ ê³µê°„ í•´ì œ
    ret
```

â€¢	í•¨ìˆ˜ ì‹œì‘ ì‹œì ì— ì´ë¯¸ ìŠ¤íƒì—ëŠ” â€œcall_procâ€ì„ í˜¸ì¶œí•œ ì¸¡ì´ ì €ì¥í•œ return addressê°€ ìˆìŠµë‹ˆë‹¤. (ë” ì•„ë˜ ì£¼ì†Œ ìª½ì— ìˆìŒ)

â€¢	subq $32, %rsp ì´í›„ì˜ ê³µê°„ì´ call_proc í•¨ìˆ˜(ì½œëŸ¬)ì˜ ì§€ì—­ë³€ìˆ˜ì™€ â€œí•¨ìˆ˜ procì— ë„˜ê¸¸ ì¸ìˆ˜â€ ë“±ì„ ë†“ëŠ” êµ¬ì—­ì´ ë©ë‹ˆë‹¤.

â€¢	ê·¸ëŸ¬ë¯€ë¡œ â€œreturn address ë°”ë¡œ ìœ„(ë” ë†’ì€ ë©”ëª¨ë¦¬ ì£¼ì†Œ) ìª½ì— call_procì´ ì„ì‹œë¡œ ì“¸ ë°ì´í„°ë“¤(ì§€ì—­ ë³€ìˆ˜, ìŠ¤íƒìœ¼ë¡œ ë„˜ì–´ê°€ëŠ” ì¸ìˆ˜)ì´ ë°°ì¹˜ëœë‹¤â€ë¼ê³  ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ì¦‰, ìŠ¤íƒ ê¸°ì¤€ìœ¼ë¡œ ë‚®ì€ ìª½(ì£¼ì†Œê°€ ì‘ì€ ìª½)ì—ëŠ” return addressê°€ ìˆê³ , ê·¸ ìœ„ìª½(ì£¼ì†Œê°€ í° ìª½)ì— callerì˜ ì§€ì—­ ë³€ìˆ˜ ë° ìŠ¤íƒ ì¸ìˆ˜ê°€ ë†“ì…ë‹ˆë‹¤.

(1) Return addressê°€ ì´ë¯¸ ìŠ¤íƒì— ìˆìŒ

call call_procì´ ì‹¤í–‰ë  ë•Œ ìë™ìœ¼ë¡œ push ëœ ê°’:

```plain text
                ...
                |               | <- ë†’ì€ ì£¼ì†Œ
                +---------------+
                |  ì§€ì—­ ë³€ìˆ˜     |  (call_procì´ subqë¡œ í™•ë³´)
                |  ì¸ìˆ˜ backup  |
                +---------------+
                | return addr   |  (call call_proc ì‹œ pushëœ ë³µê·€ ì£¼ì†Œ)
                +---------------+
                | ...           |
                +---------------+ <- ë‚®ì€ ì£¼ì†Œ
```

â€¢	ê·¸ë¦¼ì—ì„œ return addrì€ ì½œëŸ¬(= call_procì„ ë¶€ë¥¸ ìª½)ê°€ call call_procì„ ì‹¤í–‰í•˜ë©´ì„œ ìŠ¤íƒì— ìŒ“ì¸ ê°’.

(2) call_procì´ subq $32, %rsp`ë¡œ 32ë°”ì´íŠ¸ í™•ë³´

â€¢	ì´ 32ë°”ì´íŠ¸ëŠ” call_proc í•¨ìˆ˜ê°€ ë§ˆìŒëŒ€ë¡œ ì“°ëŠ” ê³µê°„ì…ë‹ˆë‹¤. ì˜ˆ: ì§€ì—­ ë³€ìˆ˜ x1, x2, x3, x4ë¥¼ ì €ì¥í•˜ê±°ë‚˜, ë‹¤ë¥¸ í•¨ìˆ˜ì— ë„˜ê¸¸ ìŠ¤íƒ ì¸ìˆ˜ë¥¼ ì„ì‹œë¡œ ë‘ëŠ” ë“±.

(3) call_procì´ ìŠ¤íƒ ê³µê°„ ì¼ë¶€ì— ì§€ì—­ ë³€ìˆ˜ë¥¼ ì €ì¥

â€¢	ì˜ˆ: movq $1, 24(%rsp) â†’ ìŠ¤íƒ í”„ë ˆì„ì˜ íŠ¹ì • ì˜¤í”„ì…‹(24) ìœ„ì¹˜ì— x1=1ì„ ê¸°ë¡

(4) ì¶”ê°€ë¡œ, ë„˜ì–´ê°ˆ ì¸ìˆ˜ë„ ìŠ¤íƒì— ë°°ì¹˜

â€¢	6ë²ˆì§¸ ì´í›„ ì¸ìˆ˜ë¶€í„°ëŠ” ë ˆì§€ìŠ¤í„° ëŒ€ì‹  ìŠ¤íƒì— ë†“ì—¬ì•¼ í•˜ê±°ë‚˜

â€¢	í˜¹ì€ ì»´íŒŒì¼ëŸ¬ê°€ â€œêµ³ì´ ë ˆì§€ìŠ¤í„° ì¸ìˆ˜ë„ ì„ì‹œë¡œ ìŠ¤íƒì— ì“°ìâ€ë¼ê³  íŒë‹¨í•  ìˆ˜ë„ ìˆìŒ (ABIë‚˜ ìµœì í™” ì˜µì…˜ì— ë”°ë¼ ë‹¬ë¼ì§).

3. ê²°ë¡ ì ìœ¼ë¡œ â€œì½œëŸ¬ì˜ ì§€ì—­ ë³€ìˆ˜, ê·¸ë¦¬ê³  ìŠ¤íƒ ì¸ìˆ˜ê°€ return address ìœ„ì— ìœ„ì¹˜í•˜ëŠëƒ?â€

â€¢	ë„¤, ë³´í†µì€ â€œreturn addressë³´ë‹¤ ë†’ì€ ì£¼ì†Œ ìª½â€(= ìŠ¤íƒ í”„ë ˆì„ ìƒë‹¨ë¶€)ì— Callerì˜ ì§€ì—­ ë³€ìˆ˜ì™€ ìŠ¤íƒ ì¸ìˆ˜ë“¤ì´ ë†“ì…ë‹ˆë‹¤.

â€¢	ì¦‰, ì•„ë˜ìª½(ë‚®ì€ ì£¼ì†Œ)ì— return addressê°€ ê¹”ë ¤ ìˆê³ , ê·¸ ìœ„ì— callerê°€ ì‚¬ìš©í•˜ëŠ” ì„ì‹œ ê³µê°„ì´ ì˜¤ëŠ” êµ¬ì¡°ì…ë‹ˆë‹¤.

â€¢	í•¨ìˆ˜ê°€ ëë‚  ë• ì´ ì„ì‹œ ê³µê°„ì„ addq $..., %rspë¡œ í•´ì œí•˜ë©´ ë‹¤ì‹œ return addressê°€ ìŠ¤íƒ topì´ ë˜ê³ , ìµœì¢… retì´ ê·¸ ì£¼ì†Œë¥¼ popí•˜ì—¬ ë³µê·€í•˜ê²Œ ë©ë‹ˆë‹¤.

ë³´ì¶©) x86-64 System V í•¨ìˆ˜ í˜¸ì¶œ ê·œì•½ ìš”ì•½

1.	ìµœëŒ€ 6ê°œì˜ ì •ìˆ˜/í¬ì¸í„°í˜• ì¸ìëŠ” ë ˆì§€ìŠ¤í„°(%rdi, %rsi, %rdx, %rcx, %r8, %r9)ë¥¼ í†µí•´ ì „ë‹¬.

2.	ë‚˜ë¨¸ì§€ ì¸ì(7ë²ˆì§¸ ì´í›„)ë‚˜, ì¼ë¶€ ë¶€ë™ì†Œìˆ˜ì  ì¸ìëŠ” ìŠ¤íƒ ê³µê°„ì— ë†“ì¸ë‹¤.

3.	Caller(í•¨ìˆ˜ë¥¼ ë¶€ë¥´ëŠ” ìª½)ëŠ” call ëª…ë ¹ì–´ ì§ì „, í•„ìš”í•œ ìŠ¤íƒ ì¸ìˆ˜ë¥¼ (ì¢…ì¢…) caller ìì‹ ì˜ ìŠ¤íƒ í”„ë ˆì„ ìœ„ìª½ì— ìŒ“ì•„ë‘”ë‹¤.

4.	call ëª…ë ¹ìœ¼ë¡œ return addressê°€ push ëœë‹¤.

5.	Callee(í˜¸ì¶œëœ í•¨ìˆ˜)ëŠ” ì§„ì… í›„ ìŠ¤íƒ í”„ë ˆì„ì„ ë§Œë“¤ê³ , í•„ìš”í•œ ì§€ì—­ ë³€ìˆ˜ë§Œí¼ %rspë¥¼ ê°ì†Œì‹œì¼œ ì‚¬ìš©í•œë‹¤.

6.	í•¨ìˆ˜ ì¢…ë£Œ ì‹œ Calleeê°€ %rspë¥¼ ë³µì› â†’ ret â†’ Callerë¡œ ë³µê·€.

ì´ëŸ° ì‹ìœ¼ë¡œ, ì§ˆë¬¸ì—ì„œ â€œëŸ° íƒ€ì„ ìŠ¤íƒì—ì„œ return address ìƒë‹¨ì— callerì˜ ì§€ì—­ë³€ìˆ˜ + (ìŠ¤íƒìœ¼ë¡œ ë„˜ì–´ê°€ëŠ”) ì¸ìˆ˜ë“¤ì´ í• ë‹¹ë˜ëŠ” êµ¬ì¡°ì¸ê°€?â€ë¼ëŠ” ì˜ë¬¸ì€ â€œë§ë‹¤â€ ë¼ê³  ë³´ì‹œë©´ ë©ë‹ˆë‹¤. ìŠ¤íƒì˜ ë‚®ì€ ì£¼ì†Œ(ì•„ë˜)ì—ì„œë¶€í„° ì°¨ë¡€ëŒ€ë¡œ [ ... | return address | callerì˜ ì„ì‹œ ë° ì¸ìˆ˜ | ... ] ì‹ìœ¼ë¡œ ìŒ“ì´ëŠ” ì…ˆì…ë‹ˆë‹¤.

## ê°œêµ¬ì½” 6. ë ˆì§€ìŠ¤í„° ë¡œì»¬ ì €ì¥ì†Œ

### ê°œë…

ì´ëŸ´ìˆ˜ê°€! ë ˆì§€ìŠ¤í„°ë„ ë¡œì»¬ ì €ì¥ì†Œë¡œ ì“¸ ìˆ˜ ìˆë‹¤ë‹ˆ!  

ì½œë¦¬ëŠ” ì½œëŸ¬ê°€ ì‚¬ìš©í•˜ë ¤ê³  ë‚¨ê²¨ë‘” ë ˆì§€ìŠ¤í„° ê°’ì„ ì¹¨ë²”í•´ì„œëŠ” ì•ˆ ë¨. x86-64ì€ ë ˆì§€ìŠ¤í„° ì‚¬ìš©ì„ ëª¨ë“  í”„ë¡œì‹œì ¸ì— ëŒ€í•´ ë¦¬ìŠ¤í™ í•˜ë„ë¡ í•˜ëŠ” ê·œì•½ì„ ì ìš©í•¨.

ë ˆì§€ìŠ¤í„° ê°’ì„ ìŠ¤íƒì— í‘¸ì‹œí•˜ëŠ” ì—°ì‚°ì€, ìœ„~ì— ê·¸ë¦¼ì— ë‚˜ì˜¨ saved registers ì˜ì—­ì„ ë§Œë“¤ì–´ë‚´ëŠ” ê¸°ëŠ¥ì„ í•œë‹¤. (The pushing of register values has the effect of creating the portion of the stack frame labeled â€œsaved registersâ€ in Figure 3.25. )

ì´ ê´€í–‰ ë•ë¶„ì—, Pì˜ ì½”ë“œëŠ” ì•ˆì „í•˜ê²Œ callee saved registerì— ê°’ì„ ì €ì¥í•˜ê³ (ë¬¼ë¡  ì´ì „ ê°’ë“¤ì„ ìŠ¤íƒì— ì €ì¥í•œ í›„) Që¥¼ ë¶€ë¥´ê³ , ê·¸ë¦¬ê³  ë‚˜ì„œ ë ˆì§€ìŠ¤í„°ì— ìˆëŠ” ì˜¤ì—¼ë˜ì§€ ì•Šì€ ê°’ë“¤ì„ ì“¸ ìˆ˜ ìˆë‹¤. (with this convention, the code for p can safely store a value in a callee saved register (after saving the previous value on the stack, of course), call Q, and tehn use the value in the register without risk of it having been corrupted.)

![](./images/Screenshot_2025-04-07_at_8.19.10_PM.png)

%rspë¥¼ ì œì™¸í•œ ëª¨ë“  ë ˆì§€ìŠ¤í„°ê°€ caller-saved registersë‹¤. 

caller savedë¼ëŠ” ì´ë¦„ì€ Procedure Pê°€ ë¡œì»¬ ë°ì´í„°ë¥¼ ê°€ì§€ê³  ìˆëŠ” ìƒíƒœì—ì„œ Që¥¼ ë¶€ë¥´ëŠ” ë§¥ë½ì—ì„œ ì´í•´ë  ìˆ˜ ìˆë‹¤. (The name â€œcaller savedâ€ can be understood in the context of a procedure P having some local data in such a register and calling procedure Q.)

Qê°€ ë ˆì§€ìŠ¤í„°ë¥¼ ììœ ë¡­ê²Œ ì“¸ ìˆ˜ ìˆê¸° ë•Œë¬¸ì—, ë¯¸ë¦¬ë¯¸ë¦¬ ë¡œì»¬ ë°ì´í„°ë¥¼ ì €ì¥í•´ ë‘ëŠ” ê±´ Pì˜ ì±…ì„ì´ë‹¤. (Since Q is FREE to alter this register, it is incumbent upon P (the caller) to first save the data before it makes the call.)

### êµ¬í˜„

```assembly
(a) calling function
long P(long x, long y)
{
	long u = Q(y);
	long v = Q(x);
	return u + v;
}
```

```assembly
(b) Generated assembly code for the calling function
long P(long x, long y)
x in %rdi, y in %rsi
P:
	pushq %rbp // save %rbp <-- ë­ê°€ ë“¤ì–´ ìˆì—ˆëŠ”ì§€ëŠ” ëª¨ë¥´ì§€ë§Œ ì•„ë¬´íŠ¼ ë ˆì§€ìŠ¤í„°ê°€ ë‹´ê³  ìˆë˜ ë¡œì»¬ ë°ì´í„°ë¥¼ ì•ˆì „í•˜ê²Œ ë³´ê´€í•˜ê¸° ìœ„í•´ í•˜ëŠ” ê±°ì§€?(ì˜ë¬¸ 1.)
	pushq %rbx // save %rbx
	subq $8, %rsp // align stack frame
	movq %rdi, %rbp // save x
	movq %rsi, %rdi // move y to first argument
	call Q // call Q(y)
	movq %rax, %rbx // save result
	movq %rbp, %rdi // move x to first argument
	call Q // call Q(x)
	addq %rbx, %rax // add saved Q(y) to Q(x)
	addq $8, %rsp // deallocate last part of stack
	popq %rbx // restore %rbx
	popq %rbp // restore %rbp
	ret
```

ì´ ê²½ìš° GCCëŠ” ë‘ ê°œì˜ callee saved registersë¥¼ ì“°ëŠ” ì½”ë“œë¥¼ ìƒì„±. %rbp to hold x, %rbx to hold ê³„ì‚°ëœ Q(y) ê°’.

- í•¨ìˆ˜ì˜ ì‹œì‘ì—ì„œ ì´ ë‘ ë ˆì§€ìŠ¤í„°ì˜ ê°’ì„ ìŠ¤íƒì— ì €ì¥(ì´ë”° ì“°ê¸° ìœ„í•´)
- Q(y)ë¥¼ í˜¸ì¶œí•˜ê¸° ì „ì— xì˜ ê°’ì„ %rbpë¡œ ì €ì¥.
- ë‘ ë²ˆì§¸ í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•˜ê¸° ì „ì— %rax ê°’ì„ %rbxë¡œ ì €ì¥
- í•¨ìˆ˜ì˜ ë§‰ë°”ì§€ì—ì„œ ë³µêµ¬.
### ì½”ë©˜íŠ¸

### ì˜ë¬¸ 1. pushq %rbp ëŠ” ë­ê°€ ë“¤ì–´ ìˆì—ˆëŠ”ì§€ëŠ” ëª¨ë¥´ì§€ë§Œ ì•„ë¬´íŠ¼ ë ˆì§€ìŠ¤í„°ê°€ ë‹´ê³  ìˆë˜ ë¡œì»¬ ë°ì´í„°ë¥¼ ì•ˆì „í•˜ê²Œ ë³´ê´€í•˜ê¸° ìœ„í•´ í•˜ëŠ” ê±°ì§€?

ë„¤, ë§ìŠµë‹ˆë‹¤.
pushq %rbpëŠ” í˜„ì¬ %rbpì— ì €ì¥ë˜ì–´ ìˆëŠ” ê°’(ë³´í†µ ì´ì „ í”„ë ˆì„ í¬ì¸í„°, ì¦‰ callerì˜ ì¤‘ìš”í•œ ë°ì´í„°)ì„ ìŠ¤íƒì— ì €ì¥í•˜ì—¬ ë‚˜ì¤‘ì— ë³µì›í•  ìˆ˜ ìˆë„ë¡ í•˜ëŠ” ë™ì‘ì…ë‹ˆë‹¤.
x86-64 í˜¸ì¶œ ê·œì•½ì—ì„œëŠ” %rbpì™€ ê°™ì´ callee-saved(registers)ëŠ” í˜¸ì¶œëœ í•¨ìˆ˜(ì½œë¦¬)ê°€ ì‚¬ìš©í•˜ê¸° ì „ì— ê·¸ ê°’ì„ ë³´ì¡´í•´ì•¼ í•˜ë©°, í•¨ìˆ˜ê°€ ëë‚œ í›„ì—ëŠ” ì›ë˜ ê°’ìœ¼ë¡œ ë³µì›í•´ì•¼ í•©ë‹ˆë‹¤.
ì¦‰, í•¨ìˆ˜ ì‹œì‘ ì‹œì ì— pushq %rbpë¥¼ ì‚¬ìš©í•´ì„œ callerì˜ %rbp ê°’ì„ ì•ˆì „í•˜ê²Œ ìŠ¤íƒì— ì €ì¥í•˜ê³ , ì´í›„ í•¨ìˆ˜ì˜ ìŠ¤íƒ í”„ë ˆì„ì„ ì„¤ì •í•œ ë‹¤ìŒ, í•¨ìˆ˜ ì¢…ë£Œ ì „ì— í•´ë‹¹ ê°’ì„ ë‹¤ì‹œ ë³µì›í•˜ëŠ” ì‹ìœ¼ë¡œ callerì˜ ë°ì´í„°ë¥¼ ë³´í˜¸í•˜ëŠ” ê²ƒì…ë‹ˆë‹¤.

## Practice 3.34

### ë¬¸ì œ

í”„ë¡œì‹œì € Pì— ì§€ì—­ ë³€ìˆ˜ a0~a8ê¹Œì§€ ìˆê³ , GCC ëŠ” ì•„ë˜ ì–´ì…ˆë¸”ë¦¬ì–´ ì½”ë“œë¥¼ ë§Œë“¤ì—ˆë‹¤.

1. ì–´ë–¤ ì§€ì—­ ë³€ìˆ˜ê°€ callee saved registerì— ì €ì¥ëëŠ”ì§€ í™•ì¸
  1. a0~a4
  1. %rdiì— ì €ì¥ëœ xë¥¼ %rbxì— ì €ì¥í›„, callee saved registerì— %rdi+1ë¶€í„° ì°¨ë¡€ë¡œ 5ê°œë¥¼ callee saved registerì— ì €ì¥í•¨.
  1. ì—¬ê¸°ì„œ calleeëŠ” Pì¸ê°€?(ì˜ë¬¸ 1.) ë§ìŒ. ìì„¸í•œ ë‚´ìš©ì€ ì•„ë˜ ë‹µë³€ ì°¸ì¡°.
1. ì–´ë–¤ ì§€ì—­ë³€ìˆ˜ê°€ ìŠ¤íƒì— ì €ì¥ëëŠ”ì§€ í™•ì¸
  1. a5, a6.
  1. %rdiì˜ 6ë²ˆì§¸, 7ë²ˆì§¸ ê°’ì„ ìŠ¤íƒì— ì°¨ë¡€ë¡œ ì €ì¥í–ˆìŒ.
1. ì™œ í”„ë¡œê·¸ë¨ì´ ëª¨ë“  ì§€ì—­ë³€ìˆ˜ë¥¼ callee saved registerì— ì €ì¥í•  ìˆ˜ ì—†ì—ˆë‚˜?
```assembly
long P(long x)
x in %rdi
P:
	pushq %r15
	pushq %r14
	pushq %r13
	pushq %r12
	pushq %rbp
	pushq %rbx
	subq $24, %rsp
	mov %rdi, 
	leaq 1(%rdi), %r15
	leaq 2(%rdi), %r14
	leaq 3(%rdi), %r13
	leaq 4(%rdi), %r12
	leaq 5(%rdi), %rbp
	leaq 6(%rdi), %rax
	movq %rax, (%rsp)
	leaq 7(%rdi), %rdx
	movq %rdx, 8(%rsp)
	movl $0, %eax
	call Q
```

![](./images/IMG_3CFDFB19D012-1.jpeg)

### ì˜ë¬¸: ìœ„ ì‚¬ë¡€ì—ì„œ callee saved registerê°€ ê°€ë¦¬í‚¤ëŠ” calleeëŠ” procedure Pì¸ê°€? PëŠ” ì§€ê¸ˆ Që¥¼ ë¶€ë¥´ëŠ” caller ì…ì¥ì´ ì•„ë‹Œê°€?

Calleeâ€saved registersëŠ” â€œí˜¸ì¶œëœ í•¨ìˆ˜(ì¦‰, callee)ê°€ ìì‹ ì„ ë¶€ë¥¸ í•¨ìˆ˜(caller)ì˜ ë¬¸ë§¥ì„ ë³´ì¡´í•˜ê¸° ìœ„í•´ ë°˜ë“œì‹œ ìœ ì§€í•´ì•¼ í•˜ëŠ” ë ˆì§€ìŠ¤í„°â€ë¥¼ ì˜ë¯¸í•©ë‹ˆë‹¤.

ì—¬ê¸°ì„œ ì¤‘ìš”í•œ ì ì€, í•¨ìˆ˜ PëŠ” ë‘ ê°€ì§€ ì—­í• ì„ ë™ì‹œì— í•©ë‹ˆë‹¤.

1.	PëŠ” calleeì…ë‹ˆë‹¤.

í•¨ìˆ˜ PëŠ” Pë¥¼ í˜¸ì¶œí•œ ì¸¡ì—ê²Œ í˜¸ì¶œ ê·œì•½ì— ë”°ë¼ calleeâ€saved registers(ì˜ˆ, %rbx, %rbp, %r12, %r13, %r14, %r15)ë¥¼ ê·¸ëŒ€ë¡œ ë³´ì¡´í•´ ëŒë ¤ì¤˜ì•¼ í•©ë‹ˆë‹¤. ê·¸ë˜ì„œ Pì˜ í”„ë¡œë¡œê·¸ì—ì„œëŠ” ìì‹ ì˜ callerê°€ ì‚¬ìš©í•˜ë˜ callee-saved ë ˆì§€ìŠ¤í„°ë“¤ì˜ ê°’ì„ ìŠ¤íƒì— í‘¸ì‹œ(push)í•˜ì—¬ ë³´ì¡´í•©ë‹ˆë‹¤.

2.	PëŠ” caller ì—­í• ë„ í•©ë‹ˆë‹¤.

PëŠ” ë‚´ë¶€ì—ì„œ Që¥¼ í˜¸ì¶œí•˜ë¯€ë¡œ, QëŠ” callerë¡œì„œì˜ Pê°€ ë³´ìœ í•œ ë°ì´í„° ì¤‘ caller-saved ë ˆì§€ìŠ¤í„°(ì˜ˆ, %rdi, %rsi, %rdx, %rcx, %r8, %r9 ë“±)ë¥¼ ë®ì–´ì“¸ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ê·¸ëŸ¬ë‚˜ callee-saved ë ˆì§€ìŠ¤í„°ëŠ” Qê°€ í˜¸ì¶œ ê·œì•½ì„ ì§€ì¼œì•¼ í•˜ë¯€ë¡œ Qì— ì˜í•´ ë°”ë€Œì§€ ì•ŠìŠµë‹ˆë‹¤.

ì¦‰, ìœ„ ì–´ì…ˆë¸”ë¦¬ ì½”ë“œì—ì„œ Pê°€

â€¢	ì‹œì‘ ë¶€ë¶„ì— pushq %r15, pushq %r14, pushq %r13, pushq %r12, pushq %rbp, pushq %rbxë¥¼ ìˆ˜í–‰í•˜ëŠ” ê²ƒì€ Pê°€ ìì‹ ì˜ caller(ì¦‰, Pë¥¼ ë¶€ë¥¸ í•¨ìˆ˜)ì˜ callee-saved ë ˆì§€ìŠ¤í„° ê°’ì„ ì•ˆì „í•˜ê²Œ ë³´ì¡´í•˜ê¸° ìœ„í•¨ì…ë‹ˆë‹¤.

â€¢	ì´ê²ƒì€ Pê°€ Që¥¼ í˜¸ì¶œí•˜ê¸° ì „ í›„ì—ë„, Pë¥¼ ë¶€ë¥¸ í•¨ìˆ˜ê°€ ê¸°ëŒ€í•˜ëŠ” ë¬¸ë§¥(ë ˆì§€ìŠ¤í„° ê°’)ì„ ìœ ì§€í•˜ê¸° ìœ„í•œ í‘œì¤€ ì ˆì°¨ì…ë‹ˆë‹¤.

ë”°ë¼ì„œ, ì§ˆë¬¸ì—ì„œ â€œcallee saved registerê°€ ê°€ë¦¬í‚¤ëŠ” calleeëŠ” procedure Pì¸ê°€?â€ë¼ëŠ” ì˜ë¬¸ì€

â€¢	ì˜ˆ, PëŠ” ìì‹ ì˜ callerì—ê²Œ calleeë¡œì„œ ë³´ì¡´í•´ì•¼ í•  ë ˆì§€ìŠ¤í„°ë“¤ì„ ì €ì¥í•©ë‹ˆë‹¤.

â€¢	PëŠ” Që¥¼ í˜¸ì¶œí•˜ëŠ” ì…ì¥(ì¦‰, caller)ì´ì§€ë§Œ, ë™ì‹œì— P ìì‹ ì€ Pë¥¼ í˜¸ì¶œí•œ í•¨ìˆ˜ì—ê²Œ calleeì´ë¯€ë¡œ, callee-saved ë ˆì§€ìŠ¤í„°ë“¤ì„ ë³´í˜¸í•´ì•¼ í•  ì±…ì„ì´ ìˆìŠµë‹ˆë‹¤.

ì •ë¦¬í•˜ë©´, callee-saved ë ˆì§€ìŠ¤í„°ëŠ” í˜¸ì¶œ ê·œì•½ì— ë”°ë¼ Pê°€ ìì‹ ì˜ callerì˜ ë¬¸ë§¥ì„ ë³´ì¡´í•˜ê¸° ìœ„í•´ ì‚¬ìš©í•˜ëŠ” ê²ƒì´ë©°, ì´ëŠ” Pê°€ Që¥¼ í˜¸ì¶œí•œë‹¤ê³  í•´ì„œ ë‹¬ë¼ì§€ëŠ” ê²ƒì´ ì•„ë‹™ë‹ˆë‹¤.

ì¦‰, PëŠ” callerì¸ ë™ì‹œì— ìì‹ ì˜ callerì—ê²ŒëŠ” calleeì¸ í•¨ìˆ˜ì´ë¯€ë¡œ, ìœ„ ì½”ë“œì—ì„œ ë³´ì¡´í•œ ë ˆì§€ìŠ¤í„°ë“¤ì€ Pê°€ calleeë¡œì„œ ë³´ì¡´í•´ì•¼ í•˜ëŠ” ëŒ€ìƒì…ë‹ˆë‹¤.

## ê°œêµ¬ì½” 7. ì¬ê·€ì  í”„ë¡œì‹œì €

### ê°œë…

ì§€ê¸ˆê¹Œì§€ ë³¸ ë ˆì§€ìŠ¤í„°ì™€ ìŠ¤íƒ ì‚¬ìš© ë°©ì‹ ë•ë¶„ì— ì¬ê·€ì ì¸ í”„ë¡œì‹œì € í˜¸ì¶œë„ ê°€ëŠ¥í•¨.

### êµ¬í˜„

```assembly
(a) C code
long rfact(long n)
{
	long result;
	if (n <= 1)
		result = 1;
	else
		result = n * rfact(n-1);
	return result;
}
```

```assembly
(b) Generated assembly code
long rfact(long n)
n in %rdi
rfact: 
	pushq %rbx // save %rbx
	movq %rdi, %rbx // store n in callee saved register
	movl $1, %eax // set return value = 1
	cmpq $1, %rdi // compare n:1
	jle .L35 // if <=, goto done
	leaq -1(%rdi), %rdi // compute n-1
	call rfact // call rfact(n-1) <---- !!!!
	imulq %rbx, %rax // multiply result by n
.L35:  done:
	popq %rbx // restore %rbx
	ret  // return
```

- line2. we can see that the assembly code uses register %rbx to hold the parameter n, after first saving the existing value on the stack
- line11. and later restoring the value before returning
- line 9. due to the stack discipline, and the register saving conventions, we can be assured that when the recursive call to rfact(n-1) returns line 9 that the result of the call will be held in register %rax
- and the value of argument n will held in registser %rbx.
### ì½”ë©˜íŠ¸

íŒ©í† ë¦¬ì–¼ ì–´ì…ˆë¸”ë¦¬ ì½”ë“œë¥¼ ì´í•´í•˜ë©´ í”„ë¡œì‹œì €ì˜ ì¬ê·€ë¥¼ ì œëŒ€ë¡œ ì´í•´í•  ìˆ˜ ìˆê¸´ í•˜ê² ë‹¤. ì´ê±¸ ì–´ë–»ê²Œ ê³µë¶€í•˜ë©´ ì¢‹ì„ê¹Œ? ì¼ë‹¨ ì™¸ìš°ëŠ” ê²ƒìœ¼ë¡œ ìŠ¤íƒ€íŠ¸ë¥¼ ëŠì–´ë³¼ê¹Œ?

(ì‚¬ì§„ ì²¨ë¶€: rfact ì–´ì…ˆë¸”ë¦¬ ì½”ë“œ ì•”ê¸°)

![](./images/cb633880-9168-4580-8232-efdcb3c2c728.png)

## Practice 3.35

### ìœ„ì—ì„œ íŒ©í† ë¦¬ì–¼ ì œëŒ€ë¡œ ì´í•´í–ˆìœ¼ë©´ ì‰¬ì›€

![](./images/IMG_0FA7B34BDB28-1.jpeg)

